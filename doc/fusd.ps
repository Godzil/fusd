%!PS-Adobe-2.0
%%Creator: dvips(k) 5.86 Copyright 1999 Radical Eye Software
%%Title: fusd.dvi
%%Pages: 37
%%PageOrder: Ascend
%%BoundingBox: 0 0 612 792
%%DocumentFonts: Times-Roman Times-Bold Courier Times-Italic
%%+ Times-BoldItalic CMSY10 CMR10
%%EndComments
%DVIPSWebPage: (www.radicaleye.com)
%DVIPSCommandLine: dvips -t Letter -Ppdf -G0 fusd.dvi
%DVIPSParameters: dpi=8000, compressed
%DVIPSSource:  TeX output 2003.08.20:1522
%%BeginProcSet: tex.pro
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/CharBuilder{save 3 1 roll S A/base get 2 index get S
/BitMaps get S get/Cd X pop/ctr 0 N Cdx 0 Cx Cy Ch sub Cx Cw add Cy
setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx sub Cy .1 sub]{Ci}imagemask
restore}B/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: alt-rule.pro
%!
% Patch by TVZ
% Makes dvips files draw rules with stroke rather than fill.
% Makes narrow rules more predictable at low resolutions
% after distilling to PDF.
% May have unknown consequences for very thick rules.
% Tested only with dvips 5.85(k).
TeXDict begin
/QV {
  gsave newpath /ruleY X /ruleX X
  Rx Ry gt
  { ruleX ruleY Ry 2 div sub moveto Rx 0 rlineto Ry }
  { ruleX Rx 2 div add ruleY moveto 0 Ry neg rlineto Rx }
  ifelse
  setlinewidth 0 setlinecap stroke grestore
} bind def
end

%%EndProcSet
%%BeginProcSet: texc.pro
%!
/TeXDict 300 dict def TeXDict begin/N{def}def/B{bind def}N/S{exch}N/X{S
N}B/A{dup}B/TR{translate}N/isls false N/vsize 11 72 mul N/hsize 8.5 72
mul N/landplus90{false}def/@rigin{isls{[0 landplus90{1 -1}{-1 1}ifelse 0
0 0]concat}if 72 Resolution div 72 VResolution div neg scale isls{
landplus90{VResolution 72 div vsize mul 0 exch}{Resolution -72 div hsize
mul 0}ifelse TR}if Resolution VResolution vsize -72 div 1 add mul TR[
matrix currentmatrix{A A round sub abs 0.00001 lt{round}if}forall round
exch round exch]setmatrix}N/@landscape{/isls true N}B/@manualfeed{
statusdict/manualfeed true put}B/@copies{/#copies X}B/FMat[1 0 0 -1 0 0]
N/FBB[0 0 0 0]N/nn 0 N/IEn 0 N/ctr 0 N/df-tail{/nn 8 dict N nn begin
/FontType 3 N/FontMatrix fntrx N/FontBBox FBB N string/base X array
/BitMaps X/BuildChar{CharBuilder}N/Encoding IEn N end A{/foo setfont}2
array copy cvx N load 0 nn put/ctr 0 N[}B/sf 0 N/df{/sf 1 N/fntrx FMat N
df-tail}B/dfs{div/sf X/fntrx[sf 0 0 sf neg 0 0]N df-tail}B/E{pop nn A
definefont setfont}B/Cw{Cd A length 5 sub get}B/Ch{Cd A length 4 sub get
}B/Cx{128 Cd A length 3 sub get sub}B/Cy{Cd A length 2 sub get 127 sub}
B/Cdx{Cd A length 1 sub get}B/Ci{Cd A type/stringtype ne{ctr get/ctr ctr
1 add N}if}B/id 0 N/rw 0 N/rc 0 N/gp 0 N/cp 0 N/G 0 N/CharBuilder{save 3
1 roll S A/base get 2 index get S/BitMaps get S get/Cd X pop/ctr 0 N Cdx
0 Cx Cy Ch sub Cx Cw add Cy setcachedevice Cw Ch true[1 0 0 -1 -.1 Cx
sub Cy .1 sub]/id Ci N/rw Cw 7 add 8 idiv string N/rc 0 N/gp 0 N/cp 0 N{
rc 0 ne{rc 1 sub/rc X rw}{G}ifelse}imagemask restore}B/G{{id gp get/gp
gp 1 add N A 18 mod S 18 idiv pl S get exec}loop}B/adv{cp add/cp X}B
/chg{rw cp id gp 4 index getinterval putinterval A gp add/gp X adv}B/nd{
/cp 0 N rw exit}B/lsh{rw cp 2 copy get A 0 eq{pop 1}{A 255 eq{pop 254}{
A A add 255 and S 1 and or}ifelse}ifelse put 1 adv}B/rsh{rw cp 2 copy
get A 0 eq{pop 128}{A 255 eq{pop 127}{A 2 idiv S 128 and or}ifelse}
ifelse put 1 adv}B/clr{rw cp 2 index string putinterval adv}B/set{rw cp
fillstr 0 4 index getinterval putinterval adv}B/fillstr 18 string 0 1 17
{2 copy 255 put pop}for N/pl[{adv 1 chg}{adv 1 chg nd}{1 add chg}{1 add
chg nd}{adv lsh}{adv lsh nd}{adv rsh}{adv rsh nd}{1 add adv}{/rc X nd}{
1 add set}{1 add clr}{adv 2 chg}{adv 2 chg nd}{pop nd}]A{bind pop}
forall N/D{/cc X A type/stringtype ne{]}if nn/base get cc ctr put nn
/BitMaps get S ctr S sf 1 ne{A A length 1 sub A 2 index S get sf div put
}if put/ctr ctr 1 add N}B/I{cc 1 add D}B/bop{userdict/bop-hook known{
bop-hook}if/SI save N @rigin 0 0 moveto/V matrix currentmatrix A 1 get A
mul exch 0 get A mul add .99 lt{/QV}{/RV}ifelse load def pop pop}N/eop{
SI restore userdict/eop-hook known{eop-hook}if showpage}N/@start{
userdict/start-hook known{start-hook}if pop/VResolution X/Resolution X
1000 div/DVImag X/IEn 256 array N 2 string 0 1 255{IEn S A 360 add 36 4
index cvrs cvn put}for pop 65781.76 div/vsize X 65781.76 div/hsize X}N
/p{show}N/RMat[1 0 0 -1 0 0]N/BDot 260 string N/Rx 0 N/Ry 0 N/V{}B/RV/v{
/Ry X/Rx X V}B statusdict begin/product where{pop false[(Display)(NeXT)
(LaserWriter 16/600)]{A length product length le{A length product exch 0
exch getinterval eq{pop true exit}if}{pop}ifelse}forall}{false}ifelse
end{{gsave TR -.1 .1 TR 1 1 scale Rx Ry false RMat{BDot}imagemask
grestore}}{{gsave TR -.1 .1 TR Rx Ry scale 1 1 false RMat{BDot}
imagemask grestore}}ifelse B/QV{gsave newpath transform round exch round
exch itransform moveto Rx 0 rlineto 0 Ry neg rlineto Rx neg 0 rlineto
fill grestore}B/a{moveto}B/delta 0 N/tail{A/delta X 0 rmoveto}B/M{S p
delta add tail}B/b{S p tail}B/c{-4 M}B/d{-3 M}B/e{-2 M}B/f{-1 M}B/g{0 M}
B/h{1 M}B/i{2 M}B/j{3 M}B/k{4 M}B/w{0 rmoveto}B/l{p -4 w}B/m{p -3 w}B/n{
p -2 w}B/o{p -1 w}B/q{p 1 w}B/r{p 2 w}B/s{p 3 w}B/t{p 4 w}B/x{0 S
rmoveto}B/y{3 2 roll p a}B/bos{/SS save N}B/eos{SS restore}B end

%%EndProcSet
%%BeginProcSet: 8r.enc
% @@psencodingfile@{
%   author = "S. Rahtz, P. MacKay, Alan Jeffrey, B. Horn, K. Berry",
%   version = "0.6",
%   date = "22 June 1996",
%   filename = "8r.enc",
%   email = "kb@@mail.tug.org",
%   address = "135 Center Hill Rd. // Plymouth, MA 02360",
%   codetable = "ISO/ASCII",
%   checksum = "119     662    4424",
%   docstring = "Encoding for TrueType or Type 1 fonts to be used with TeX."
% @}
% 
% Idea is to have all the characters normally included in Type 1 fonts
% available for typesetting. This is effectively the characters in Adobe
% Standard Encoding + ISO Latin 1 + extra characters from Lucida.
% 
% Character code assignments were made as follows:
% 
% (1) the Windows ANSI characters are almost all in their Windows ANSI
% positions, because some Windows users cannot easily reencode the
% fonts, and it makes no difference on other systems. The only Windows
% ANSI characters not available are those that make no sense for
% typesetting -- rubout (127 decimal), nobreakspace (160), softhyphen
% (173). quotesingle and grave are moved just because it's such an
% irritation not having them in TeX positions.
% 
% (2) Remaining characters are assigned arbitrarily to the lower part
% of the range, avoiding 0, 10 and 13 in case we meet dumb software.
% 
% (3) Y&Y Lucida Bright includes some extra text characters; in the
% hopes that other PostScript fonts, perhaps created for public
% consumption, will include them, they are included starting at 0x12.
% 
% (4) Remaining positions left undefined are for use in (hopefully)
% upward-compatible revisions, if someday more characters are generally
% available.
% 
% (5) hyphen appears twice for compatibility with both ASCII and Windows.
% 
/TeXBase1Encoding [
% 0x00 (encoded characters from Adobe Standard not in Windows 3.1)
  /.notdef /dotaccent /fi /fl
  /fraction /hungarumlaut /Lslash /lslash
  /ogonek /ring /.notdef
  /breve /minus /.notdef 
% These are the only two remaining unencoded characters, so may as
% well include them.
  /Zcaron /zcaron 
% 0x10
 /caron /dotlessi 
% (unusual TeX characters available in, e.g., Lucida Bright)
 /dotlessj /ff /ffi /ffl 
 /.notdef /.notdef /.notdef /.notdef
 /.notdef /.notdef /.notdef /.notdef
 % very contentious; it's so painful not having quoteleft and quoteright
 % at 96 and 145 that we move the things normally found there down to here.
 /grave /quotesingle 
% 0x20 (ASCII begins)
 /space /exclam /quotedbl /numbersign
 /dollar /percent /ampersand /quoteright
 /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
% 0x30
 /zero /one /two /three /four /five /six /seven
 /eight /nine /colon /semicolon /less /equal /greater /question
% 0x40
 /at /A /B /C /D /E /F /G /H /I /J /K /L /M /N /O
% 0x50
 /P /Q /R /S /T /U /V /W
 /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
% 0x60
 /quoteleft /a /b /c /d /e /f /g /h /i /j /k /l /m /n /o
% 0x70
 /p /q /r /s /t /u /v /w
 /x /y /z /braceleft /bar /braceright /asciitilde
 /.notdef % rubout; ASCII ends
% 0x80
 /.notdef /.notdef /quotesinglbase /florin
 /quotedblbase /ellipsis /dagger /daggerdbl
 /circumflex /perthousand /Scaron /guilsinglleft
 /OE /.notdef /.notdef /.notdef
% 0x90
 /.notdef /.notdef /.notdef /quotedblleft
 /quotedblright /bullet /endash /emdash
 /tilde /trademark /scaron /guilsinglright
 /oe /.notdef /.notdef /Ydieresis
% 0xA0
 /.notdef % nobreakspace
 /exclamdown /cent /sterling
 /currency /yen /brokenbar /section
 /dieresis /copyright /ordfeminine /guillemotleft
 /logicalnot
 /hyphen % Y&Y (also at 45); Windows' softhyphen
 /registered
 /macron
% 0xD0
 /degree /plusminus /twosuperior /threesuperior
 /acute /mu /paragraph /periodcentered
 /cedilla /onesuperior /ordmasculine /guillemotright
 /onequarter /onehalf /threequarters /questiondown
% 0xC0
 /Agrave /Aacute /Acircumflex /Atilde /Adieresis /Aring /AE /Ccedilla
 /Egrave /Eacute /Ecircumflex /Edieresis
 /Igrave /Iacute /Icircumflex /Idieresis
% 0xD0
 /Eth /Ntilde /Ograve /Oacute
 /Ocircumflex /Otilde /Odieresis /multiply
 /Oslash /Ugrave /Uacute /Ucircumflex
 /Udieresis /Yacute /Thorn /germandbls
% 0xE0
 /agrave /aacute /acircumflex /atilde
 /adieresis /aring /ae /ccedilla
 /egrave /eacute /ecircumflex /edieresis
 /igrave /iacute /icircumflex /idieresis
% 0xF0
 /eth /ntilde /ograve /oacute
 /ocircumflex /otilde /odieresis /divide
 /oslash /ugrave /uacute /ucircumflex
 /udieresis /yacute /thorn /ydieresis
] def

%%EndProcSet
%%BeginProcSet: texps.pro
%!
TeXDict begin/rf{findfont dup length 1 add dict begin{1 index/FID ne 2
index/UniqueID ne and{def}{pop pop}ifelse}forall[1 index 0 6 -1 roll
exec 0 exch 5 -1 roll VResolution Resolution div mul neg 0 0]/Metrics
exch def dict begin Encoding{exch dup type/integertype ne{pop pop 1 sub
dup 0 le{pop}{[}ifelse}{FontMatrix 0 get div Metrics 0 get div def}
ifelse}forall Metrics/Metrics currentdict end def[2 index currentdict
end definefont 3 -1 roll makefont/setfont cvx]cvx def}def/ObliqueSlant{
dup sin S cos div neg}B/SlantFont{4 index mul add}def/ExtendFont{3 -1
roll mul exch}def/ReEncodeFont{CharStrings rcheck{/Encoding false def
dup[exch{dup CharStrings exch known not{pop/.notdef/Encoding true def}
if}forall Encoding{]exch pop}{cleartomark}ifelse}if/Encoding exch def}
def end

%%EndProcSet
%%BeginFont: CMR10
%!PS-AdobeFont-1.1: CMR10 1.00B
%%CreationDate: 1992 Feb 19 19:54:52

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.00B) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMR10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle 0 def
/isFixedPitch false def
end readonly def
/FontName /CMR10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 48 /zero put
readonly def
/FontBBox{-251 -250 1009 969}readonly def
/UniqueXX 5000793 def
currentdict end
currentfile eexec
8053514d28ec28da1630165fab262882d3fca78881823c5537fe6c3dda8ee5b8
97e17cb027f5c73fdbb56b0a7c25fc3512b55fe8f3acfbffcc7f4a382d8299cc
8fd37d3cea49dabdca92847af0560b404ef71134b0f3d99934fc9d0b4e602011
b9cfb856c23f958f3c5a2fbe0ef8587d1f5774879c324e51fcb22888b74f2415
50d7401eb990d4f3a7af635198422283cac1b6cd446ddbcbd915db9bff88844e
784c6bf7389803d9450b0c21756a017306457c7e62c1d269f306bd3402e266de
fc3b5e7d8a8d2f5bf0fe6ddd40d07391df4fad4a6018dce29a2b8f692b29f202
3a7c0e66de8ed85c14f1f8492167357f51a7e84cc5d92e0fee4d81cf7fbc8de5
2d2e7bb57142033993f9c08c315abade8dbc4a732e84e142d3bee51557910e12
cd8aa37c459a5e6b7f5269f59078aba3be4641a11ac48d0b625c8325b38ec08e
4c9e5e7fed976a5650d99d82114f449b9ca14c4ec957702295a39a93ef93f618
99b8ea06b092c3c1e503e6e436e0a9fa22576c8930ab3dc8c20f5d82b69cddf8
ff4dacfa9c54bed5a3aa3ea5b129fe96be632843b9b6bc91b615581a985db56b
1e01ca60ee69ca92cf5c0882ece62edad3e106d835348822400f0b66af658f2a
e56ed08f8b0010571807009b73ab12a8cf14ca6c71f03c2a48c500f9d62266af
154a6375ff600d9bac3f05ce34142d6867a79581c533176bb2f3117336671e2e
44638a97167e2ea9644e31ea16c2ad2990ea33c54001e0c8156e6de8ab6a4d40
a7137ba275f39589fea2e2db8256adc103d6f9cc038037a47e8fd469c5f98a5e
3c15bd4ace40d340018b1cff7d1ed8abb0ac57b5b5a2c20a51957b96c453edb7
dae5affd91a46d938fe0a13363001d844ded4323f1ee6d30012aea19b024a552
315505535c85dc26bad31e09c50e6512802976d298c4e90d0044c362e6bf3ab3
62a454ee93de25ce54411090c29e9d75c80ce26a84404bd9de3aee0e3f921ac5
87f907572b8354a5c3165eea7e8b2ba4e4f834663063e9a307d8ff6f8b61acd8
799bc105cddcf8f95f2160494fc01f7ec3effb95de571b8d7f27a2f9ad203c09
cd4cffd98a119a507460e7fef5c910405e877aa1f8da68d1272e59e3adccef8d
82e692b3229926fbe621080b7831a2ee248948dd3ae55082a939f02875a7a0eb
7ae7d50270a576fbdfde7109c670f51be75b80b6fe3045ea50e2121024113974
87d0093bc5c693c16b533a75364f7b986776dff23b9da648311e5807207d19ec
ab067d8c2460245f75a171f077c74a36ecc1c8a5e4961a5cdf0ebdae91ff41c9
32567a47d5b8d27de4e889c27bcbafaaf9c8435f714e81553aab7378dc00a75b
610a34abcd06629ca15ade968ca0212e83afd16c2b285dac82ae1598fe7fca29
3f2dbcb1ae9f13b16b7f7f116f491e898c05318fb243a1500d10bed3fc1ab9e2
baaf89605bb4dae9507bdf2ced113151c8e78d0dd50dedffc8c3d82ed2eda703
abc76d12fcd229a2072b8ff27d4b2254b2634ac81b6855757f47f95ea5f83532
bd9ac8ae5fdd362dd687ec8469f57104aa0f52562719d8981502ad5de237ba75
e61af35a6910efe2f726a06e7b8369739557675e4c4e5f6446b2ad1af93bd766
c55d1db54c4ca76a850931e9abecbd3d52afd914c7bfc54d826a18df179585
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
%%BeginFont: CMSY10
%!PS-AdobeFont-1.1: CMSY10 1.0
%%CreationDate: 1991 Aug 15 07:20:57

% Copyright (C) 1997 American Mathematical Society.  All Rights Reserved.

11 dict begin
/FontInfo 7 dict dup begin
/version (1.0) readonly def
/Notice (Copyright (C) 1997 American Mathematical Society. All Rights Reserved) readonly def
/FullName (CMSY10) readonly def
/FamilyName (Computer Modern) readonly def
/Weight (Medium) readonly def
/ItalicAngle -14.035 def
/isFixedPitch false def
end readonly def
/FontName /CMSY10 def
/PaintType 0 def
/FontType 1 def
/FontMatrix [0.001 0 0 0.001 0 0] readonly def
/Encoding 256 array
0 1 255 {1 index exch /.notdef put} for
dup 15 /bullet put
dup 21 /greaterequal put
readonly def
/FontBBox{-29 -960 1116 775}readonly def
/UniqueXX 5000820 def
currentdict end
currentfile eexec
9b9c1569015f2c1d2bf560f4c0d52257bac8ced9b09a275ab231194ecf829352
05826f4e975dcecec72b2cf3a18899ccde1fd935d09d813b096cc6b83cdf4f23
b9a60db41f9976ac333263c908dcefcdbd4c8402ed00a36e7487634d089fd45a
f4a38a56a4412c3b0baffaeb717bf0de9ffb7a8460bf475a6718b0c73c571145
d026957276530530a2fbefc6c8f67052788e6703bb5ee49533870bca1f113ad8
3750d597b842d8d96c423ba1273ddd32f3a54a912a443fcd44f7c3a6fe3956b0
aa1e784aaec6fce08dae0c76da9d0a3eba57b98a6233d9e9f0c3f00fcc6b2c6a
9ba23af389e6dfff4efec3de05d6276c6be417703ce508377f25960ef4ed83b4
9b01b873f3a639ce00f356229b6477a081933fef3bb80e2b9dffa7f75567b1fa
4d739b772f8d674e567534c6c5bbf1cf615372be20b18472f7aa58be8c216dbd
df81cc0a86b6d8318ca68fe22c8af13b54d7576fe4ca5a7af9005ea5cc4edb79
c0ab668e4fec4b7f5a9eb5f0e4c088cd818ecc4feb4b40ec8bd2981bf2336074
b64c430035b7d4eb41c5714c319ae0c7f0df32ef5dcc37f92a96507d4eb9a5e5
045913170d906e35107dafacb7af82cb8718807702f76fa29878a317eef3f7f4
8284e3a42c2a9ed9c541585f0d34249ea150fce9634deee9ad9b375a1448ab5f
04003aa5a88ae2e668c7807a0c9b7cc3746b783c0602a00361065126129730a4
37c956a141a9455d4f353c8625c6bca2e508842eac84693ae8ba20053b3dec54
7dadeecfb4913d243e65276c93bc007486705e24db3f8bbc554cc917e8b02ade
fc9e37d370619b5d3417e0f32b594f763a21110da781e561bf3cef88359e333b
493aaee20dfbbc6578c9b5ccd6cc24a5f992163ef8d85cc0755ff585c4baf230
f063f036334661b3d10f73892f03060ed6a326472ef7659a8484dd8b316b6f68
c1cf51b0cc356445a32714be670c950b7f947f9ccf84ada2ad79c32c0fda086c
5328f8657d85da23df5bbeed5c0208bb940555acca206ae65a49ff540ea7b941
8ff4c52cf2353ccfebd2657bc461d108b9
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000
cleartomark

%%EndFont 
TeXDict begin 40258431 52099146 1000 8000 8000 (fusd.dvi)
@start /Fa 138[956 956 956 956 1[956 956 956 1[956 2[956
956 1[956 956 956 956 1[956 55[956 956 40[{
TeXBase1Encoding ReEncodeFont}17 1594.02 /Courier rf
/Fb 207[553 48[{}1 1106.96 /CMR10 rf /Fc 136[797 797
797 797 797 797 1[797 797 797 1[797 2[797 797 797 797
797 797 797 1[797 7[797 3[797 1[797 797 1[797 797 797
1[797 5[797 797 797 21[797 797 3[797 797 40[{
TeXBase1Encoding ReEncodeFont}33 1328.35 /Courier rf
/Fd 133[393 443 443 639 443 443 246 344 295 1[443 443
443 689 246 443 246 246 443 443 295 393 443 393 443 393
38[246 443 1[443 443 443 1[443 1[443 443 246 221 295
45[{TeXBase1Encoding ReEncodeFont}36 885.568 /Times-Roman
rf /Fe 198[332 332 332 332 332 332 332 332 332 332 48[{
TeXBase1Encoding ReEncodeFont}10 664.176 /Times-Roman
rf /Ff 198[387 387 387 387 387 387 387 387 387 387 48[{
TeXBase1Encoding ReEncodeFont}10 774.872 /Times-Roman
rf /Fg 234[861 5[553 15[{}2 1106.96 /CMSY10 rf /Fh 139[369
517 4[739 36[517 33[442 39[{TeXBase1Encoding ReEncodeFont}5
1328.35 /Times-BoldItalic rf /Fi 202[498 498 498 498
498 498 48[{TeXBase1Encoding ReEncodeFont}6 996.264 /Times-Roman
rf /Fj 134[664 664 959 664 739 442 517 590 739 739 664
739 1107 369 739 1[369 739 664 442 590 739 590 739 664
9[1328 1[959 886 739 959 1[812 2[1254 886 1033 1[517
1033 1033 812 886 959 959 886 959 1[664 3[442 1[664 664
664 664 664 664 664 664 664 2[332 442 332 4[442 36[739
2[{TeXBase1Encoding ReEncodeFont}58 1328.35 /Times-Bold
rf /Fk 134[491 491 738 491 553 308 431 431 1[553 553
553 799 308 491 1[308 553 553 308 491 553 491 553 553
14[676 8[369 799 25[277 369 277 4[369 36[553 2[{
TeXBase1Encoding ReEncodeFont}31 1106.96 /Times-Italic
rf /Fl 105[553 28[553 553 1[553 615 369 431 491 1[615
553 615 922 308 615 1[308 615 553 369 491 615 491 615
553 7[799 1[1107 1[799 1[615 2[676 1[799 1[738 861 1[431
2[676 1[799 799 738 799 1[553 4[369 553 553 553 553 553
553 553 553 553 553 1[277 369 277 4[369 39[{
TeXBase1Encoding ReEncodeFont}53 1106.96 /Times-Bold
rf /Fm 134[797 797 1[797 886 531 620 708 1[886 797 886
1328 443 886 1[443 886 797 531 708 886 708 886 797 7[1151
1[1594 1[1151 1[886 2[974 1[1151 1[1063 2[620 2[974 1063
1151 1151 1063 1151 1[797 5[797 797 797 797 797 797 797
797 797 797 2[531 45[{TeXBase1Encoding ReEncodeFont}48
1594.02 /Times-Bold rf /Fn 104[1107 553 1[491 491 24[491
553 553 799 553 553 308 431 369 553 553 553 553 861 308
553 308 308 553 553 369 491 553 491 553 491 3[369 1[369
1[799 799 1045 799 799 676 615 738 799 615 799 799 984
676 799 431 369 799 799 615 676 799 738 738 799 1020
491 3[308 308 553 553 553 553 553 553 553 553 553 553
308 277 369 277 2[369 369 369 5[369 29[615 615 2[{
TeXBase1Encoding ReEncodeFont}81 1106.96 /Times-Roman
rf /Fo 103[664 26[664 664 664 664 664 664 664 664 664
664 664 664 664 664 664 664 664 664 664 664 664 664 664
664 664 664 664 664 664 1[664 1[664 664 664 664 664 664
664 664 664 664 664 664 1[664 664 664 664 664 664 1[664
664 664 664 664 664 664 664 664 664 664 664 664 664 664
664 1[664 664 664 664 664 664 664 664 664 664 664 664
664 664 664 664 664 664 664 664 1[664 664 664 33[{
TeXBase1Encoding ReEncodeFont}88 1106.96 /Courier rf
/Fp 134[664 5[517 442 2[664 664 1033 369 6[590 26[517
4[812 69[{TeXBase1Encoding ReEncodeFont}10 1328.35 /Times-Roman
rf /Fq 170[1658 1[1276 12[1403 1[1658 68[{TeXBase1Encoding ReEncodeFont}
4 2295.84 /Times-Bold rf /Fr 135[1148 1658 1148 1148
1[893 765 1[1148 1148 1148 1786 1[1148 1[638 2[765 1019
1[1019 1[1019 20[1403 10[1658 19[765 45[{TeXBase1Encoding ReEncodeFont}
19 2295.84 /Times-Roman rf /Fs 170[1988 1[1531 12[1531
1[1988 9[766 58[{TeXBase1Encoding ReEncodeFont}5 2754.12
/Times-Roman rf end
%%EndProlog
%%BeginSetup
%%Feature: *Resolution 8000dpi
TeXDict begin
%%BeginPaperSize: Letter
letter
%%EndPaperSize

%%EndSetup
%%Page: 1 1
1 0 bop 22056 20963 a Fs(FUSD:)5362 25351 y Fr(A)574
b(Linux)g Fq(F)p Fr(rame)-57 b(w)-23 b(ork)572 b(for)h
Fq(U)p Fr(ser)-46 b(-)p Fq(S)p Fr(pace)575 b Fq(D)p Fr(e)-57
b(vices)22361 59554 y Fp(Jeremy)332 b(Elson)19316 62985
y Fo(jelson@circlemud.org)11014 64314 y
(http://www.circlemud.org/jelson/software/fusd)22422
68299 y Fn(19)278 b(August)f(2003)19102 69627 y(Documentation)j(for)c
(FUSD)i(1.10)p eop
%%Page: 1 2
1 1 bop 863 2974 a Fm(Contents)863 5448 y Fl(1)1108 b(Intr)-20
b(oduction)41971 b(1)2524 6776 y Fn(1.1)1163 b(What)277
b(is)f(FUSD?)685 b(.)553 b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761
b(1)2524 8105 y(1.2)1163 b(Ho)-28 b(w)278 b(does)f(FUSD)h(w)-11
b(ork?)448 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(1)2524 9433
y(1.3)1163 b(What)277 b(FUSD)h Fk(Isn')-33 b(t)746 b
Fn(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(3)2524 10761
y(1.4)1163 b(Related)278 b(W)-89 b(ork)774 b(.)553 b(.)g(.)g(.)g(.)h(.)
f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1761 b(3)2524 12090 y(1.5)1163 b(Limitations)277
b(and)h(Future)g(W)-89 b(ork)649 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(4)2524
13418 y(1.6)1163 b(Author)277 b(Contact)i(Information)e(and)i(Ackno)-28
b(wledgments)625 b(.)553 b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761
b(5)2524 14746 y(1.7)1163 b(Licensing)278 b(Information)1085
b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)1761 b(5)863 17182 y Fl(2)1108
b(Wh)-17 b(y)278 b(use)f(FUSD?)40184 b(5)2524 18510 y
Fn(2.1)1163 b(De)-28 b(vice)279 b(Dri)-28 b(v)-17 b(er)277
b(Layering)515 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)
g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(6)2524
19838 y(2.2)1163 b(Use)277 b(of)f(User)-22 b(-Space)279
b(Libraries)955 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(6)2524 21167 y(2.3)1163
b(Dri)-28 b(v)-17 b(er)277 b(Memory)h(Protection)915
b(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1761 b(6)2524 22495 y(2.4)1163 b(Gi)-28
b(ving)278 b(libraries)e(language)k(independence)i(and)c(standard)g
(noti\002cation)h(interf)-11 b(aces)882 b(.)554 b(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)1761 b(7)2524 23823 y(2.5)1163
b(De)-28 b(v)-17 b(elopment)280 b(and)f(Deb)-22 b(ugging)279
b(Con)-44 b(v)-17 b(enience)357 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1761 b(7)863 26259 y Fl(3)1108 b(Installing)276
b(FUSD)40320 b(7)2524 27587 y Fn(3.1)1163 b(Prerequisites)314
b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761
b(7)2524 28915 y(3.2)1163 b(Compiling)278 b(FUSD)g(as)f(a)g(K)-28
b(ernel)278 b(Module)866 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1761 b(7)2524 30244 y(3.3)1163 b(T)-77
b(esting)277 b(and)h(T)-39 b(roubleshooting)833 b(.)553
b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)1761 b(8)2524 31572 y(3.4)1163 b(Installation)1051
b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761
b(8)2524 32901 y(3.5)1163 b(Making)278 b(FUSD)g(P)-17
b(art)278 b(of)e(the)i(K)-28 b(ernel)278 b(Proper)576
b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761
b(8)863 35336 y Fl(4)1108 b(Basic)277 b(De)-17 b(vice)279
b(Cr)-20 b(eation)37624 b(9)2524 36664 y Fn(4.1)1163
b(Using)277 b Fo(fusd)p 10713 36664 333 45 v 399 w(register)h
Fn(to)f(create)h(a)f(ne)-28 b(w)279 b(de)-28 b(vice)462
b(.)553 b(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1761 b(9)2524
37993 y(4.2)1163 b(The)278 b Fo(open)f Fn(and)h Fo(close)g
Fn(callbacks)644 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)
f(.)g(.)g(.)g(.)h(.)1207 b(10)2524 39321 y(4.3)1163 b(The)278
b Fo(read)f Fn(callback)736 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)
f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(11)2524 40649 y(4.4)1163 b(The)278 b Fo(write)f Fn(callback)902
b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(11)2524 41978 y(4.5)1163
b(Unre)-17 b(gistering)278 b(a)f(de)-28 b(vice)279 b(with)e
Fo(fusd)p 20290 41978 V 399 w(unregister\(\))776 b Fn(.)553
b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)1207 b(13)863 44413 y Fl(5)1108
b(Using)277 b(Inf)-28 b(ormation)278 b(in)f Fo(fusd)p
15458 44413 V 400 w(file)p 18514 44413 V 399 w(info)28443
b Fl(14)2524 45741 y Fn(5.1)1163 b(Re)-17 b(gistration)278
b(of)e(Multiple)i(De)-28 b(vices,)278 b(and)g(P)-17 b(assing)278
b(Data)g(to)f(Callbacks)839 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(14)2524 47070
y(5.2)1163 b(The)278 b(dif)-28 b(ference)278 b(between)h
Fo(device)p 19818 47070 V 400 w(info)e Fn(and)h Fo(private)p
29674 47070 V 400 w(data)854 b Fn(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(17)863
49505 y Fl(6)1108 b(Writing)277 b Fo(ioctl)g Fl(Callbacks)35124
b(19)2524 50833 y Fn(6.1)1163 b(Using)277 b(macros)g(to)g(generate)i
Fo(ioctl)f Fn(command)i(numbers)687 b(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(19)2524 52162 y(6.2)1163 b(Example)279 b(client)e(calls)g(and)h(dri)
-28 b(v)-17 b(er)278 b(callbacks)363 b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)1207 b(20)863 54597 y Fl(7)1108
b(Integrating)278 b(FUSD)g(W)-20 b(ith)277 b(Y)-123 b(our)278
b(A)-28 b(pplication)279 b(Using)e Fo(fusd)p 28076 54597
V 400 w(dispatch\(\))14896 b Fl(20)2524 55925 y Fn(7.1)1163
b(Using)277 b Fo(fusd)p 10713 55925 V 399 w(dispatch\(\))888
b Fn(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)1207 b(21)2524 57254 y(7.2)1163 b(Helper)277
b(Functions)i(for)d(Constructing)j(an)e Fo(fd)p 23281
57254 V 399 w(set)440 b Fn(.)553 b(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)
1207 b(21)863 59689 y Fl(8)1108 b(Implementing)278 b(Blocking)h(System)
e(Calls)29987 b(23)2524 61017 y Fn(8.1)1163 b(Blocking)279
b(the)e(caller)g(by)h(blocking)h(the)e(dri)-28 b(v)-17
b(er)854 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(24)2524 62346 y(8.2)1163 b(Blocking)279 b(the)e(caller)g(using)h
Fo(-FUSD)p 19832 62346 V 399 w(NOREPLY)p Fn(;)g(unblocking)i(it)c
(using)h Fo(fusd)p 36946 62346 V 400 w(return\(\))888
b Fn(.)554 b(.)f(.)g(.)g(.)g(.)h(.)1207 b(24)5070 63674
y(8.2.1)1329 b(K)-28 b(eeping)279 b(Per)-22 b(-Client)278
b(State)605 b(.)553 b(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1207 b(25)5070 65002 y(8.2.2)1329 b(Blocking)279
b(and)f(completing)h(reads)309 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)1207 b(26)5070 66331 y(8.2.3)1329
b(Using)277 b Fo(fusd)p 14255 66331 V 399 w(destroy\(\))i
Fn(to)e(clean)h(up)g(client)f(state)285 b(.)554 b(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(28)2524 67659 y(8.3)1163 b(Retrie)-28 b(ving)278 b(a)f(block)-11
b(ed)280 b(system)d(call')-61 b(s)276 b(ar)-20 b(guments)278
b(from)f(a)g Fo(fusd)p 31283 67659 V 399 w(file)p 34338
67659 V 400 w(info)g Fn(pointer)1080 b(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g
(.)h(.)1207 b(28)25804 74071 y(i)p eop
%%Page: 2 3
2 2 bop 863 2974 a Fl(9)1108 b(Implementing)278 b Fo(select)p
Fl(able)h(De)-17 b(vices)30727 b(30)2524 4302 y Fn(9.1)1163
b(Poll)277 b(state)f(and)j(the)e Fo(poll)p 15663 4302
333 45 v 399 w(diff)h Fn(callback)939 b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)1207 b(30)2524 5631 y(9.2)1163
b(Recei)-28 b(ving)279 b(a)f Fo(poll)p 13298 5631 V 399
w(diff)f Fn(request)h(when)g(the)g(pre)-28 b(vious)278
b(one)g(has)g(not)f(been)i(returned)f(yet)414 b(.)553
b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(31)2524 6959 y(9.3)1163
b(Adding)278 b Fo(select)g Fn(support)g(to)f Fo(pager.c)412
b Fn(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)
h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(31)863 9394 y Fl(10)555 b(P)-22 b(erf)-28 b(ormance)280
b(of)d(User)-41 b(-Space)280 b(De)-17 b(vices)30718 b(33)863
11830 y(11)555 b(FUSD)278 b(Implementation)g(Notes)33772
b(33)2524 13158 y Fn(11.1)610 b(The)278 b(situation)f(with)g
Fo(poll)p 16125 13158 V 399 w(diff)290 b Fn(.)554 b(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)
g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(33)2524 14486 y(11.2)610 b(Restartable)277 b(System)h(Calls)775
b(.)553 b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)
f(.)g(.)g(.)g(.)h(.)1207 b(34)863 16922 y Fl(A)862 b(Using)277
b Fo(strace)40455 b Fl(34)863 21986 y Fm(List)399 b(of)f(Example)h(Pr)
-29 b(ograms)2524 24460 y Fn(1)1993 b(hello)-28 b(w)-11
b(orld.c:)344 b(A)277 b(simple)g(program)h(using)g(FUSD)g(to)f(create)h
Fo(/dev/hello-world)949 b Fn(.)553 b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)
1761 b(2)2524 25788 y(2)1993 b(echo.c:)345 b(Using)277
b(both)h Fo(read)f Fn(and)h Fo(write)g Fn(callbacks)608
b(.)553 b(.)h(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h
(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(13)2524
27117 y(3)1993 b(uid-\002lter)-61 b(.c:)343 b(Inspecting)278
b(data)g(in)f Fo(fusd)p 21171 27117 V 399 w(file)p 24226
27117 V 400 w(info)g Fn(such)h(as)f(UID)g(and)h(PID)f(of)g(the)g
(calling)h(process)1017 b(.)554 b(.)1207 b(15)2524 28445
y(4)1993 b(drums.c:)343 b(P)-17 b(assing)278 b(pri)-28
b(v)g(ate)278 b(data)g(to)f Fo(fusd)p 22175 28445 V 399
w(register)i Fn(and)f(retrie)-28 b(ving)278 b(it)e(from)h
Fo(device)p 41898 28445 V 399 w(info)1084 b Fn(.)553
b(.)g(.)h(.)1207 b(16)2524 29773 y(5)1993 b(drums2.c:)344
b(Using)277 b(both)h Fo(device)p 19026 29773 V 399 w(info)g
Fn(and)g Fo(private)p 28882 29773 V 400 w(data)816 b
Fn(.)553 b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)1207 b(18)2524 31102 y(6)1993 b(ioctl.h:)343
b(Using)277 b(the)p 13136 31102 V 676 w Fo(IO)g Fn(macros)h(to)f
(generate)i Fo(ioctl)e Fn(command)j(numbers)1077 b(.)553
b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(20)2524 32430 y(7)1993 b(ioctl-client.c:)343 b(A)277
b(program)h(that)f(mak)-11 b(es)278 b Fo(ioctl)g Fn(requests)f(on)h(a)f
(\002le)g(descriptor)479 b(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)1207 b(21)2524 33758 y(8)1993 b(ioctl-serv)-17
b(er)-61 b(.c:)343 b(A)277 b(dri)-28 b(v)-17 b(er)278
b(that)f(handles)i Fo(ioctl)e Fn(requests)313 b(.)553
b(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(22)2524 35087 y(9)1993
b(drums3.c:)344 b(W)-89 b(aiting)277 b(for)g(both)h(FUSD)g(and)g
(non-FUSD)h(e)-28 b(v)-17 b(ents)279 b(in)e(a)g Fo(select)h
Fn(loop)640 b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(23)2524 36415 y(10)1440 b(console-read.c:)345 b(A)277
b(simple)g(blocking)i(system)e(call)496 b(.)553 b(.)g(.)h(.)f(.)g(.)g
(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)
g(.)g(.)g(.)h(.)1207 b(24)2524 37743 y(11)1440 b(pager)-61
b(.c)278 b(\(P)-17 b(art)277 b(1\):)343 b(Creating)278
b(state)f(for)f(e)-28 b(v)-17 b(ery)280 b(client)d(using)g(the)h(dri)
-28 b(v)-17 b(er)728 b(.)553 b(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g
(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207 b(26)2524 39072 y(12)1440
b(pager)-61 b(.c)278 b(\(P)-17 b(art)277 b(2\):)343 b(Block)278
b(clients')f Fo(read)g Fn(requests,)g(and)i(later)d(completing)j(the)f
(block)-11 b(ed)279 b(reads)300 b(.)554 b(.)f(.)g(.)g(.)g(.)h(.)1207
b(27)2524 40400 y(13)1440 b(pager)-61 b(.c)278 b(\(P)-17
b(art)277 b(3\):)343 b(Cleaning)279 b(up)f(when)g(a)g(client)f(lea)-22
b(v)-17 b(es)646 b(.)554 b(.)f(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g
(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(29)2524 41729 y(14)1440 b(pager)-61 b(.c)278 b(\(P)-17
b(art)277 b(4\):)343 b(Supporting)279 b Fo(select\(2\))g
Fn(by)e(implementing)i(a)f Fo(poll)p 35250 41729 V 399
w(diff)f Fn(callback)448 b(.)553 b(.)h(.)f(.)g(.)g(.)g(.)h(.)1207
b(32)25650 74071 y(ii)p eop
%%Page: 1 4
1 3 bop 863 2974 a Fm(1)1594 b(Intr)-29 b(oduction)863
6333 y Fj(1.1)1329 b(What)332 b(is)h(FUSD?)863 9073 y
Fn(FUSD)441 b(\(pronounced)i Fk(fused)p Fn(\))c(is)g(a)h(Linux)h(frame)
-28 b(w)-11 b(ork)440 b(for)f(proxying)j(de)-28 b(vice)442
b(\002le)e(callbacks)h(into)f(user)-22 b(-space,)481
b(allo)-28 b(wing)863 10402 y(de)g(vice)394 b(\002les)e(to)f(be)h
(implemented)i(by)f(daemons)g(instead)f(of)g(k)-11 b(ernel)392
b(code.)689 b(Despite)392 b(being)h(implemented)h(in)d(user)-22
b(-space,)863 11730 y(FUSD)278 b(de)-28 b(vices)279 b(can)f(look)g(and)
g(act)g(just)e(lik)-11 b(e)277 b(an)-17 b(y)279 b(other)e(\002le)h
(under)g(/de)-28 b(v)278 b(which)g(is)e(implemented)k(by)d(k)-11
b(ernel)278 b(callbacks.)2524 13722 y(A)269 b(user)-22
b(-space)271 b(de)-28 b(vice)271 b(dri)-28 b(v)-17 b(er)271
b(can)g(do)f(man)-17 b(y)271 b(of)f(the)g(things)g(that)f(k)-11
b(ernel)271 b(dri)-28 b(v)-17 b(ers)270 b(can')-20 b(t,)271
b(such)g(as)e(perform)h(a)g(long-running)863 15051 y(computation,)367
b(block)348 b(while)f(w)-11 b(aiting)347 b(for)f(an)i(e)-28
b(v)-17 b(ent,)366 b(or)346 b(read)i(\002les)e(from)h(the)g(\002le)g
(system.)552 b(Unlik)-11 b(e)348 b(k)-11 b(ernel)347
b(dri)-28 b(v)-17 b(ers,)365 b(a)347 b(user)-22 b(-)863
16379 y(space)316 b(de)-28 b(vice)316 b(dri)-28 b(v)-17
b(er)315 b(can)h Fk(use)e(other)h(de)-17 b(vice)317 b(driver)-11
b(s)p Fn(\227that)314 b(is,)322 b(access)315 b(the)g(netw)-11
b(ork,)324 b(talk)315 b(to)f(a)h(serial)e(port,)323 b(get)315
b(interacti)-28 b(v)-17 b(e)863 17707 y(input)308 b(from)e(the)h(user)
-44 b(,)314 b(pop)308 b(up)f(GUI)g(windo)-28 b(ws,)315
b(or)306 b(read)i(from)e(disks.)432 b(User)-22 b(-space)308
b(dri)-28 b(v)-17 b(ers)307 b(implemented)i(using)e(FUSD)h(can)863
19036 y(be)329 b(much)g(easier)f(to)f(deb)-22 b(ug;)355
b(it)327 b(is)g(impossible)h(for)f(them)h(to)g(crash)g(the)g(machine,)
343 b(are)328 b(easily)g(traceable)h(using)f(tools)g(such)g(as)863
20364 y Fo(gdb)p Fn(,)317 b(and)310 b(can)g(be)g(killed)f(and)h
(restarted)f(without)g(rebooting)i(e)-28 b(v)-17 b(en)311
b(if)d(the)-17 b(y)310 b(become)h(corrupted.)440 b(FUSD)310
b(dri)-28 b(v)-17 b(ers)310 b(don')-20 b(t)309 b(ha)-22
b(v)-17 b(e)863 21693 y(to)351 b(be)h(in)f(C\227Perl,)370
b(Python,)h(or)351 b(an)-17 b(y)353 b(other)e(language)j(that)e(kno)-28
b(ws)352 b(ho)-28 b(w)353 b(to)e(read)h(from)e(and)j(write)d(to)h(a)h
(\002le)f(descriptor)h(can)863 23021 y(w)-11 b(ork)278
b(with)f(FUSD.)g(User)-22 b(-space)278 b(dri)-28 b(v)-17
b(ers)277 b(can)i(be)e(sw)-11 b(apped)279 b(out,)e(whereas)i(k)-11
b(ernel)277 b(dri)-28 b(v)-17 b(ers)278 b(lock)g(ph)-6
b(ysical)278 b(memory)-72 b(.)2524 25013 y(Of)343 b(course,)360
b(as)343 b(with)h(almost)f(e)-28 b(v)-17 b(erything,)363
b(there)344 b(are)f(trade-of)-28 b(fs.)543 b(User)-22
b(-space)344 b(dri)-28 b(v)-17 b(ers)344 b(are)f(slo)-28
b(wer)344 b(than)g(k)-11 b(ernel)345 b(dri)-28 b(v)-17
b(ers)863 26342 y(because)260 b(the)-17 b(y)258 b(require)g(three)g
(times)f(as)g(man)-17 b(y)259 b(system)e(calls,)j(and)f(additional)g
(memory)f(copies)g(\(see)g(section)f(10\).)337 b(User)-22
b(-space)863 27670 y(dri)-28 b(v)-17 b(ers)226 b(can)h(not)e(recei)-28
b(v)-17 b(e)228 b(interrupts,)235 b(and)226 b(do)h(not)e(ha)-22
b(v)-17 b(e)228 b(the)d(full)g(po)-28 b(wer)227 b(to)e(modify)h
(arbitrary)f(k)-11 b(ernel)227 b(data)f(structures)f(as)g(k)-11
b(ernel)863 28998 y(dri)-28 b(v)-17 b(ers)395 b(do.)698
b(Despite)395 b(these)g(limitations,)424 b(we)395 b(ha)-22
b(v)-17 b(e)397 b(found)f(user)-22 b(-space)395 b(de)-28
b(vice)397 b(dri)-28 b(v)-17 b(ers)396 b(to)f(be)g(a)g(po)-28
b(werful)396 b(programming)863 30327 y(paradigm)279 b(with)e(a)g(wide)h
(v)-28 b(ariety)278 b(of)e(uses)h(\(see)g(Section)i(2\).)2524
32319 y(FUSD)323 b(is)e(free)h(softw)-11 b(are,)334 b(distrib)-22
b(uted)322 b(under)i(a)e(GPL-compatible)j(license)e(\(the)f(\223ne)-28
b(w\224)325 b(BSD)e(license,)334 b(with)322 b(the)h(adv)-17
b(er)-22 b(-)863 33648 y(tising)277 b(clause)h(remo)-17
b(v)g(ed\).)863 37481 y Fj(1.2)1329 b(Ho)-13 b(w)332
b(does)g(FUSD)f(w)-13 b(ork?)863 40220 y Fn(FUSD)320
b(dri)-28 b(v)-17 b(ers)320 b(are)f(conceptually)k(similar)317
b(to)i(k)-11 b(ernel)320 b(dri)-28 b(v)-17 b(ers:)428
b(a)319 b(set)g(of)g(callback)i(functions)f(called)g(in)f(response)h
(to)f(system)863 41549 y(calls)277 b(made)i(on)f(\002le)g(descriptors)g
(by)g(user)f(programs.)346 b(FUSD')-61 b(s)278 b(C)f(library)h(pro)-17
b(vides)279 b(a)e(de)-28 b(vice)280 b(re)-17 b(gistration)278
b(function,)g(similar)863 42877 y(to)224 b(the)h(k)-11
b(ernel')-61 b(s)224 b Fo(devfs)p 10628 42877 333 45
v 400 w(register)p 16340 42877 V 400 w(chrdev\(\))h Fn(function,)236
b(to)224 b(create)h(ne)-28 b(w)226 b(de)-28 b(vices.)327
b Fo(fusd)p 39020 42877 V 399 w(register\(\))226 b Fn(accepts)g(the)863
44205 y(de)-28 b(vice)273 b(name)f(and)g(a)f(structure)f(full)g(of)g
(pointers.)342 b(Those)272 b(pointers)f(are)f(callback)j(functions)f
(which)f(are)g(called)h(in)f(response)g(to)863 45534
y(certain)293 b(user)g(system)f(calls\227for)g(e)-17
b(xample,)299 b(when)294 b(a)e(process)h(tries)f(to)g(open,)298
b(close,)e(read)e(from,)h(or)e(write)f(to)g(the)h(de)-28
b(vice)295 b(\002le.)863 46862 y(The)281 b(callback)i(functions)e
(should)g(conform)g(to)g(the)f(standard)i(de\002nitions)f(of)f(POSIX)h
(system)f(call)h(beha)-22 b(vior)-61 b(.)355 b(In)280
b(man)-17 b(y)282 b(w)-11 b(ays,)863 48190 y(the)278
b(user)-22 b(-space)277 b(FUSD)i(callback)g(functions)e(are)h
(identical)g(to)f(their)g(k)-11 b(ernel)277 b(counterparts.)2524
50183 y(Perhaps)356 b(the)g(best)f(w)-11 b(ay)356 b(to)f(sho)-28
b(w)356 b(what)g(FUSD)g(does)g(is)e(by)i(e)-17 b(xample.)580
b(Program)357 b(1)e(is)f(a)i(simple)f(FUSD)h(de)-28 b(vice)357
b(dri)-28 b(v)-17 b(er)-61 b(.)863 51511 y(When)429 b(the)g(program)g
(is)e(run,)465 b(a)428 b(de)-28 b(vice)431 b(called)e
Fo(/dev/hello-world)h Fn(appears)f(under)g(the)g Fo(/dev)f
Fn(directory)-72 b(.)797 b(If)427 b(that)863 52840 y(de)-28
b(vice)256 b(is)d(read)i(\(e.g.,)j(using)d Fo(cat)p Fn(\),)j(the)c
(read)h(returns)f Fo(Hello,)665 b(world!)337 b Fn(follo)-28
b(wed)255 b(by)g(an)f(EOF)-89 b(.)255 b(Finally)-72 b(,)259
b(when)d(the)e(dri)-28 b(v)-17 b(er)863 54168 y(is)276
b(stopped)j(\(e.g.,)d(by)i(hitting)f(Control-C\),)g(the)g(de)-28
b(vice)279 b(\002le)f(disappears.)2524 56160 y(On)325
b(line)f(40)i(of)e(the)h(source,)337 b(we)325 b(use)g
Fo(fusd)p 20179 56160 V 399 w(register\(\))h Fn(to)e(create)i(the)f
Fo(/dev/hello-world)i Fn(de)-28 b(vice,)338 b(passing)863
57489 y(pointers)312 b(to)g(callbacks)i(for)d(the)h(open\(\),)322
b(close\(\))311 b(and)i(read\(\))f(system)g(calls.)447
b(\(Lines)312 b(36\22639)i(use)e(the)h(GNU)f(C)g(e)-17
b(xtension)314 b(that)863 58817 y(allo)-28 b(ws)302 b(initializer)e
(\002eld)j(naming;)314 b(the)302 b(2.4)f(series)g(of)g(Linux)h(k)-11
b(ernels)302 b(use)f(also)h(that)f(e)-17 b(xtension)303
b(for)e(the)h(same)f(purpose.\))417 b(The)863 60146 y(\223Hello,)322
b(W)-89 b(orld\224)313 b(read\(\))f(callback)i(itself)d(is)g(virtually)
i(identical)g(to)f(what)h(a)f(k)-11 b(ernel)313 b(dri)-28
b(v)-17 b(er)313 b(for)f(this)f(de)-28 b(vice)315 b(w)-11
b(ould)313 b(look)g(lik)-11 b(e.)863 61474 y(It)337 b(can)i(inspect)g
(and)g(modify)g(the)f(user')-61 b(s)337 b(\002le)h(pointer)-44
b(,)354 b(cop)-11 b(y)339 b(data)g(into)f(the)g(user)-22
b(-pro)-17 b(vided)340 b(b)-22 b(uf)-28 b(fer)-44 b(,)353
b(control)339 b(the)f(system)g(call)863 62802 y(return)277
b(v)-28 b(alue)279 b(\(either)e(positi)-28 b(v)-17 b(e,)278
b(EOF)-89 b(,)278 b(or)f(error\),)e(and)k(so)d(forth.)2524
64795 y(The)269 b(proxying)h(of)e(k)-11 b(ernel)269 b(system)f(calls)f
(that)i(mak)-11 b(es)269 b(this)e(kind)i(of)f(program)h(possible)f(is)g
(implemented)i(by)f(FUSD,)g(using)863 66123 y(a)296 b(combination)i(of)
e(a)f(k)-11 b(ernel)297 b(module)g(and)g(cooperating)h(user)-22
b(-space)297 b(library)-72 b(.)399 b(The)296 b(k)-11
b(ernel)297 b(module)g(implements)g(a)e(character)863
67451 y(de)-28 b(vice,)395 b Fo(/dev/fusd)p Fn(,)f(which)371
b(is)e(used)i(as)e(a)h(control)h(channel)h(between)g(the)e(tw)-11
b(o.)622 b(fusd)p 37393 67451 V 398 w(re)-17 b(gister\(\))369
b(uses)h(this)f(channel)j(to)863 68780 y(send)304 b(a)f(message)i(to)e
(the)g(FUSD)h(k)-11 b(ernel)304 b(module,)311 b(telling)304
b(the)f(name)i(of)e(the)g(de)-28 b(vice)305 b(the)f(user)f(w)-11
b(ants)303 b(to)g(re)-17 b(gister)-61 b(.)422 b(The)304
b(k)-11 b(ernel)863 70108 y(module,)263 b(in)258 b(turn,)j(re)-17
b(gisters)257 b(that)h(de)-28 b(vice)260 b(with)e(the)g(k)-11
b(ernel)259 b(proper)g(using)f(de)-28 b(vfs.)337 b(de)-28
b(vfs)259 b(and)g(the)f(k)-11 b(ernel)259 b(don')-20
b(t)258 b(kno)-28 b(w)260 b(an)-17 b(ything)25681 74071
y(1)p eop
%%Page: 2 5
2 4 bop 863 3831 50191 89 v 863 4815 a Fl(Pr)-20 b(ogram)280
b(1)d Fn(hello)-28 b(w)-11 b(orld.c:)345 b(A)277 b(simple)g(program)h
(using)f(FUSD)h(to)f(create)h Fo(/dev/hello-world)p 863
5320 50191 45 v 365 6276 a Fi(1)1661 b Fo(#include)665
b(<stdio.h>)2524 7604 y(#include)g(<string.h>)2524 8932
y(#include)g(<errno.h>)2524 10261 y(#include)g("fusd.h")365
11589 y Fi(5)2524 12917 y Fo(#define)g(GREETING)h("Hello,)f(world!\\n")
2524 15574 y(int)f(do_open_or_close\(struct)669 b(fusd_file_info)d
(*file\))2524 16902 y({)-133 18231 y Fi(10)2989 b Fo(return)665
b(0;)g(/*)f(attempts)i(to)e(open)h(and)g(close)g(this)g(file)g(always)g
(succeed)g(*/)2524 19559 y(})2524 22216 y(int)f(do_read\(struct)j
(fusd_file_info)g(*file,)e(char)g(*user_buffer,)10494
23544 y(size_t)g(user_length,)h(loff_t)f(*offset\))-133
24873 y Fi(15)1661 b Fo({)3852 26201 y(int)665 b(retval)g(=)f(0;)3852
28858 y(/*)g(The)h(first)g(read)g(to)g(the)f(device)i(returns)f(a)f
(greeting.)1330 b(The)665 b(second)g(read)4516 30186
y(*)f(returns)i(EOF.)f(*/)-133 31514 y Fi(20)2989 b Fo(if)664
b(\(*offset)i(==)f(0\))f({)5180 32843 y(if)h(\(user_length)h(<)e
(strlen\(GREETING\)\))6509 34171 y(retval)h(=)f(-EINVAL;)1330
b(/*)665 b(the)f(user)h(must)g(supply)g(a)g(big)f(enough)i(buffer!)f
(*/)5180 35499 y(else)g({)6509 36828 y(memcpy\(user_buffer,)i
(GREETING,)f(strlen\(GREETING\)\);)h(/*)e(greet)g(user)g(*/)-133
38156 y Fi(25)5646 b Fo(retval)665 b(=)f(strlen\(GREETING\);)j(/*)e
(retval)g(=)g(number)g(of)f(bytes)h(returned)h(*/)6509
39484 y(*offset)f(+=)g(retval;)g(/*)g(advance)g(user's)g(file)g
(pointer)g(*/)5180 40813 y(})3852 42141 y(})-133 44798
y Fi(30)2989 b Fo(return)665 b(retval;)2524 46126 y(})2524
48783 y(int)f(main\(int)i(argc,)f(char)g(*argv[]\))2524
50111 y({)-133 51440 y Fi(35)2989 b Fo(struct)665 b
(fusd_file_operations)j(fops)d(=)f({)5180 52768 y(open:)h
(do_open_or_close,)5180 54096 y(read:)g(do_read,)5180
55425 y(close:)h(do_open_or_close)h(};)-133 58081 y Fi(40)2989
b Fo(if)664 b(\(fusd_register\("/dev/hello-world",)671
b(0666,)665 b(NULL,)g(&fops\))g(<)f(0\))5180 59410 y(perror\("Unable)j
(to)d(register)i(device"\);)3852 60738 y(else)f({)5180
62066 y(printf\("/dev/hello-world)k(should)c(now)g(exist)g(-)f(calling)
h(fusd_run...\\n"\);)5180 63395 y(fusd_run\(\);)-133
64723 y Fi(45)2989 b Fo(})3852 66051 y(return)665 b(0;)2524
67380 y(})p 863 68874 V 25681 74071 a Fn(2)p eop
%%Page: 3 6
3 5 bop 863 2974 a Fn(unusual)256 b(is)e(happening;)265
b(it)254 b(appears)h(from)g(their)f(point)h(of)g(vie)-28
b(w)255 b(that)g(the)g(re)-17 b(gistered)255 b(de)-28
b(vices)257 b(are)d(simply)h(being)h(implemented)863
4302 y(by)278 b(the)f(FUSD)h(module.)2524 6295 y(Later)-44
b(,)408 b(when)383 b(k)-11 b(ernel)383 b(mak)-11 b(es)383
b(a)f(callback)j(due)e(to)f(a)g(system)g(call)g(\(e.g.)g(when)i(the)e
(character)i(de)-28 b(vice)384 b(\002le)e(is)g(opened)i(or)863
7623 y(read\),)286 b(the)e(FUSD)g(k)-11 b(ernel)285 b(module')-61
b(s)285 b(callback)g(blocks)g(the)f(calling)g(process,)i(marshals)e
(the)g(ar)-20 b(guments)285 b(of)e(the)h(callback)i(into)863
8951 y(a)403 b(message)g(and)h(sends)f(it)e(to)i(user)-22
b(-space.)720 b(Once)404 b(there,)434 b(the)403 b(library)g(half)f(of)g
(FUSD)i(unmarshals)f(it)f(and)h(calls)g(whate)-28 b(v)-17
b(er)863 10280 y(user)-22 b(-space)290 b(callback)i(the)e(FUSD)g(dri)
-28 b(v)-17 b(er)290 b(passed)h(to)e(fusd)p 23790 10280
333 45 v 399 w(re)-17 b(gister\(\).)379 b(When)291 b(that)e(user)-22
b(-space)290 b(callback)i(returns)d(a)h(v)-28 b(alue,)294
b(the)863 11608 y(process)255 b(happens)h(in)e(re)-28
b(v)-17 b(erse:)333 b(the)254 b(return)g(v)-28 b(alue)256
b(and)f(its)e(side-ef)-28 b(fects)254 b(are)g(marshaled)h(by)g(the)f
(library)g(and)h(sent)f(to)g(the)g(k)-11 b(ernel.)863
12936 y(The)302 b(FUSD)f(k)-11 b(ernel)301 b(module)i(unmarshals)e
(this)e(message,)308 b(matches)301 b(it)f(up)h(with)f(a)h
(corresponding)i(outstanding)f(request,)307 b(and)863
14265 y(completes)g(the)f(system)f(call.)428 b(The)306
b(calling)h(process)e(is)g(completely)i(una)-17 b(w)-11
b(are)308 b(of)d(this)g(trick)-11 b(ery;)319 b(it)305
b(simply)g(enters)g(the)h(k)-11 b(ernel)863 15593 y(once,)279
b(blocks,)e(unblocks,)i(and)f(returns)f(from)g(the)g(system)g
(call\227just)f(as)h(it)f(w)-11 b(ould)278 b(for)f(an)-17
b(y)279 b(other)e(blocking)i(call.)2524 17586 y(One)312
b(of)f(the)h(primary)g(design)g(goals)g(of)g(FUSD)g(is)f
Fk(stability)p Fn(.)446 b(It)310 b(should)j(not)f(be)g(possible)g(for)e
(a)i(FUSD)h(dri)-28 b(v)-17 b(er)312 b(to)f(corrupt)863
18914 y(or)286 b(crash)g(the)g(k)-11 b(ernel,)289 b(either)d(due)h(to)e
(error)h(or)f(malice.)371 b(Of)285 b(course,)j(a)e(b)-22
b(uggy)288 b(dri)-28 b(v)-17 b(er)287 b(itself)d(may)j(corrupt)f
(itself)f(\(e.g.,)i(due)g(to)f(a)863 20242 y(b)-22 b(uf)-28
b(fer)292 b(o)-17 b(v)g(errun\).)387 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)297 b(strict)290 b(error)h(checking)j(is)c(implemented)k
(at)d(the)g(user)-22 b(-k)-11 b(ernel)292 b(boundary)i(which)f(should)f
(pre)-28 b(v)-17 b(ent)863 21571 y(dri)-28 b(v)-17 b(ers)290
b(from)f(corrupting)h(the)g(k)-11 b(ernel)290 b(or)f(an)-17
b(y)291 b(other)e(user)-22 b(-space)290 b(process\227including)i(the)e
(errant)f(dri)-28 b(v)-17 b(er')-61 b(s)289 b(o)-28 b(wn)291
b(clients,)h(and)863 22899 y(other)278 b(FUSD)g(dri)-28
b(v)-17 b(ers.)863 26732 y Fj(1.3)1329 b(What)332 b(FUSD)g
Fh(Isn')-49 b(t)863 29472 y Fn(FUSD)388 b(looks)g(similar)e(to)h
(certain)h(other)g(Linux)h(f)-11 b(acilities)386 b(that)h(are)h
(already)g(a)-22 b(v)-28 b(ailable.)676 b(It)386 b(also)i(skirts)d
(near)j(a)g(fe)-28 b(w)388 b(of)f(the)863 30800 y(k)-11
b(ernel')-61 b(s)277 b(hot-b)-22 b(utton)279 b(political)e(issues.)342
b(So,)278 b(to)f(a)-22 b(v)g(oid)278 b(confusion,)g(we)g(present)f(a)g
(list)f(of)h(things)g(that)g(FUSD)h(is)e Fk(not)p Fn(.)2524
33900 y Fg(\017)554 b Fl(A)344 b(FUSD)i(dri)-11 b(v)g(er)346
b(is)e(not)h(a)g(k)-11 b(er)-17 b(nel)347 b(module.)548
b Fn(K)-28 b(ernel)346 b(modules)g(allo)-28 b(w\227well,)363
b(modularity)345 b(of)g(k)-11 b(ernel)346 b(code.)548
b(The)-17 b(y)3631 35228 y(let)325 b(you)j(insert)d(and)j(remo)-17
b(v)g(e)328 b(k)-11 b(ernel)327 b(modules)h(dynamically)g(after)e(the)h
(k)-11 b(ernel)327 b(boots.)491 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)341 b(once)328 b(inserted,)339 b(the)3631
36556 y(k)-11 b(ernel)338 b(modules)h(are)g(actually)g(part)f(of)f(the)
h(k)-11 b(ernel)339 b(proper)-61 b(.)527 b(The)-17 b(y)340
b(run)e(in)g(the)g(k)-11 b(ernel')-61 b(s)338 b(address)g(space,)354
b(with)338 b(all)g(the)3631 37885 y(same)351 b(pri)-28
b(vile)-17 b(ges)352 b(and)g(restrictions)e(that)h(nati)-28
b(v)-17 b(e)352 b(k)-11 b(ernel)352 b(code)g(does.)566
b(A)350 b(FUSD)i(de)-28 b(vice)353 b(dri)-28 b(v)-17
b(er)-44 b(,)370 b(in)350 b(contrast,)370 b(is)349 b(more)3631
39213 y(similar)275 b(to)i(a)h(daemon\227a)h(program)f(that)g(runs)e
(as)h(a)h(user)-22 b(-space)277 b(process,)h(with)f(a)g(process)g(ID.)
2524 41427 y Fg(\017)554 b Fl(FUSD)301 b(is)f(not,)306
b(and)c(doesn't)f(r)-20 b(eplace,)308 b(de)-17 b(vfs.)415
b Fn(When)301 b(a)g(FUSD)g(dri)-28 b(v)-17 b(er)302 b(re)-17
b(gisters)300 b(a)g(FUSD)i(de)-28 b(vice,)308 b(it)300
b(automatically)3631 42755 y(creates)339 b(a)f(de)-28
b(vice)341 b(\002le)e(in)f Fo(/dev)p Fn(.)528 b(Ho)-28
b(we)g(v)-17 b(er)-44 b(,)356 b(FUSD)339 b(is)e(not)i(a)g(replacement)i
(for)d(de)-28 b(vfs\227quite)339 b(the)g(contrary)-72
b(,)355 b(FUSD)3631 44084 y(creates)424 b(those)g(de)-28
b(vice)425 b(\002les)f(by)g Fk(using)g Fn(de)-28 b(vfs.)783
b(In)424 b(a)f(normal)i(Linux)f(system,)460 b(only)425
b(k)-11 b(ernel)424 b(modules)h(proper)-22 b(\227not)3631
45412 y(user)g(-space)277 b(programs\227can)j(re)-17
b(gister)276 b(with)h(de)-28 b(vfs)278 b(\(see)f(abo)-17
b(v)g(e\).)2524 47626 y Fg(\017)554 b Fl(FUSD)214 b(is)f(not)i(UDI.)e
Fn(UDI,)h(the)g(Uniform)g(Dri)-28 b(v)-17 b(er)215 b(Interf)-11
b(ace)26987 47224 y Ff(1)27430 47626 y Fn(,)226 b(aims)214
b(to)g(create)h(a)f(binary)h(API)f(for)f(dri)-28 b(v)-17
b(ers)215 b(that)f(is)f(uniform)3631 48954 y(across)338
b(operating)j(systems.)527 b(It')-61 b(s)338 b(true)g(that)h(FUSD)h
(could)g(concei)-28 b(v)g(ably)343 b(be)c(used)h(for)e(a)h(similar)f
(purpose)i(\(inasmuch)3631 50283 y(as)360 b(it)f(de\002nes)j(a)e
(system)g(call)g(messaging)i(structure\).)592 b(Ho)-28
b(we)g(v)-17 b(er)-44 b(,)383 b(this)359 b(w)-11 b(as)361
b(not)f(the)h(goal)g(of)f(FUSD)h(as)f(much)h(as)f(an)3631
51611 y(accidental)287 b(side)f(ef)-28 b(fect.)369 b(W)-89
b(e)286 b(do)g(not)g(adv)-22 b(ocate)288 b(publishing)f(dri)-28
b(v)-17 b(ers)286 b(in)f(binary-only)j(form,)e(e)-28
b(v)-17 b(en)288 b(though)g(FUSD)e(does)3631 52939 y(mak)-11
b(e)278 b(this)e(possible)h(in)g(some)h(cases.)2524 55153
y Fg(\017)554 b Fl(FUSD)306 b(is)f(not)i(an)f(attempt)g(to)g(tur)-17
b(n)307 b(Linux)g(into)f(a)g(micr)-20 b(ok)-11 b(er)-17
b(nel.)433 b Fn(W)-89 b(e)307 b(aren')-20 b(t)306 b(trying)g(to)g(port)
g(e)-17 b(xisting)307 b(dri)-28 b(v)-17 b(ers)306 b(into)3631
56482 y(user)-22 b(-space)323 b(for)g(a)g(v)-28 b(ariety)324
b(of)f(reasons)g(\(not)g(the)g(least)g(of)g(which)h(is)e
(performance\).)482 b(W)-89 b(e')-55 b(v)-17 b(e)324
b(used)g(FUSD)g(as)f(a)g(tool)g(to)3631 57810 y(write)314
b(ne)-28 b(w)316 b(dri)-28 b(v)-17 b(ers)315 b(that)g(are)g(much)h
(easier)f(from)g(user)-22 b(-space)316 b(than)f(the)-17
b(y)316 b(w)-11 b(ould)316 b(be)g(in)e(the)i(k)-11 b(ernel;)334
b(see)315 b(Section)i(2)e(for)3631 59138 y(use)277 b(cases.)863
62971 y Fj(1.4)1329 b(Related)332 b(W)-100 b(ork)863
65711 y Fn(FUSD)418 b(is)e(a)h(ne)-28 b(w)418 b(implementation,)453
b(b)-22 b(ut)418 b(certainly)f(not)g(a)h(ne)-28 b(w)418
b(idea\227the)g(theory)g(of)e(its)g(operation)i(is)e(the)h(same)h(as)e
(an)-17 b(y)863 67039 y(microk)-11 b(ernel)280 b(operating)g(system.)
346 b(A)279 b(microk)-11 b(ernel)279 b(\(roughly)h(speaking\))f(is)f
(one)h(that)g(implements)g(only)g(v)-17 b(ery)279 b(basic)g(resource)p
863 67987 20076 45 v 2070 68728 a Fe(1)2457 69041 y Fd(http://www)-58
b(.projectudi.or)-16 b(g)25681 74071 y Fn(3)p eop
%%Page: 4 7
4 6 bop 863 2974 a Fn(protection)283 b(and)f(message)g(passing)g(in)f
(the)h(k)-11 b(ernel.)356 b(Implementation)284 b(of)d(de)-28
b(vice)283 b(dri)-28 b(v)-17 b(ers,)282 b(\002le)g(systems,)f(netw)-11
b(ork)283 b(stacks,)f(and)863 4302 y(so)277 b(forth)g(are)g(rele)-17
b(g)-6 b(ated)280 b(to)c(userspace.)345 b(P)-17 b(atrick)278
b(Bridges)g(maintains)f(a)g(list)f(of)h(such)h(microk)-11
b(ernel)278 b(operating)h(systems)47733 3900 y Ff(2)48175
4302 y Fn(.)2524 6295 y(Also)243 b(related)i(is)e(the)i(idea)g(of)f(a)g
(user)-22 b(-space)245 b(\002lesystem,)251 b(which)245
b(has)f(been)i(implemented)g(in)e(a)g(number)i(of)e(conte)-17
b(xts.)334 b(Some)863 7623 y(e)-17 b(xamples)332 b(include)f(Klaus)f
(Schauser')-61 b(s)330 b(UFO)h(Project)22599 7221 y Ff(3)23372
7623 y Fn(for)e(Solaris,)342 b(and)331 b(Jeremy)f(Fitzhardinge')-61
b(s)331 b(\(no)f(longer)g(maintained\))863 8951 y(UserFS)4183
8550 y Ff(4)5023 8951 y Fn(for)396 b(Linux)i(1.x.)702
b(The)397 b(UFO)g(paper)19297 8550 y Ff(5)20138 8951
y Fn(is)e(also)i(notable)h(because)h(it)c(has)i(a)g(good)h(surv)-17
b(e)g(y)398 b(of)f(similar)e(projects)i(that)863 10280
y(inte)-17 b(grate)278 b(user)-22 b(-space)278 b(code)h(with)e(system)g
(calls.)863 14076 y Fj(1.5)1329 b(Limitations)333 b(and)e(Futur)-24
b(e)331 b(W)-100 b(ork)863 16815 y Fn(In)282 b(its)e(current)i(form,)g
(FUSD)h(is)e(useful)g(and)i(has)f(pro)-17 b(v)g(en)284
b(to)e(be)g(quite)g(stable\227we)h(use)e(it)g(in)h(production)h
(systems.)357 b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)863
18144 y(it)312 b(does)i(ha)-22 b(v)-17 b(e)315 b(some)e(limitations)g
(that)g(could)h(bene\002t)h(from)d(the)i(attention)g(of)f(de)-28
b(v)-17 b(elopers.)453 b(Contrib)-22 b(utions)314 b(to)f(correct)h(an)
-17 b(y)314 b(of)863 19472 y(these)h(de\002ciencies)i(are)d(welcomed!)
457 b(\(Man)-17 b(y)316 b(of)e(these)h(limitations)e(will)h(not)g(mak)
-11 b(e)316 b(sense)e(without)h(ha)-22 b(ving)316 b(read)f(the)g(rest)e
(of)863 20801 y(the)278 b(documentation)i(\002rst.\))2524
23695 y Fg(\017)554 b Fn(Currently)-72 b(,)373 b(FUSD)356
b(only)f(supports)f(implementation)i(of)e(character)i(de)-28
b(vices.)576 b(Block)356 b(de)-28 b(vices)356 b(and)f(netw)-11
b(ork)355 b(de)-28 b(vices)3631 25023 y(are)277 b(not)g(supported)i
(yet.)2524 27155 y Fg(\017)554 b Fn(The)335 b(k)-11 b(ernel)335
b(has)g(15)g(dif)-28 b(ferent)334 b(callbacks)i(in)e(its)f
Fo(file)p 25893 27155 333 45 v 400 w(operations)i Fn(structure.)515
b(The)336 b(current)f(v)-17 b(ersion)335 b(of)f(FUSD)3631
28484 y(does)277 b(not)h(proxy)g(some)g(of)e(the)i(more)f(obscure)i
(ones)e(out)h(to)f(userspace.)2524 30616 y Fg(\017)554
b Fn(Currently)-72 b(,)298 b(all)293 b(system)g(calls)g(that)h(FUSD)g
(understands)i(are)d(proxied)i(from)e(the)h(FUSD)h(k)-11
b(ernel)294 b(module)h(to)f(userspace.)3631 31944 y(Only)341
b(the)g(userspace)h(library)e(kno)-28 b(ws)342 b(which)f(callbacks)h
(ha)-22 b(v)-17 b(e)343 b(actually)f(been)g(re)-17 b(gistered)341
b(by)g(the)g(FUSD)h(dri)-28 b(v)-17 b(er)-61 b(.)534
b(F)-17 b(or)3631 33272 y(e)g(xample,)398 b(the)373 b(k)-11
b(ernel)374 b(may)f(proxy)h(a)f(write\(\))e(system)h(call)h(to)f(user)
-22 b(-space)374 b(e)-28 b(v)-17 b(en)375 b(if)c(the)i(dri)-28
b(v)-17 b(er)374 b(has)e(not)h(re)-17 b(gistered)374
b(a)3631 34601 y(write\(\))275 b(callback)k(with)e(fusd)p
15101 34601 V 399 w(re)-17 b(gister\(\).)3631 36331 y(fusd)p
5603 36331 V 398 w(re)g(gister\(\))238 b(should,)247
b(b)-22 b(ut)239 b(currently)g(does)g(not,)247 b(tell)238
b(the)h(k)-11 b(ernel)239 b(module)h(which)g(callbacks)g(it)e(w)-11
b(ants)239 b(to)f(recei)-28 b(v)-17 b(e,)248 b(per)-22
b(-)3631 37659 y(de)-28 b(vice.)424 b(This)303 b(will)g(be)h(more)g(ef)
-28 b(\002cient)305 b(because)g(it)e(will)f(pre)-28 b(v)-17
b(ent)306 b(useless)d(system)g(calls)g(for)g(unsupported)j(operations.)
3631 38987 y(In)380 b(addition,)408 b(it)381 b(will)f(lead)i(to)f(more)
g(logical)h(and)g(consistent)g(beha)-22 b(vior)383 b(by)e(allo)-28
b(wing)383 b(the)e(k)-11 b(ernel)382 b(to)f(use)h(its)d(def)-11
b(ault)3631 40316 y(implementations)336 b(of)f(certain)h(functions)g
(such)g(as)f(write)-28 b(v\(\),)349 b(instead)335 b(of)g(being)i
(fooled)f(into)f(thinking)h(the)g(dri)-28 b(v)-17 b(er)336
b(has)3631 41644 y(an)277 b(implementation)i(of)e(it)f(in)h(cases)h
(where)g(it)e(doesn')-20 b(t.)2524 43776 y Fg(\017)554
b Fn(It)370 b(should)j(be)g(possible)f(to)f(write)g(a)h(FUSD)h(library)
f(in)f(an)-17 b(y)374 b(language)g(that)e(supports)g(reads)g(and)h
(writes)e(on)h(ra)-17 b(w)373 b(\002le)3631 45104 y(descriptors.)336
b(In)257 b(the)h(future,)j(it)256 b(might)h(be)h(possible)f(to)g(write)
g(FUSD)h(de)-28 b(vice)260 b(dri)-28 b(v)-17 b(ers)257
b(in)g(a)h(v)-28 b(ariety)258 b(of)f(languages\227Perl,)3631
46433 y(Python,)278 b(maybe)h(e)-28 b(v)-17 b(en)279
b(Ja)-22 b(v)-28 b(a.)345 b(Ho)-28 b(we)g(v)-17 b(er)-44
b(,)279 b(the)e(current)h(implementation)h(has)e(only)h(a)f(C)g
(library)-72 b(.)2524 48565 y Fg(\017)554 b Fn(It')-61
b(s)378 b(possible)i(for)f(dri)-28 b(v)-17 b(ers)380
b(that)g(use)h(FUSD)f(to)g(deadlock\227for)j(e)-17 b(xample,)407
b(if)379 b(a)h(dri)-28 b(v)-17 b(er)381 b(tries)e(to)g(open)j(itself.)
650 b(In)380 b(this)3631 49893 y(one)270 b(case,)i(FUSD)e(returns)f
Fo(-EDEADLOCK)p Fn(.)i(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)273
b(deadlock)f(protection)f(should)g(be)f(e)-17 b(xpanded)273
b(to)d(more)g(general)3631 51221 y(detection)278 b(of)f(c)-17
b(ycles)279 b(of)d(arbitrary)h(length.)2524 53353 y Fg(\017)554
b Fn(FUSD)324 b(should)g(pro)-17 b(vide)325 b(a)f(/proc)g(interf)-11
b(ace)324 b(that)f(gi)-28 b(v)-17 b(es)325 b(deb)-22
b(ugging)326 b(and)f(status)d(information,)336 b(and)324
b(allo)-28 b(ws)324 b(parameter)3631 54682 y(tuning.)2524
56814 y Fg(\017)554 b Fn(FUSD)412 b(w)-11 b(as)412 b(written)f(with)h
(ef)-28 b(\002cienc)-17 b(y)415 b(in)c(mind,)446 b(b)-22
b(ut)412 b(a)g(number)h(of)e(important)i(optimizations)g(ha)-22
b(v)-17 b(e)413 b(not)f(yet)g(been)3631 58142 y(implemented.)340
b(Speci\002cally)-72 b(,)266 b(we')-55 b(d)261 b(lik)-11
b(e)261 b(to)g(try)f(to)h(reduce)h(the)g(number)g(of)e(memory)j(copies)
e(by)h(using)f(a)g(b)-22 b(uf)-28 b(fer)261 b(shared)3631
59470 y(between)279 b(user)e(and)h(k)-11 b(ernel)278
b(space)g(to)f(pass)g(messages.)2524 61602 y Fg(\017)554
b Fn(FUSD)272 b(currently)g(requires)f(de)-28 b(vfs,)272
b(which)h(is)d(used)i(to)f(dynamically)i(create)f(de)-28
b(vice)273 b(\002les)e(under)i Fo(/dev)e Fn(when)i(a)e(FUSD)3631
62931 y(dri)-28 b(v)-17 b(er)273 b(re)-17 b(gisters)272
b(itself.)341 b(This)272 b(is,)h(perhaps,)h(the)f(most)g(con)-44
b(v)-17 b(enient)276 b(and)e(useful)f(paradigm)h(for)e(FUSD.)i(Ho)-28
b(we)g(v)-17 b(er)-44 b(,)276 b(some)3631 64259 y(users)305
b(ha)-22 b(v)-17 b(e)309 b(ask)-11 b(ed)307 b(if)f(it')-61
b(s)305 b(possible)h(to)h(use)f(FUSD)i(without)f(de)-28
b(vfs.)432 b(This)306 b(should)i(be)f(possible)f(if)g(FUSD)h(dri)-28
b(v)-17 b(ers)307 b(bind)3631 65587 y(to)276 b(de)-28
b(vice)280 b(major)d(numbers)h(instead)g(of)f(de)-28
b(vice)279 b(\002le)e(names.)p 863 66453 20076 45 v 2070
67194 a Fe(2)2457 67507 y Fd(http://www)-58 b
(.cs.arizona.edu/people/bridges/os/microk)-9 b(ernel.html)2070
68275 y Fe(3)2457 68588 y Fd(http://www)-58 b(.cs.ucsb)-35
b(.edu/projects/ufo/inde)-13 b(x.html)2070 69356 y Fe(4)2457
69669 y Fd(http://www)-58 b(.goop.or)-16 b(g/)223 b(jeremy/userfs/)2070
70437 y Fe(5)2457 70750 y Fd(http://www)-58 b(.cs.ucsb)-35
b(.edu/projects/ufo/97-usenix-ufo.ps)25681 74071 y Fn(4)p
eop
%%Page: 5 8
5 7 bop 863 2974 a Fj(1.6)1329 b(A)-66 b(uthor)331 b(Contact)i(Inf)-33
b(ormation)331 b(and)g(Ackno)-13 b(wledgments)863 5714
y Fn(The)290 b(original)f(v)-17 b(ersion)290 b(of)f(FUSD)h(w)-11
b(as)289 b(written)f(by)i(Jeremy)f(Elson)h(\(jelson@circlemud.or)-20
b(g\))290 b(and)g(Le)-28 b(wis)289 b(Girod)g(at)g(Sensoria)863
7042 y(Corporation.)492 b(Sensoria)327 b(no)g(longer)g(maintains)f
(public)i(releases)e(of)g(FUSD,)g(b)-22 b(ut)327 b(the)f(same)h
(authors)f(ha)-22 b(v)-17 b(e)328 b(since)f(fork)-11
b(ed)327 b(the)863 8370 y(last)276 b(public)j(release)e(and)h(continue)
h(to)e(maintain)h(FUSD)g(from)f(the)h(Uni)-28 b(v)-17
b(ersity)278 b(of)e(California,)i(Los)f(Angeles.)2524
10363 y(If)f(you)i(ha)-22 b(v)-17 b(e)279 b(b)-22 b(ug)278
b(reports,)e(patches,)i(suggestions,)g(or)f(an)-17 b(y)278
b(other)g(comments,)g(please)g(feel)f(free)g(to)g(contact)i(the)e
(authors.)2524 12355 y(FUSD)263 b(has)f(tw)-11 b(o)262
b(SourceF)-17 b(or)d(ge)14879 11954 y Ff(6)15326 12355
y Fn(-host)261 b(mailing)i(lists:)334 b(a)262 b(lo)-28
b(w-traf)g(\002c)263 b(list)d(for)i(announcements)k(\()p
Fo(fusd-announce)p Fn(\))d(and)863 13684 y(a)346 b(list)e(for)h
(general)i(discussion)f(\()p Fo(fusd-devel)p Fn(\).)549
b(Subscription)347 b(information)f(for)f(both)i(lists)c(is)i(a)-22
b(v)-28 b(ailable)347 b(at)f(the)g(Source-)863 15012
y(F)-17 b(or)d(ge')-61 b(s)278 b(FUSD)g(mailing)g(list)d(page.)2524
17005 y(F)-17 b(or)277 b(the)h(latest)e(releases)h(and)i(information)e
(about)i(FUSD,)f(please)g(see)f(the)g(of)-28 b(\002cial)278
b(FUSD)g(home)h(page)43521 16603 y Ff(7)43966 17005 y
Fn(.)863 20837 y Fj(1.7)1329 b(Licensing)331 b(Inf)-33
b(ormation)863 23577 y Fn(FUSD)294 b(is)e(free)h(softw)-11
b(are,)297 b(distrib)-22 b(uted)293 b(under)h(a)f(GPL-compatible)j
(license)e(\(the)f(\223ne)-28 b(w\224)295 b(BSD)f(license,)j(with)c
(the)h(adv)-17 b(ertising)863 24905 y(clause)278 b(remo)-17
b(v)g(ed\).)346 b(The)278 b(license)f(is)g(enumerated)i(in)e(its)f
(entirety)h(belo)-28 b(w)-72 b(.)2524 26898 y(Cop)-11
b(yright)250 b(\(c\))f(2001,)256 b(Sensoria)251 b(Corporation;)260
b(\(c\))248 b(2003)j(Uni)-28 b(v)-17 b(ersity)251 b(of)e(California,)
255 b(Los)249 b(Angeles.)335 b(All)249 b(rights)g(reserv)-17
b(ed.)2524 28891 y(Redistrib)-22 b(ution)318 b(and)h(use)g(in)f(source)
g(and)i(binary)f(forms,)327 b(with)318 b(or)g(without)g
(modi\002cation,)331 b(are)318 b(permitted)h(pro)-17
b(vided)320 b(that)863 30219 y(the)278 b(follo)-28 b(wing)278
b(conditions)g(are)f(met:)2524 33097 y Fg(\017)554 b
Fn(Redistrib)-22 b(utions)266 b(of)g(source)h(code)h(must)e(retain)g
(the)h(abo)-17 b(v)g(e)269 b(cop)-11 b(yright)268 b(notice,)h(this)d
(list)e(of)i(conditions)i(and)f(the)g(follo)-28 b(w-)3631
34425 y(ing)277 b(disclaimer)-61 b(.)2524 36639 y Fg(\017)554
b Fn(Redistrib)-22 b(utions)375 b(in)f(binary)i(form)f(must)f
(reproduce)k(the)d(abo)-17 b(v)g(e)378 b(cop)-11 b(yright)376
b(notice,)400 b(this)374 b(list)g(of)g(conditions)j(and)f(the)3631
37968 y(follo)-28 b(wing)278 b(disclaimer)f(in)g(the)g(documentation)k
(and/or)d(other)f(materials)g(pro)-17 b(vided)279 b(with)e(the)h
(distrib)-22 b(ution.)2524 40182 y Fg(\017)554 b Fn(Neither)330
b(the)g(names)h(of)f(Sensoria)h(Corporation)g(or)f(UCLA,)g(nor)h(the)f
(names)h(of)e(other)i(contrib)-22 b(utors)330 b(may)h(be)f(used)h(to)
3631 41510 y(endorse)278 b(or)f(promote)h(products)g(deri)-28
b(v)-17 b(ed)279 b(from)e(this)f(softw)-11 b(are)277
b(without)h(speci\002c)g(prior)f(written)f(permission.)2524
44388 y(THIS)317 b(SOFTW)-133 b(ARE)319 b(IS)e(PR)-44
b(O)-55 b(VIDED)317 b(BY)g(THE)h(A)-61 b(UTHORS)318 b(AND)g(CONTRIB)-11
b(UT)-20 b(ORS)319 b(\223)-89 b(AS)318 b(IS\224)g(AND)f(ANY)g(EX-)863
45716 y(PRESS)238 b(OR)f(IMPLIED)g(W)-133 b(ARRANTIES,)238
b(INCLUDING,)g(B)-11 b(UT)237 b(NO)-44 b(T)236 b(LIMITED)h(T)-20
b(O,)237 b(THE)g(IMPLIED)g(W)-133 b(ARRANTIES)863 47045
y(OF)437 b(MERCHANT)-103 b(ABILITY)440 b(AND)d(FITNESS)h(FOR)f(A)g(P)
-102 b(AR)-66 b(TICULAR)439 b(PURPOSE)g(ARE)e(DISCLAIMED.)h(IN)e(NO)863
48373 y(EVENT)301 b(SHALL)f(THE)g(A)-61 b(UTHORS)301
b(OR)f(CONTRIB)-11 b(UT)-20 b(ORS)302 b(BE)e(LIABLE)g(FOR)g(ANY)g
(DIRECT)-82 b(,)300 b(INDIRECT)-82 b(,)300 b(INCI-)863
49701 y(DENT)-103 b(AL,)234 b(SPECIAL,)f(EXEMPLAR)-72
b(Y)-143 b(,)234 b(OR)f(CONSEQ)-11 b(UENTIAL)235 b(D)-44
b(AMA)g(GES)233 b(\(INCLUDING,)f(B)-11 b(UT)232 b(NO)-44
b(T)233 b(LIMITED)863 51030 y(T)-20 b(O,)314 b(PR)-44
b(OCUREMENT)316 b(OF)d(SUBSTITUTE)j(GOODS)f(OR)e(SER)-89
b(VICES;)316 b(LOSS)e(OF)g(USE,)g(D)-44 b(A)-123 b(T)-103
b(A,)314 b(OR)f(PR)-44 b(OFITS;)315 b(OR)863 52358 y(B)-11
b(USINESS)351 b(INTERR)-44 b(UPTION\))351 b(HO)-39 b(WEVER)351
b(CA)-61 b(USED)351 b(AND)e(ON)h(ANY)f(THEOR)-72 b(Y)351
b(OF)f(LIABILITY)-143 b(,)349 b(WHETHER)863 53686 y(IN)294
b(CONTRA)-44 b(CT)-82 b(,)295 b(STRICT)g(LIABILITY)-143
b(,)294 b(OR)g(T)-20 b(OR)-66 b(T)295 b(\(INCLUDING)f(NEGLIGENCE)i(OR)e
(O)-44 b(THER)-61 b(WISE\))295 b(ARISING)863 55015 y(IN)371
b(ANY)i(W)-133 b(A)-116 b(Y)371 b(OUT)i(OF)f(THE)g(USE)g(OF)h(THIS)f
(SOFTW)-133 b(ARE,)373 b(EVEN)g(IF)f(AD)-44 b(VISED)372
b(OF)g(THE)g(POSSIBILITY)i(OF)863 56343 y(SUCH)278 b(D)-44
b(AMA)g(GE.)863 60743 y Fm(2)1594 b(Wh)-24 b(y)399 b(use)g(FUSD?)863
63882 y Fn(One)240 b(basic)f(question)h(about)g(FUSD)g(that)f(one)g
(might)g(ask)g(is:)323 b(what)240 b(is)e(it)f(good)k(for?)330
b(Wh)-6 b(y)240 b(use)f(it?)331 b(In)238 b(this)g(section,)247
b(we)239 b(describe)863 65210 y(some)278 b(of)e(the)i(situations)f(in)g
(which)h(FUSD)g(has)f(been)i(the)e(solution)h(for)e(us.)p
863 65934 20076 45 v 2070 66675 a Fe(6)2457 66987 y Fd(http://www)-58
b(.sourcefor)-16 b(ge.net)2070 67746 y Fe(7)2457 68059
y Fd(http://www)-58 b(.circlemud.or)-16 b(g/jelson/softw)-9
b(are/fusd)25681 74071 y Fn(5)p eop
%%Page: 6 9
6 8 bop 863 2974 a Fj(2.1)1329 b(De)-20 b(vice)332 b(Dri)-13
b(v)g(er)331 b(Lay)-13 b(ering)863 5714 y Fn(A)309 b(problem)g(that)g
(comes)h(up)f(frequently)h(in)e(modern)i(operating)h(systems)d(is)f
(contention)k(for)d(a)h(single)g(resource)g(by)h(multiple)863
7042 y(competing)260 b(processes.)338 b(In)257 b(UNIX,)h(it')-61
b(s)257 b(the)h(job)g(of)g(a)g(de)-28 b(vice)260 b(dri)-28
b(v)-17 b(er)259 b(to)f(coordinate)i(access)f(to)f(such)h(resources.)
337 b(By)258 b(accepting)863 8370 y(requests)327 b(from)f(user)h
(processes)g(and)h(\(for)d(e)-17 b(xample\))329 b(queuing)g(and)f
(serializing)e(them,)340 b(it)326 b(becomes)i(safe)f(for)f(processes)h
(that)863 9699 y(kno)-28 b(w)273 b(nothing)g(about)f(each)h(other)e(to)
g(mak)-11 b(e)273 b(requests)e(in)g(parallel)h(to)f(the)g(same)h
(resource.)342 b(Of)271 b(course,)h(k)-11 b(ernel)272
b(dri)-28 b(v)-17 b(ers)272 b(do)g(this)863 11027 y(job)g(already)-72
b(,)274 b(b)-22 b(ut)271 b(the)-17 b(y)273 b(typically)f(operate)h(on)f
(top)g(of)f(hardw)-11 b(are)273 b(directly)-72 b(.)342
b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)275 b(k)-11 b(ernel)272
b(dri)-28 b(v)-17 b(ers)272 b(can')-20 b(t)272 b(easily)f(be)i(layered)
863 12355 y(on)278 b(top)f(of)g Fk(other)h(de)-17 b(vice)279
b(driver)-11 b(s)p Fn(.)2524 14348 y(F)-17 b(or)252 b(e)-17
b(xample,)259 b(consider)253 b(a)f(de)-28 b(vice)255
b(such)d(as)g(a)g(modem)i(that)e(is)f(connected)k(to)d(a)g(host)g(via)g
(a)g(serial)f(port.)335 b(Let')-61 b(s)252 b(say)g(we)g(w)-11
b(ant)863 15676 y(to)271 b(implement)g(a)g(de)-28 b(vice)272
b(dri)-28 b(v)-17 b(er)272 b(that)e(allo)-28 b(ws)271
b(multiple)g(users)f(to)g(dial)h(the)f(telephone)j(\(e.g.,)f
Fo(echo)664 b(1-310-555-1212)j(>)863 17005 y(/dev/phone-dialer)p
Fn(\).)403 b(Such)298 b(a)e(dri)-28 b(v)-17 b(er)297
b(should)g(be)g(layered)h Fk(on)f(top)f(of)g Fn(the)h(serial)e(port)i
(dri)-28 b(v)-17 b(er)-22 b(\227that)297 b(is,)j(it)295
b(most)h(lik)-11 b(ely)863 18333 y(w)g(ants)277 b(to)g(write)g(to)g
Fo(/dev/ttyS0)p Fn(,)h(not)f(directly)h(to)f(the)g(U)-44
b(AR)-66 b(T)277 b(hardw)-11 b(are)279 b(itself.)2524
20325 y(While)272 b(it)g(is)g(possible)h(to)g(write)f(to)h(a)g(logical)
g(\002le)h(from)e(within)h(a)g(k)-11 b(ernel)273 b(de)-28
b(vice)275 b(dri)-28 b(v)-17 b(er)-44 b(,)274 b(it)e(is)g(both)i(trick)
-17 b(y)273 b(and)h(considered)863 21654 y(bad)438 b(practice.)823
b(In)437 b(the)g(w)-11 b(ords)436 b(of)h(k)-11 b(ernel)437
b(hack)-11 b(er)439 b(Dick)e(Johnson)27919 21252 y Ff(8)28363
21654 y Fn(,)476 b(\223Y)-122 b(ou)439 b(should)e(ne)-28
b(v)-17 b(er)439 b(write)d(a)h([k)-11 b(ernel])437 b(module)h(that)863
22982 y(requires)266 b(reading)i(or)d(writing)h(to)f(an)-17
b(y)268 b(logical)f(de)-28 b(vice.)341 b(The)267 b(k)-11
b(ernel)267 b(is)e(the)h(thing)g(that)g(translates)g(ph)-6
b(ysical)267 b(I/O)f(to)f(logical)i(I/O.)863 24310 y(Attempting)278
b(to)f(perform)g(logical)h(I/O)e(in)h(the)h(k)-11 b(ernel)278
b(is)e(ef)-28 b(fecti)g(v)-17 b(ely)279 b(going)f(backw)-11
b(ards.)-77 b(\224)2524 26303 y(W)-44 b(ith)227 b(FUSD,)j(it')-61
b(s)227 b(possible)h(to)h(layer)g(de)-28 b(vice)230 b(dri)-28
b(v)-17 b(ers)229 b(because)i(the)e(dri)-28 b(v)-17 b(er)229
b(is)e(a)i(user)-22 b(-space)229 b(process,)239 b(not)229
b(a)f(k)-11 b(ernel)230 b(module.)863 27631 y(A)289 b(FUSD)g
(implementation)i(of)d(our)h(h)-6 b(ypothetical)292 b
Fo(/dev/phone-dialer)f Fn(can)f(open)g Fo(/dev/ttyS0)g
Fn(just)e(as)g(an)-17 b(y)290 b(other)863 28960 y(process)278
b(w)-11 b(ould.)2524 30952 y(T)-89 b(ypically)-72 b(,)261
b(such)256 b(layering)g(is)f(accomplished)j(by)d(system)g(daemons.)338
b(F)-17 b(or)256 b(e)-17 b(xample,)262 b(the)255 b Fo(lpd)h
Fn(daemon)h(manages)h(printers)863 32281 y(at)390 b(a)g(high)h(le)-28
b(v)-17 b(el.)683 b(Since)391 b(it)e(is)g(a)h(user)-22
b(-space)391 b(process,)418 b(it)389 b(can)i(access)g(the)f(ph)-6
b(ysical)391 b(printer)f(de)-28 b(vices)392 b(using)e(k)-11
b(ernel)391 b(de)-28 b(vice)863 33609 y(dri)g(v)-17 b(ers)278
b(\(for)e(e)-17 b(xample,)279 b(using)e(printer)g(or)g(netw)-11
b(ork)278 b(dri)-28 b(v)-17 b(ers\).)343 b(There)279
b(a)e(number)h(of)f(adv)-28 b(antages)280 b(to)d(using)h(FUSD)g
(instead:)2524 36487 y Fg(\017)554 b Fn(Using)378 b(FUSD,)g(a)g
(daemon/dri)-28 b(v)-17 b(er)382 b(can)d(create)f(a)h(standard)f(de)-28
b(vice)381 b(\002le)d(which)h(is)e(accessible)i(by)f(an)-17
b(y)380 b(program)f(that)3631 37815 y(kno)-28 b(ws)247
b(ho)-28 b(w)248 b(to)e(use)h(the)g(POSIX)g(system)f(call)h(interf)-11
b(ace.)334 b(Some)247 b(trick)-11 b(ery)247 b(is)f(possible)g(using)h
(named)i(pipes)e(and)g(FIFOs,)3631 39144 y(b)-22 b(ut)277
b(quickly)h(becomes)h(dif)-28 b(\002cult)278 b(because)h(of)e(multiple)
-17 b(x)g(ed)280 b(writes)c(from)g(multiple)i(processes.)2524
41358 y Fg(\017)554 b Fn(FUSD)248 b(dri)-28 b(v)-17 b(ers)248
b(recei)-28 b(v)-17 b(e)249 b(the)f(UID,)f(GID,)g(and)h(process)g(ID)f
(along)i(with)e(e)-28 b(v)-17 b(ery)249 b(\002le)f(operation,)255
b(allo)-28 b(wing)249 b(the)e(same)h(sorts)3631 42686
y(of)301 b(security)i(policies)f(to)g(be)h(implemented)h(as)e(w)-11
b(ould)303 b(be)g(possible)f(with)g(a)g(real)g(k)-11
b(ernel)303 b(dri)-28 b(v)-17 b(er)-61 b(.)420 b(In)302
b(contrast,)308 b(writes)301 b(to)3631 44014 y(a)277
b(named)i(pipe,)e(UDP)-123 b(,)278 b(and)g(so)f(forth)f(are)i(\223anon)
-17 b(ymous.)-77 b(\224)863 47847 y Fj(2.2)1329 b(Use)332
b(of)g(User)-49 b(-Space)331 b(Libraries)863 50587 y
Fn(Since)240 b(a)f(FUSD)h(dri)-28 b(v)-17 b(er)239 b(is)f(just)g(a)h
(re)-17 b(gular)240 b(user)-22 b(-space)239 b(program,)248
b(it)238 b(can)h(naturally)h(use)f(an)-17 b(y)240 b(of)f(the)g
(enormous)h(body)h(of)d(e)-17 b(xisting)863 51915 y(libraries)314
b(that)i(e)-17 b(xist)315 b(for)f(almost)h(an)-17 b(y)317
b(task.)458 b(FUSD)316 b(dri)-28 b(v)-17 b(ers)315 b(can)h(easily)g
(incorporate)h(user)e(interf)-11 b(aces,)324 b(encryption,)j(netw)-11
b(ork)863 53244 y(protocols,)338 b(threads,)g(and)327
b(almost)e(an)-17 b(ything)328 b(else.)488 b(In)326 b(contrast,)337
b(porting)326 b(arbitrary)g(C)f(code)i(into)f(the)g(k)-11
b(ernel)326 b(is)f(dif)-28 b(\002cult)326 b(and)863 54572
y(usually)278 b(a)f(bad)h(idea.)863 58405 y Fj(2.3)1329
b(Dri)-13 b(v)g(er)331 b(Memory)h(Pr)-24 b(otection)863
61145 y Fn(Since)355 b(FUSD)g(dri)-28 b(v)-17 b(ers)354
b(run)g(in)f(their)g(o)-28 b(wn)355 b(process)f(space,)374
b(the)354 b(rest)f(of)g(the)h(system)g(is)e(protected)j(from)f(them.)
573 b(A)354 b(b)-22 b(uggy)355 b(or)863 62473 y(malicious)252
b(FUSD)h(dri)-28 b(v)-17 b(er)-44 b(,)257 b(at)251 b(the)h(v)-17
b(ery)253 b(w)-11 b(orst,)255 b(can)e(only)f(corrupt)g(itself.)334
b(It')-61 b(s)250 b(not)h(possible)h(for)f(it)g(to)g(corrupt)h(the)g(k)
-11 b(ernel,)257 b(other)863 63801 y(FUSD)268 b(dri)-28
b(v)-17 b(ers,)269 b(or)e(e)-28 b(v)-17 b(en)270 b(the)d(processes)h
(that)f(are)g(using)h(its)d(de)-28 b(vices.)342 b(In)267
b(contrast,)i(a)e(b)-22 b(uggy)269 b(k)-11 b(ernel)268
b(module)h(can)f(bring)f(do)-28 b(wn)863 65130 y(an)-17
b(y)279 b(process)e(in)g(the)h(system,)e(or)h(the)g(entire)h(k)-11
b(ernel)278 b(itself.)p 863 66078 20076 45 v 2070 66819
a Fe(8)2457 67131 y Fd(http://www)-58 b(.uwsg.indiana.edu/h)l
(ypermail/linux/k)-9 b(ernel/0005.3/0061.html)25681 74071
y Fn(6)p eop
%%Page: 7 10
7 9 bop 863 2974 a Fj(2.4)1329 b(Gi)-13 b(ving)333 b(libraries)e
(language)h(independence)d(and)i(standard)g(noti\002cation)h
(interfaces)863 5714 y Fn(One)396 b(particularly)g(interesting)f
(application)i(of)e(FUSD)h(that)f(we')-55 b(v)-17 b(e)396
b(found)h(v)-17 b(ery)396 b(useful)f(is)f(as)h(a)g(w)-11
b(ay)396 b(to)f(let)g(re)-17 b(gular)396 b(user)-22 b(-)863
7042 y(space)342 b(libraries)f(e)-17 b(xport)342 b(de)-28
b(vice)343 b(\002le)f(APIs.)534 b(F)-17 b(or)342 b(e)-17
b(xample,)359 b(imagine)343 b(you)f(had)g(a)f(library)g(which)h(f)-11
b(actored)342 b(lar)-20 b(ge)342 b(composite)863 8370
y(numbers.)596 b(T)-89 b(ypically)-72 b(,)384 b(it)360
b(might)i(ha)-22 b(v)-17 b(e)362 b(a)g(C)f(interf)-11
b(ace\227say)-72 b(,)383 b(a)361 b(function)h(called)g
Fo(int)665 b(*factorize\(int)h(bignum\))p Fn(.)863 9699
y(W)-44 b(ith)408 b(FUSD,)h(it')-61 b(s)406 b(possible)j(to)f(create)h
(a)f(de)-28 b(vice)411 b(\002le)d(interf)-11 b(ace\227say)-72
b(,)442 b(a)409 b(de)-28 b(vice)410 b(called)f Fo(/dev/factorize)i
Fn(to)d(which)863 11027 y(clients)277 b(can)h Fo(write\(2\))g
Fn(a)g(big)f(number)-44 b(,)278 b(then)g Fo(read\(2\))g
Fn(back)h(its)c(f)-11 b(actors.)2524 13020 y(This)279
b(may)h(sound)g(strange,)g(b)-22 b(ut)280 b(de)-28 b(vice)281
b(\002le)f(APIs)e(ha)-22 b(v)-17 b(e)281 b(at)e(least)g(three)h(adv)-28
b(antages)282 b(o)-17 b(v)g(er)281 b(a)f(typical)g(library)f(API.)g
(First,)f(it)863 14348 y(becomes)253 b(much)f(more)f(language)i
(independent\227an)-17 b(y)256 b(language)d(that)e(can)g(mak)-11
b(e)252 b(system)f(calls)f(can)i(access)f(the)g(f)-11
b(actorization)863 15676 y(library)-72 b(.)739 b(Second,)444
b(the)409 b(f)-11 b(actorization)410 b(code)h(is)d(running)i(in)f(a)g
(dif)-28 b(ferent)409 b(address)h(space;)476 b(if)408
b(it)g(crashes,)442 b(it)408 b(w)-11 b(on')-20 b(t)409
b(crash)g(or)863 17005 y(corrupt)364 b(the)g(caller)-61
b(.)604 b(Third,)385 b(and)365 b(most)e(interestingly)-72
b(,)385 b(it)363 b(is)g(possible)h(to)f(use)h Fo(select\(2\))h
Fn(to)e(w)-11 b(ait)364 b(for)f(the)h(f)-11 b(actorization)863
18333 y(to)337 b(complete.)526 b Fo(select\(2\))338 b
Fn(w)-11 b(ould)338 b(mak)-11 b(e)339 b(it)d(easy)i(for)e(a)i(client)f
(to)g(f)-11 b(actor)337 b(a)h(lar)-20 b(ge)338 b(number)g(while)g
(remaining)g(responsi)-28 b(v)-17 b(e)863 19661 y(to)329
b Fk(other)h Fn(e)-28 b(v)-17 b(ents)331 b(that)f(might)f(happen)j(in)d
(the)h(meantime.)502 b(In)329 b(other)g(w)-11 b(ords,)343
b(FUSD)330 b(allo)-28 b(ws)329 b(normal)h(user)-22 b(-space)331
b(libraries)d(to)863 20990 y(inte)-17 b(grate)278 b(seamlessly)g(with)e
(UNIX')-61 b(s)277 b(e)-17 b(xisting,)277 b(POSIX-standard)i(e)-28
b(v)-17 b(ent)279 b(noti\002cation)g(interf)-11 b(ace:)344
b Fo(select\(2\))p Fn(.)863 24743 y Fj(2.5)1329 b(De)-20
b(v)-13 b(elopment)331 b(and)g(Deb)-27 b(ugging)332 b(Con)-53
b(v)-13 b(enience)863 27483 y Fn(FUSD)286 b(processes)g(can)g(be)g(de)
-28 b(v)-17 b(eloped)289 b(and)e(deb)-22 b(ugged)288
b(with)d(all)g(the)g(normal)h(user)-22 b(-space)286 b(tools.)368
b(Buggy)287 b(dri)-28 b(v)-17 b(ers)285 b(w)-11 b(on')-20
b(t)286 b(crash)863 28812 y(the)318 b(system,)327 b(b)-22
b(ut)318 b(instead)g(dump)g(cores)g(that)g(can)g(be)g(analyzed.)467
b(All)317 b(of)g(your)h(f)-11 b(a)-22 b(v)g(orite)318
b(visual)f(deb)-22 b(uggers,)330 b(memory)318 b(bounds)863
30140 y(check)-11 b(ers,)420 b(leak)390 b(detectors,)419
b(pro\002lers,)f(and)391 b(other)f(tools)g(can)h(be)f(applied)i(to)e
(FUSD)g(dri)-28 b(v)-17 b(ers)391 b(as)e(the)-17 b(y)391
b(w)-11 b(ould)391 b(to)f(an)-17 b(y)391 b(other)863
31468 y(program.)863 35789 y Fm(3)1594 b(Installing)400
b(FUSD)863 38928 y Fn(This)228 b(section)i(describes)f(the)g
(installation)f(procedure)j(for)d(FUSD.)h(It)f(assumes)g(a)h(good)h(w)
-11 b(orking)229 b(kno)-28 b(wledge)232 b(of)d(Linux)g(system)863
40256 y(administration.)863 44010 y Fj(3.1)1329 b(Pr)-24
b(er)g(equisites)863 46750 y Fn(Before)278 b(installing)f(FUSD,)h(mak)
-11 b(e)278 b(sure)f(you)h(ha)-22 b(v)-17 b(e)279 b(all)e(of)f(the)i
(follo)-28 b(wing)278 b(packages)i(installed)d(and)h(w)-11
b(orking)278 b(correctly:)2524 49410 y Fg(\017)554 b
Fl(Linux)293 b(k)-11 b(er)-17 b(nel)295 b(2.4.0)f(or)f(later)p
Fn(.)391 b(FUSD)294 b(w)-11 b(as)292 b(de)-28 b(v)-17
b(eloped)297 b(under)d(2.4.0)g(and)f(should)h(w)-11 b(ork)293
b(with)g(an)-17 b(y)294 b(k)-11 b(ernel)294 b(in)e(the)i(2.4)3631
50738 y(series.)2524 52777 y Fg(\017)554 b Fl(de)-17
b(vfs)256 b(installed)f(and)h(running)-17 b(.)339 b Fn(FUSD)256
b(dynamically)i(re)-17 b(gisters)255 b(de)-28 b(vices)257
b(using)f(de)-28 b(vfs,)260 b(the)255 b(Linux)i(de)-28
b(vice)258 b(\002lesystem)3631 54105 y(by)388 b(Richard)h(Gooch.)676
b(F)-17 b(or)389 b(FUSD)f(to)g(w)-11 b(ork,)415 b(de)-28
b(vfs)388 b(must)f(be)i(installed)e(and)i(running)g(on)f(your)h
(system.)674 b(F)-17 b(or)389 b(more)3631 55434 y(information)277
b(about)i(de)-28 b(vfs)277 b(installation,)g(see)h(the)f(de)-28
b(vfs)278 b(home)g(page)30782 55032 y Ff(9)31227 55434
y Fn(.)3631 57117 y(Note)295 b(that)g(some)h(distrib)-22
b(utions)294 b(mak)-11 b(e)297 b(installation)e(de)-28
b(vfs)295 b(easier)-61 b(.)398 b(RedHat)296 b(7.1,)k(for)295
b(e)-17 b(xample,)301 b(already)c(has)e(all)g(of)g(the)3631
58445 y(necessary)f(daemons)h(and)f(con\002guration)i(changes)g(inte)
-17 b(grated.)393 b(de)-28 b(vfs)293 b(can)h(be)g(installed)f(simply)g
(by)h(recompiling)h(the)3631 59774 y(k)-11 b(ernel)277
b(with)g(de)-28 b(vfs)278 b(support)g(enabled)h(and)f(recon\002guring)i
(LILO)e(to)e(pass)h Fo("devfs=mount")i Fn(to)e(the)h(k)-11
b(ernel.)863 63527 y Fj(3.2)1329 b(Compiling)332 b(FUSD)f(as)h(a)h(K)
-33 b(er)-20 b(nel)331 b(Module)863 66267 y Fn(Before)312
b(compiling)h(an)-17 b(ything,)322 b(tak)-11 b(e)312
b(a)f(look)h(at)g(the)f(Mak)-11 b(e\002le)313 b(in)e(FUSD')-61
b(s)312 b(home)h(directory)-72 b(.)446 b(Adjust)312 b(an)-17
b(y)312 b(constants)g(that)g(are)863 67596 y(not)368
b(correct.)616 b(In)367 b(particular)-44 b(,)390 b(mak)-11
b(e)369 b(sure)e Fo(KERNEL)p 21778 67596 333 45 v 400
w(HOME)h Fn(correctly)g(re\003ects)g(the)g(place)h(where)g(your)f(k)-11
b(ernel)369 b(sources)f(are)863 68924 y(installed,)277
b(if)f(the)-17 b(y)278 b(aren')-20 b(t)278 b(in)f(the)g(def)-11
b(ault)278 b(location)g(of)f Fo(/usr/src/linux)p Fn(.)p
863 69696 20076 45 v 2070 70437 a Fe(9)2457 70750 y Fd(http://www)-58
b(.atnf.csiro.au/)225 b(r)-16 b(gooch/linux/docs/de)-22
b(vfs.html)25681 74071 y Fn(7)p eop
%%Page: 8 11
8 10 bop 2524 2974 a Fn(Then,)350 b(type)335 b Fo(make)p
Fn(.)516 b(It)334 b(should)h(generate)i(a)d(directory)i(whose)f(name)h
(looks)f(something)h(lik)-11 b(e)334 b Fo(obj.i686-linux)p
Fn(,)351 b(or)863 4302 y(some)278 b(v)-28 b(ariation)278
b(depending)i(on)e(your)g(architecture.)344 b(Inside)277
b(of)g(that)g(directory)h(will)e(be)i(a)f(number)i(of)e(\002les,)f
(including:)2524 7180 y Fg(\017)554 b Fn(kfusd.o)277
b(\226)g(The)h(FUSD)h(k)-11 b(ernel)277 b(module)2524
9394 y Fg(\017)554 b Fn(libfusd.a)277 b(\226)g(The)h(C)f(library)g
(used)h(to)f(talk)g(to)g(the)g(k)-11 b(ernel)278 b(module)2524
11608 y Fg(\017)554 b Fn(Example)278 b(programs)g(\226)f(link)-11
b(ed)278 b(ag)-6 b(ainst)279 b(libfusd.a)2524 14486 y(Compilation)338
b(of)f(the)g(k)-11 b(ernel)338 b(module)g(will)f(f)-11
b(ail)336 b(if)g(the)h(dependencies)k(described)d(in)f(the)g(pre)-28
b(vious)339 b(section)e(are)h(not)f(sat-)863 15815 y(is\002ed.)438
b(The)310 b(module)g(must)f(be)g(compiled)h(ag)-6 b(ain)311
b(Linux)e(k)-11 b(ernel)310 b(must)e(be)h(v2.4.0)h(or)f(later)-44
b(,)315 b(and)310 b(the)f(k)-11 b(ernel)309 b(must)g(ha)-22
b(v)-17 b(e)310 b(de)-28 b(vfs)863 17143 y(support)278
b(enabled.)863 20976 y Fj(3.3)1329 b(T)-122 b(esting)332
b(and)f(T)-98 b(r)-24 b(oubleshooting)863 23716 y Fn(Once)293
b(e)-28 b(v)-17 b(erything)294 b(has)e(been)h(compiled,)k(gi)-28
b(v)-17 b(e)293 b(it)d(a)i(try)f(to)g(see)h(if)e(it)h(actually)i(does)f
(something.)388 b(First,)293 b(use)f Fo(insmod)g Fn(to)g(insert)863
25044 y(the)216 b(FUSD)g(k)-11 b(ernel)217 b(module,)229
b(e.g.)323 b Fo(insmod)665 b(obj.i686-linux/kfusd.o)p
Fn(.)326 b(A)215 b(greeting)i(message)f(similar)f(to)g(\223)p
Fo(fusd:)863 26372 y(starting,)666 b(Revision:)1330 b(1.50)p
Fn(\224)328 b(should)f(appear)i(in)e(the)g(k)-11 b(ernel)327
b(log)h(\(accessed)g(using)f(the)g Fo(dmesg)h Fn(command,)341
b(or)863 27701 y(by)304 b(typing)h Fo(cat)665 b(/proc/kmsg)p
Fn(\).)423 b(Y)-122 b(ou)305 b(can)f(v)-17 b(erify)304
b(the)g(module)h(has)f(been)h(inserted)f(by)g(typing)g
Fo(lsmod)p Fn(,)311 b(or)303 b(alternati)-28 b(v)-17
b(ely)863 29029 y Fo(cat)665 b(/proc/modules)p Fn(.)2524
31021 y(Once)323 b(the)f(module)i(has)e(been)h(inserted)f(successfully)
-72 b(,)334 b(trying)322 b(running)h(the)f Fo(helloworld)i
Fn(e)-17 b(xample)324 b(program.)479 b(When)863 32350
y(run,)335 b(the)323 b(program)i(should)f(print)e(a)i(greeting)g
(message)g(similar)e(to)h Fo(/dev/hello-world)667 b(should)e(now)g
(exist)g(-)863 33678 y(calling)h(fusd)p 8899 33678 333
45 v 399 w(run)p Fn(.)330 b(This)236 b(means)h(e)-28
b(v)-17 b(erything)239 b(is)c(w)-11 b(orking;)251 b(the)237
b(daemon)h(is)e(no)-28 b(w)237 b(block)-11 b(ed,)247
b(w)-11 b(aiting)236 b(for)g(requests)g(to)h(the)863
35006 y(ne)-28 b(w)308 b(de)-28 b(vice.)436 b(From)308
b(another)g(shell,)314 b(type)308 b Fo(cat)665 b(/dev/hello-world)p
Fn(.)436 b(Y)-122 b(ou)308 b(should)g(see)g Fo(Hello,)665
b(world!)434 b Fn(printed)863 36335 y(in)277 b(response.)344
b(T)-39 b(ry)278 b(killing)f(the)g(test)f(program;)i(the)g
(corresponding)h(de)-28 b(vice)279 b(\002le)f(should)g(disappear)-61
b(.)2524 38327 y(If)309 b(nothing)j(seems)f(to)f(be)i(w)-11
b(orking,)320 b(try)310 b(looking)i(at)e(the)h(k)-11
b(ernel)312 b(message)g(log)f(\(type)g Fo(dmesg)g Fn(or)f
Fo(cat)665 b(/proc/kmsg)p Fn(\))863 39656 y(to)317 b(see)h(if)e(there)i
(are)f(an)-17 b(y)319 b(errors.)463 b(If)316 b(nothing)j(seems)f(ob)-17
b(viously)319 b(wrong,)328 b(try)317 b(turning)h(on)g(FUSD)g(k)-11
b(ernel)318 b(module)h(deb)-22 b(ugging)863 40984 y(by)278
b(de\002ning)h Fo(CONFIG)p 10202 40984 V 400 w(FUSD)p
13258 40984 V 399 w(DEBUG)f Fn(in)f(kfusd.c,)g(then)h(recompiling)g
(and)h(reinserting)e(the)g(module.)863 44817 y Fj(3.4)1329
b(Installation)863 47557 y Fn(T)-89 b(yping)236 b Fo(make)665
b(install)236 b Fn(will)d(cop)-11 b(y)236 b(the)e(FUSD)h(library)-72
b(,)243 b(header)236 b(\002les,)242 b(and)236 b(man)f(pages)g(into)f
Fo(/usr/local)p Fn(.)331 b(The)235 b(FUSD)863 48885 y(k)-11
b(ernel)276 b(module)h(is)e Fk(not)g Fn(installed)h(automatically)h
(because)h(of)d(v)-28 b(ariations)276 b(among)h(dif)-28
b(ferent)276 b(Linux)g(distrib)-22 b(utions)275 b(in)g(ho)-28
b(w)277 b(this)863 50213 y(is)219 b(accomplished.)327
b(Y)-122 b(ou)221 b(may)g(w)-11 b(ant)221 b(to)f(arrange)h(to)f(ha)-22
b(v)-17 b(e)222 b(the)e(module)i(start)d(automatically)i(on)g(boot)g
(by)g(\(for)e(e)-17 b(xample\))222 b(cop)-11 b(ying)863
51542 y(it)276 b(into)h Fo(/lib/modules/your-kernel-version)p
Fn(,)283 b(and)278 b(adding)h(it)d(to)h Fo(/etc/modules.conf)p
Fn(.)863 55375 y Fj(3.5)1329 b(Making)332 b(FUSD)f(P)-13
b(art)332 b(of)g(the)g(K)-33 b(er)-20 b(nel)332 b(Pr)-24
b(oper)863 58114 y Fn(The)335 b(earlier)f(instructions,)347
b(by)335 b(def)-11 b(ault,)348 b(create)335 b(a)f(FUSD)h(k)-11
b(ernel)335 b(module.)515 b(If)333 b(desired,)348 b(it')-61
b(s)332 b(also)i(v)-17 b(ery)335 b(easy)g(to)f(b)-22
b(uild)334 b(FUSD)863 59443 y(right)277 b(into)g(the)g(k)-11
b(ernel,)278 b(instead:)2247 62321 y(1.)554 b(Unpack)233
b(the)f(2.4)g(k)-11 b(ernel)233 b(sources)f(and)h(cop)-11
b(y)233 b(all)e(the)h(\002les)g(in)f(the)h Fo(include)g
Fn(and)h Fo(kfusd)f Fn(directories)g(into)g(your)g(k)-11
b(ernel)3631 63649 y(source)262 b(tree,)i(under)e Fo(drivers/char)p
Fn(.)340 b(F)-17 b(or)262 b(e)-17 b(xample,)266 b(if)260
b(FUSD)j(is)d(in)h(your)h(home)h(directory)-72 b(,)264
b(and)f(your)f(k)-11 b(ernel)262 b(is)e(in)3631 64977
y Fo(/usr/src/linux)p Fn(:)8944 67634 y Fo(cp)664 b(\230/fusd/kfusd/*)j
(\230/fusd/include/*)g(/usr/src/linux/drivers/char)2247
70291 y Fn(2.)554 b(Apply)278 b(the)f(patch)h(found)h(in)e(FUSD')-61
b(s)277 b Fo(patches)h Fn(directory)g(to)f(your)h(k)-11
b(ernel)278 b(source)f(tree.)344 b(F)-17 b(or)277 b(e)-17
b(xample:)25681 74071 y(8)p eop
%%Page: 9 12
9 11 bop 8944 2974 a Fo(cd)664 b(/usr/src/linux)8944
4302 y(patch)h(-p0)g(<)f(\230/fusd/patches/fusd-inkernel.patch)3631
6753 y Fn(The)401 b(FUSD)h(in-k)-11 b(ernel)402 b(patch)g(doesn')-20
b(t)401 b(actually)h(change)i(an)-17 b(y)402 b(k)-11
b(ernel)402 b(sources)f(proper;)463 b(it)400 b(just)h(adds)g(FUSD)h(to)
f(the)3631 8082 y(k)-11 b(ernel)277 b(con\002guration)k(menu)d(and)g
(Mak)-11 b(e\002le.)2247 10214 y(3.)554 b(Using)266 b(your)i(k)-11
b(ernel)267 b(con\002gurator)j(of)c(choice)j(\(e.g.)339
b Fo(make)665 b(menuconfig)p Fn(\),)270 b(turn)c(on)i(the)f(FUSD)g
(options.)341 b(It)266 b(will)f(be)3631 11542 y(under)278
b(the)f(\223Character)i(de)-28 b(vices\224)279 b(menu.)2247
13674 y(4.)554 b(Build)277 b(and)h(install)e(the)i(k)-11
b(ernel)278 b(as)f(usual.)863 18037 y Fm(4)1594 b(Basic)399
b(De)-24 b(vice)398 b(Cr)-29 b(eation)863 21175 y Fn(Enough)280
b(introduction\227it')-61 b(s)277 b(time)g(to)g(actually)h(create)g(a)f
(basic)h(de)-28 b(vice)279 b(dri)-28 b(v)-17 b(er)278
b(using)f(FUSD!)2524 23168 y(This)304 b(follo)-28 b(wing)306
b(sections)f(will)f(illustrate)g(v)-28 b(arious)305 b(techniques)i
(using)e(e)-17 b(xample)308 b(programs.)427 b(T)-89 b(o)305
b(sa)-22 b(v)-17 b(e)306 b(space,)313 b(interesting)863
24496 y(e)-17 b(xcerpts)418 b(are)e(sho)-28 b(wn)418
b(instead)e(of)g(entire)h(programs.)761 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)453 b(the)416 b Fo(examples)i Fn(directory)f(of)f(the)g
(FUSD)h(distrib)-22 b(ution)863 25824 y(contains)360
b(all)e(the)h(e)-17 b(xamples)361 b(in)d(their)h(entirety)-72
b(.)588 b(The)-17 b(y)361 b(can)f(actually)f(be)h(compiled)g(and)g(run)
f(on)g(a)g(system)f(with)h(the)g(FUSD)863 27153 y(k)-11
b(ernel)278 b(module)h(installed.)2524 29145 y(Where)362
b(this)f(te)-17 b(xt)363 b(refers)e(to)h(e)-17 b(xample)364
b(program)f(line)f(numbers,)384 b(it)361 b(refers)g(to)h(the)g(line)g
(numbers)h(printed)g(alongside)h(the)863 30474 y(e)-17
b(xcerpts)279 b(in)e(the)g(manual\227not)i(the)f(line)f(numbers)h(of)f
(the)g(actual)h(programs)g(in)f(the)g Fo(examples)h Fn(directory)-72
b(.)863 34269 y Fj(4.1)1329 b(Using)332 b Fc(fusd)p 10700
34269 399 45 v 478 w(register)g Fj(to)h(cr)-24 b(eate)332
b(a)g(new)f(de)-20 b(vice)863 37009 y Fn(W)-89 b(e)367
b(sa)-17 b(w)366 b(an)h(e)-17 b(xample)368 b(of)e(a)g(simple)g(dri)-28
b(v)-17 b(er)-44 b(,)388 b(hello)-28 b(w)-11 b(orld.c,)390
b(in)365 b(Program)i(1)g(on)f(page)i(2.)610 b(Let')-61
b(s)365 b(go)i(back)g(and)g(e)-17 b(xamine)369 b(that)863
38337 y(program)278 b(no)-28 b(w)278 b(in)f(more)h(detail.)2524
40330 y(The)228 b(FUSD)g(ball)g(starts)e(rolling)h(when)i(the)e
Fo(fusd)p 22085 40330 333 45 v 400 w(register)h Fn(function)h(is)d
(called,)238 b(as)227 b(sho)-28 b(wn)229 b(on)f(line)f(40.)328
b(This)227 b(function)863 41658 y(tells)276 b(the)i(FUSD)g(k)-11
b(ernel)278 b(module:)2524 44372 y Fg(\017)554 b Fo(char)664
b(*name)p Fn(\227The)222 b(name)f(of)f(the)g(de)-28 b(vice)222
b(being)f(created.)325 b(The)221 b(pre\002x)g(\(such)f(as)f
Fo(/dev/)p Fn(\))h(must)g(match)h(the)f(location)3631
45700 y(where)349 b(de)-28 b(vfs)350 b(has)f(been)i(mounted.)561
b(Names)350 b(containing)h(slashes)d(\(e.g.,)367 b Fo
(/dev/my-devices/dev1)p Fn(\))352 b(are)d(le)-17 b(g)-6
b(al;)3631 47029 y(de)-28 b(vfs)277 b(creates)h(subdirectories)g
(automatically)-72 b(.)2524 49161 y Fg(\017)554 b Fo(mode)p
6353 49161 V 399 w(t)664 b(mode)p Fn(\227The)284 b(de)-28
b(vice')-61 b(s)284 b(def)-11 b(ault)283 b(permissions.)358
b(This)282 b(is)f(usually)i(speci\002ed)h(using)f(an)g(octal)f
(constant)i(with)e(a)3631 50489 y(leading)c(0\227)p Fo(0666)g
Fn(\(readable)h(and)f(writable)f(by)h(e)-28 b(v)-17 b(eryone\))280
b(instead)d(of)g(the)h(incorrect)g(decimal)g(constant)g
Fo(666)p Fn(.)2524 52621 y Fg(\017)554 b Fo(void)664
b(*device)p 11665 52621 V 400 w(info)p Fn(\227Pri)-28
b(v)g(ate)292 b(data)g(that)e(should)h(be)g(passed)g(to)f(callback)i
(functions)f(for)f(this)g(de)-28 b(vice.)384 b(The)292
b(use)3631 53949 y(of)276 b(this)h(\002eld)h(is)e(described)i(in)f
(Section)i(5.1.)2524 56081 y Fg(\017)554 b Fo(struct)665
b(fusd)p 11002 56081 V 399 w(file)p 14057 56081 V 399
w(operations)h(*fops)p Fn(\227A)286 b(structure)f(containing)j
(pointers)d(to)g(the)h(callback)h(functions)3631 57409
y(that)277 b(should)h(be)f(called)i(by)e(FUSD)h(in)f(response)h(to)f
(certain)h(e)-28 b(v)-17 b(ents.)2524 60123 y(If)228
b(de)-28 b(vice)232 b(re)-17 b(gistration)230 b(is)f(successful,)239
b Fo(fusd)p 20591 60123 V 399 w(register)231 b Fn(returns)e(a)h
Fk(de)-17 b(vice)232 b(handle)p Fn(\227a)g(small)d(inte)-17
b(ger)231 b Fg(\025)307 b Fb(0)p Fn(.)328 b(On)230 b(errors,)863
61451 y(it)305 b(returns)h(-1)f(and)i(sets)e(the)h(global)h(v)-28
b(ariable)308 b Fo(errno)e Fn(appropriately)-72 b(.)432
b(In)305 b(reality)-72 b(,)313 b(the)306 b(de)-28 b(vice)308
b(handle)g(you)f(get)f(is)f(a)h(plain)h(old)863 62780
y(\002le)278 b(descriptor)-44 b(,)276 b(as)h(we')-11
b(ll)277 b(see)g(in)g(Section)i(7.)2524 64772 y(Although)303
b(Program)f(1)g(only)g(calls)f Fo(fusd)p 19296 64772
V 399 w(register)i Fn(once,)308 b(it)301 b(can)h(be)g(called)h
(multiple)e(times)g(if)g(the)g(FUSD)i(dri)-28 b(v)-17
b(er)302 b(is)863 66100 y(handling)279 b(more)f(than)g(one)g(de)-28
b(vice)279 b(as)e(we')-11 b(ll)276 b(see)i(in)f(Program)h(4.)2524
68093 y(There)375 b(is)f(intentional)i(similarity)d(between)j
Fo(fusd)p 23104 68093 V 400 w(register\(\))g Fn(and)f(the)g(k)-11
b(ernel')-61 b(s)375 b(de)-28 b(vice)377 b(re)-17 b(gistration)374
b(functions,)863 69421 y(such)265 b(as)f Fo(devfs)p 7728
69421 V 400 w(register\(\))i Fn(and)f Fo(register)p 22208
69421 V 400 w(chrdev\(\))p Fn(.)340 b(In)264 b(man)-17
b(y)266 b(w)-11 b(ays,)267 b(FUSD')-61 b(s)265 b(interf)-11
b(ace)265 b(is)e(meant)j(to)e(mirror)863 70750 y(the)278
b(k)-11 b(ernel)278 b(interf)-11 b(ace)277 b(as)g(closely)h(as)f
(possible.)25681 74071 y(9)p eop
%%Page: 10 13
10 12 bop 2524 2974 a Fn(The)358 b Fo(fusd)p 7324 2974
333 45 v 400 w(file)p 10380 2974 V 399 w(operations)h
Fn(structure,)378 b(de\002ned)360 b(in)e Fo(fusd.h)p
Fn(,)379 b(contains)359 b(a)f(list)e(of)i(callbacks)h(that)f(are)g
(used)h(in)863 4302 y(response)325 b(to)e(dif)-28 b(ferent)324
b(system)g(calls)f(e)-17 b(x)g(ecuted)327 b(on)e(a)e(\002le.)484
b(It)322 b(is)h(similar)g(to)g(the)h(k)-11 b(ernel')-61
b(s)324 b Fo(file)p 39605 4302 V 399 w(operations)h Fn(structure,)863
5631 y(accepting)g(callbacks)f(for)e(system)g(calls)g(such)h(as)f
Fo(open\(\))p Fn(,)334 b Fo(close\(\))p Fn(,)g Fo(read\(\))p
Fn(,)g Fo(write\(\))p Fn(,)g(and)324 b Fo(ioctl\(\))p
Fn(.)480 b(F)-17 b(or)323 b(the)863 6959 y(most)243 b(part,)250
b(the)244 b(prototypes)h(of)f(FUSD)g(\002le)g(operation)h(callbacks)h
(are)d(the)h(same)h(as)e(their)g(k)-11 b(ernel)245 b(cousins,)250
b(with)244 b(one)g(important)863 8287 y(e)-17 b(xception.)338
b(The)254 b(\002rst)d(ar)-20 b(gument)255 b(of)d(FUSD)i(callbacks)g(is)
e(al)-11 b(w)g(ays)253 b(a)g(pointer)g(to)f(a)h Fo(fusd)p
35757 8287 V 399 w(file)p 38812 8287 V 400 w(info)g Fn(structure;)260
b(it)252 b(contains)863 9616 y(information)322 b(that)g(can)g(be)g
(used)g(to)f(identify)h(the)g(\002le.)476 b(This)321
b(structure)g(is)g(used)h(instead)g(of)f(the)h(k)-11
b(ernel')-61 b(s)321 b Fo(file)h Fn(and)g Fo(inode)863
10944 y Fn(structures,)276 b(and)j(will)d(be)h(described)i(in)e(more)g
(detail)h(later)-61 b(.)2524 12936 y(In)247 b(lines)h(35\22638)i(of)e
(Program)h(1,)254 b(we)248 b(create)h(and)h(initialize)e(a)g
Fo(fusd)p 29219 12936 V 399 w(file)p 32274 12936 V 399
w(operations)i Fn(structure.)333 b(A)248 b(GCC-speci\002c)863
14265 y(C)240 b(e)-17 b(xtension)241 b(allo)-28 b(ws)240
b(us)f(to)h(name)g(structure)g(\002elds)g(e)-17 b(xplicitly)240
b(in)g(the)g(initializer)-61 b(.)330 b(This)239 b(style)h(may)g(look)g
(strange,)248 b(b)-22 b(ut)239 b(it)g(guards)863 15593
y(ag)-6 b(ainst)302 b(errors)d(in)i(the)f(future)h(in)f(case)h(the)g
(order)g(of)f(\002elds)h(in)f(the)h(structure)g(e)-28
b(v)-17 b(er)302 b(changes.)415 b(The)302 b(2.4)e(k)-11
b(ernel)302 b(series)d(uses)i(the)863 16922 y(same)278
b(trick.)2524 18914 y(After)401 b(calling)i Fo(fusd)p
11398 18914 V 399 w(register\(\))g Fn(on)g(line)f(40,)434
b(the)402 b(e)-17 b(xample)405 b(program)e(calls)f Fo(fusd)p
39357 18914 V 399 w(run\(\))g Fn(on)h(line)f(44.)719
b(This)863 20242 y(function)235 b(turns)f(control)g(o)-17
b(v)g(er)235 b(to)f(the)g(FUSD)h(frame)-28 b(w)-11 b(ork.)330
b(fusd)p 25909 20242 V 399 w(run)234 b(blocks)h(the)f(dri)-28
b(v)-17 b(er)234 b(until)g(one)h(of)e(the)i(de)-28 b(vices)235
b(it)e(re)-17 b(gistered)863 21571 y(needs)278 b(to)f(be)h(serviced.)
344 b(Then,)279 b(it)d(calls)h(the)g(appropriate)i(callback)g(and)f
(blocks)g(ag)-6 b(ain)279 b(until)e(the)g(ne)-17 b(xt)278
b(e)-28 b(v)-17 b(ent.)2524 23563 y(No)-28 b(w)-72 b(,)455
b(imagine)420 b(that)f(a)g(user)f(types)i Fo(cat)664
b(/dev/hello-world)p Fn(.)772 b(What)419 b(happens?)771
b(Recall)420 b(\002rst)e(what)i(the)f Fo(cat)863 24892
y Fn(program)283 b(itself)d(does:)353 b(opens)283 b(a)f(\002le,)h
(reads)f(from)f(it)g(until)g(it)g(recei)-28 b(v)-17 b(es)283
b(an)g(EOF)f(\(printing)f(whate)-28 b(v)-17 b(er)285
b(it)280 b(reads)i(to)g(stdout\),)g(then)863 26220 y(closes)296
b(it.)400 b Fo(cat)296 b Fn(w)-11 b(orks)296 b(the)g(same)h(w)-11
b(ay)297 b(re)-17 b(g)-6 b(ardless)297 b(of)f(what)g(it')-61
b(s)295 b(reading\227be)j(it)d(a)h(a)h(FUSD)g(de)-28
b(vice,)302 b(a)297 b(re)-17 b(gular)297 b(\002le,)j(a)d(serial)863
27548 y(port,)277 b(or)g(an)-17 b(ything)279 b(else.)343
b(The)278 b Fo(strace)g Fn(program)g(is)e(a)i(great)f(w)-11
b(ay)278 b(to)f(see)g(this)g(in)f(action;)i(see)g(Appendix)h(A)e(for)g
(details.)863 31381 y Fj(4.2)1329 b(The)331 b Fc(open)h
Fj(and)g Fc(close)g Fj(callbacks)863 34121 y Fn(The)298
b(\002rst)d(tw)-11 b(o)297 b(callbacks)h(that)f(most)f(dri)-28
b(v)-17 b(ers)297 b(typically)h(implement)f(are)g Fo(open)g
Fn(and)h Fo(close)p Fn(.)402 b(Each)298 b(of)f(these)g(tw)-11
b(o)296 b(functions)863 35449 y(are)222 b(passed)h(just)e(one)i(ar)-20
b(gument\227the)224 b Fo(fusd)p 18814 35449 V 399 w(file)p
21869 35449 V 400 w(info)e Fn(structure)g(that)f(describes)i(the)f
(instance)h(of)f(the)g(\002le)g(being)h(opened)863 36778
y(or)277 b(closed.)344 b(Use)277 b(of)g(the)g(information)h(in)f(that)g
(structure)g(will)f(be)i(co)-17 b(v)g(ered)280 b(in)d(more)h(detail)f
(in)g(Section)h(5.)2524 38770 y(The)g(semantics)f(of)g(an)h
Fo(open)f Fn(callback')-61 b(s)279 b(return)e(v)-28 b(alue)278
b(are)g(e)-17 b(xactly)279 b(the)e(same)h(as)e(inside)i(the)f(k)-11
b(ernel:)2524 41648 y Fg(\017)554 b Fn(0)241 b(means)g(success,)249
b(and)242 b(the)f(\002le)g(is)f(opened.)334 b(If)239
b(the)j(\002le)f(is)f(allo)-28 b(wed)242 b(to)f(open,)249
b(the)241 b(k)-11 b(ernel)242 b(returns)f(a)g(v)-28 b(alid)241
b(\002le)h(descriptor)3631 42977 y(to)290 b(the)g(client.)383
b(Using)291 b(that)f(descriptor)-44 b(,)293 b(other)e(callbacks)h(may)f
(be)g(called)g(for)f(that)g(\002le,)k(including)e(\(at)d(least\))h(a)g
Fo(close)3631 44305 y Fn(callback.)2524 46519 y Fg(\017)554
b Fn(A)364 b(ne)-17 b(g)-6 b(ati)-28 b(v)-17 b(e)368
b(number)e(indicates)f(a)g(f)-11 b(ailure,)386 b(and)366
b(that)e(the)h(\002le)g(should)g(not)g(be)g(opened.)609
b(Such)366 b(return)e(v)-28 b(alues)366 b(should)3631
47847 y Fk(always)287 b Fn(be)h(the)g(speci\002ed)h(as)d(a)i(ne)-17
b(g)-6 b(ati)-28 b(v)-17 b(e)290 b Fo(errno)e Fn(v)-28
b(alue)289 b(such)e(as)g Fo(-EPERM)p Fn(,)h Fo(-EBUSY)p
Fn(,)f Fo(-ENODEV)p Fn(,)h Fo(-ENOMEM)p Fn(,)g(and)3631
49176 y(so)416 b(on.)764 b(F)-17 b(or)417 b(e)-17 b(xample,)454
b(if)416 b(the)i(callback)h(returns)d Fo(-EPERM)p Fn(,)i(the)f(caller')
-61 b(s)416 b Fo(open\(\))i Fn(will)e(return)h(-1,)452
b(with)416 b Fo(errno)3631 50504 y Fn(set)367 b(to)g
Fo(EPERM)p Fn(.)h(A)f(complete)j(list)c(of)h(possible)h(return)g(v)-28
b(alues)369 b(can)f(be)h(found)g(in)e(the)h(Linux)h(k)-11
b(ernel)368 b(sources,)391 b(under)3631 51832 y Fo(include/asm/errno.h)
p Fn(.)2524 54710 y(If)267 b(an)j Fo(open)f Fn(callback)i(returns)d(0)h
(\(success\),)h(a)f(dri)-28 b(v)-17 b(er)270 b(is)e Fk(guar)-17
b(anteed)272 b Fn(to)d(recei)-28 b(v)-17 b(e)271 b(e)-17
b(xactly)270 b(one)g Fo(close)g Fn(callback)h(for)d(that)863
56039 y(\002le)d(later)-61 b(.)339 b(By)265 b(the)g(same)g(tok)-11
b(en,)268 b(the)d(close)g(callback)h Fk(will)e(not)h
Fn(be)g(called)g(if)f(the)h(open)h(f)-11 b(ails.)338
b(Therefore,)268 b Fo(open)d Fn(callbacks)h(that)863
57367 y(can)278 b(return)f(f)-11 b(ailure)277 b(must)g(be)h(sure)f(to)g
(deallocate)i(an)-17 b(y)278 b(resources)g(the)-17 b(y)278
b(might)g(ha)-22 b(v)-17 b(e)279 b(allocated)f(before)g(returning)g(a)f
(f)-11 b(ailure.)2524 59360 y(Let')-61 b(s)347 b(return)i(to)f(our)g(e)
-17 b(xample)351 b(in)d(Program)h(1,)366 b(which)349
b(creates)g(the)g Fo(/dev/hello-world)h Fn(de)-28 b(vice.)559
b(If)347 b(a)h(user)h(types)863 60688 y Fo(cat)665 b(/dev/hello-world)p
Fn(,)250 b Fo(cat)241 b Fn(will)f(will)f(use)i(the)g
Fo(open\(2\))h Fn(system)f(call)f(to)h(open)h(the)f(\002le.)332
b(FUSD)241 b(will)f(then)i(proxy)863 62016 y(that)298
b(system)g(call)g(to)f(the)h(dri)-28 b(v)-17 b(er)299
b(and)g(acti)-28 b(v)g(ate)300 b(the)e(callback)i(that)e(w)-11
b(as)298 b(re)-17 b(gistered)298 b(as)g(the)g Fo(open)g
Fn(callback.)408 b(Recall)298 b(from)g(line)863 63345
y(36)278 b(of)f(Program)h(1)f(that)g(we)h(re)-17 b(gistered)277
b Fo(do)p 17888 63345 V 399 w(open)p 20943 63345 V 399
w(or)p 22670 63345 V 399 w(close)p Fn(,)h(which)g(appears)g(on)g(line)f
(8.)2524 65337 y(In)348 b Fo(helloworld.c)p Fn(,)369
b(the)350 b Fo(open)f Fn(callback)i(al)-11 b(w)g(ays)350
b(returns)f(0,)367 b(or)349 b(success.)559 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)370 b(in)349 b(a)g(real)g(dri)-28 b(v)-17
b(er)-44 b(,)368 b(something)863 66666 y(more)346 b(interesting)g(will)
f(probably)i(happen\227permissions)h(checks,)364 b(memory)347
b(allocation)g(for)e(state-k)-11 b(eeping,)365 b(and)346
b(so)g(forth.)863 67994 y(The)315 b(corresponding)i Fk(de)p
Fn(-allocation)f(of)e(those)h(resources)g(should)g(occur)g(in)f(the)h
Fo(close)f Fn(callback,)326 b(which)315 b(is)e(called)i(when)h(a)863
69322 y(user)283 b(application)i(calls)e Fo(close)h Fn(on)g(their)f
(\002le)h(descriptor)-61 b(.)362 b Fo(close)284 b Fn(callbacks)h(are)e
(allo)-28 b(wed)285 b(to)e(return)h(error)e(v)-28 b(alues,)286
b(b)-22 b(ut)284 b(this)863 70651 y(does)278 b(not)f(pre)-28
b(v)-17 b(ent)280 b(the)d(\002le)g(from)g(actually)h(closing.)25405
74071 y(10)p eop
%%Page: 11 14
11 13 bop 863 2974 a Fj(4.3)1329 b(The)331 b Fc(read)h
Fj(callback)863 5714 y Fn(Returning)309 b(to)e(our)g
Fo(cat)665 b(/dev/hello-world)310 b Fn(e)-17 b(xample,)317
b(what)307 b(happens)j(after)c(the)i Fo(open)g Fn(is)e(successful?)434
b(Ne)-17 b(xt,)316 b Fo(cat)863 7042 y Fn(will)345 b(try)g(to)g(use)h
Fo(read\(2\))p Fn(,)364 b(which)346 b(will)f(get)h(proxied)h(by)f(FUSD)
h(to)e(the)h(function)h Fo(do)p 36325 7042 333 45 v 399
w(read)f Fn(on)g(line)g(13.)549 b(This)346 b(function)863
8370 y(tak)-11 b(es)278 b(some)f(additional)i(ar)-20
b(guments)278 b(that)f(we)h(didn')-20 b(t)277 b(see)g(in)g(the)h(open)g
(and)g(close)g(callbacks:)2524 11225 y Fg(\017)554 b
Fo(struct)665 b(fusd)p 11002 11225 V 399 w(file)p 14057
11225 V 399 w(info)g(*file)p Fn(\227The)294 b(\002rst)e(ar)-20
b(gument)294 b(to)e(all)g(callbacks,)297 b(containing)e(information)e
(which)3631 12554 y(describes)277 b(the)h(\002le;)f(see)g(Section)i(5.)
2524 14756 y Fg(\017)554 b Fo(char)664 b(*user)p 10337
14756 V 400 w(buffer)p Fn(\227The)370 b(b)-22 b(uf)-28
b(fer)369 b(that)f(the)g(callback)j(should)e(use)f(to)h(write)e(data)i
(that)g(it)e(is)g(returning)i(to)g(the)3631 16085 y(user)-61
b(.)2524 18287 y Fg(\017)554 b Fo(size)p 6353 18287 V
399 w(t)664 b(user)p 10736 18287 V 399 w(length)p Fn(\227The)294
b(maximum)f(number)g(of)e(bytes)h(requested)h(by)g(the)f(user)-61
b(.)386 b(The)293 b(dri)-28 b(v)-17 b(er)292 b(is)f(allo)-28
b(wed)293 b(to)3631 19616 y(return)277 b(fe)-28 b(wer)277
b(bytes,)g(b)-22 b(ut)278 b(should)g(ne)-28 b(v)-17 b(er)279
b(write)d(more)i(then)g Fo(user)p 29807 19616 V 399 w(length)g
Fn(bytes)f(into)g Fo(user)p 41736 19616 V 399 w(buffer)p
Fn(.)2524 21818 y Fg(\017)554 b Fo(loff)p 6353 21818
V 399 w(t)664 b(*offset)p Fn(\227A)250 b(pointer)f(to)f(an)h(inte)-17
b(ger)249 b(which)h(represents)e(the)h(caller')-61 b(s)248
b(of)-28 b(fset)247 b(into)i(the)g(\002le)f(\(i.e.,)253
b(the)c(user')-61 b(s)3631 23146 y(\002le)305 b(pointer\).)429
b(This)306 b(v)-28 b(alue)307 b(can)g(be)f(modi\002ed)i(by)e(the)g
(callback;)321 b(an)-17 b(y)307 b(change)h(will)d(be)h(propag)-6
b(ated)309 b(back)e(to)f(the)g(user')-61 b(s)3631 24475
y(\002le)277 b(pointer)h(inside)f(the)g(k)-11 b(ernel.)2524
27330 y(The)278 b(semantics)f(of)g(the)g(return)h(v)-28
b(alue)278 b(are)g(the)f(same)h(as)e(if)g(the)i(callback)h(were)e
(being)i(written)e(inside)g(the)g(k)-11 b(ernel)278 b(itself:)2524
30185 y Fg(\017)554 b Fn(Positi)-28 b(v)-17 b(e)248 b(return)g(v)-28
b(alues)249 b(indicate)g(success.)334 b(If)246 b(the)i(call)g(is)e
(successful,)254 b(and)249 b(the)f(dri)-28 b(v)-17 b(er)248
b(has)g(copied)h(data)g(into)e Fo(buffer)p Fn(,)3631
31513 y(the)416 b(return)g(v)-28 b(alue)417 b(indicates)g(ho)-28
b(w)417 b(man)-17 b(y)417 b(bytes)f(were)h(copied.)761
b(This)416 b(number)h(should)f(ne)-28 b(v)-17 b(er)418
b(be)f(greater)f(than)h(the)3631 32842 y Fo(user)p 6353
32842 V 399 w(length)278 b Fn(ar)-20 b(gument.)2524 35044
y Fg(\017)554 b Fn(A)277 b(0)g(return)g(v)-28 b(alue)279
b(indicates)f(EOF)f(has)h(been)g(reached)h(on)f(the)g(\002le.)2524
37247 y Fg(\017)554 b Fn(As)278 b(in)i(the)f Fo(open)h
Fn(and)h Fo(close)f Fn(callbacks,)h(ne)-17 b(g)-6 b(ati)-28
b(v)-17 b(e)283 b(v)-28 b(alues)281 b(\(such)e(as)g(-EPERM,)h(-EPIPE,)g
(or)f(-ENOMEM\))h(indicate)3631 38575 y(errors.)342 b(Such)278
b(v)-28 b(alues)279 b(will)d(cause)i(the)g(user')-61
b(s)276 b Fo(read\(\))i Fn(to)f(return)g(-1)g(with)f(errno)i(set)e
(appropriately)-72 b(.)2524 41430 y(The)332 b(\002rst)f(time)h(a)g
(read)h(is)e(done)i(on)f(a)g(de)-28 b(vice)334 b(\002le,)346
b(the)332 b(user')-61 b(s)331 b(\002le)i(pointer)f(\()p
Fo(*offset)p Fn(\))g(is)f(0.)508 b(In)331 b(the)i(case)f(of)g(this)f
(\002rst)863 42759 y(read,)403 b(a)378 b(greeting)h(message)g(of)e
Fo(Hello,)665 b(world!)646 b Fn(is)377 b(copied)i(back)g(to)f(the)g
(user)-44 b(,)402 b(as)377 b(seen)i(on)f(line)g(24.)645
b(The)379 b(user')-61 b(s)377 b(\002le)863 44087 y(pointer)279
b(is)e(then)h(adv)-28 b(anced.)350 b(The)279 b(ne)-17
b(xt)279 b(read)g(therefore)g(f)-11 b(ails)276 b(the)j(comparison)g(at)
f(line)g(20,)h(f)-11 b(alling)277 b(straight)h(through)h(to)f(return)
863 45415 y(0,)f(or)g(EOF)-89 b(.)2524 47408 y(In)369
b(this)g(simple)g(program,)394 b(we)370 b(also)f(see)h(an)g(e)-17
b(xample)372 b(of)e(an)g(error)f(return)h(on)g(line)f(22:)529
b(if)369 b(the)h(user)f(tries)g(to)g(do)h(a)g(read)863
48736 y(smaller)354 b(than)h(the)g(length)g(of)g(the)f(greeting)i
(message,)374 b(the)355 b(read)g(will)f(f)-11 b(ail)353
b(with)h(-EINV)-149 b(AL.)354 b(\(In)g(an)h(actual)g(dri)-28
b(v)-17 b(er)-44 b(,)374 b(it)354 b(w)-11 b(ould)863
50065 y(normally)323 b(not)g(be)g(an)g(error)f(for)f(a)i(user)f(to)g
(pro)-17 b(vide)324 b(a)f(smaller)f(read)h(b)-22 b(uf)-28
b(fer)322 b(than)h(the)g(size)f(of)g(the)h(a)-22 b(v)-28
b(ailable)324 b(data.)480 b(The)323 b(right)863 51393
y(w)-11 b(ay)246 b(for)f(dri)-28 b(v)-17 b(ers)246 b(to)f(handle)i
(this)d(situation)i(is)e(to)h(return)g(partial)g(data,)253
b(then)246 b(mo)-17 b(v)g(e)247 b Fo(*offset)f Fn(forw)-11
b(ard)246 b(so)f(that)g(the)h(remainder)863 52721 y(is)276
b(returned)i(on)g(the)f(ne)-17 b(xt)279 b Fo(read\(\))p
Fn(.)344 b(W)-89 b(e)277 b(see)h(an)f(e)-17 b(xample)280
b(of)d(this)f(in)h(Program)h(2.\))863 56549 y Fj(4.4)1329
b(The)331 b Fc(write)i Fj(callback)863 59289 y Fn(Program)342
b(1)g(illustrated)e(ho)-28 b(w)343 b(a)e(dri)-28 b(v)-17
b(er)342 b(could)h(return)e(data)h Fk(to)f Fn(a)g(client)h(using)g(the)
f Fo(read)h Fn(callback.)537 b(As)341 b(you)h(might)g(e)-17
b(xpect,)863 60617 y(there)344 b(is)f(a)g(corresponding)j
Fo(write)e Fn(callback)i(that)d(allo)-28 b(ws)344 b(the)g(dri)-28
b(v)-17 b(er)344 b(to)f(recei)-28 b(v)-17 b(e)346 b(data)e
Fk(fr)-50 b(om)344 b Fn(a)f(client.)543 b Fo(write)344
b Fn(tak)-11 b(es)344 b(four)863 61945 y(ar)-20 b(guments,)278
b(similar)e(to)h(the)g Fo(read)h Fn(callback:)2524 65016
y Fg(\017)554 b Fo(struct)665 b(fusd)p 11002 65016 V
399 w(file)p 14057 65016 V 399 w(info)g(*file)p Fn(\227The)294
b(\002rst)e(ar)-20 b(gument)294 b(to)e(all)g(callbacks,)297
b(containing)e(information)e(which)3631 66345 y(describes)277
b(the)h(\002le;)f(see)g(Section)i(5.)2524 68547 y Fg(\017)554
b Fo(const)665 b(char)f(*user)p 14322 68547 V 400 w(buffer)p
Fn(\227Pointer)279 b(to)e(data)g(being)i(written)e(by)g(the)h(client)f
(\(read-only\).)2524 70750 y Fg(\017)554 b Fo(size)p
6353 70750 V 399 w(t)664 b(user)p 10736 70750 V 399 w(length)p
Fn(\227The)279 b(number)g(of)e(bytes)g(pointed)i(to)e(by)g
Fo(user)p 34471 70750 V 400 w(buffer)p Fn(.)25405 74071
y(11)p eop
%%Page: 12 15
12 14 bop 2524 2974 a Fg(\017)554 b Fo(loff)p 6353 2974
333 45 v 399 w(t)664 b(*offset)p Fn(\227A)250 b(pointer)f(to)f(an)h
(inte)-17 b(ger)249 b(which)h(represents)e(the)h(caller')-61
b(s)248 b(of)-28 b(fset)247 b(into)i(the)g(\002le)f(\(i.e.,)253
b(the)c(user')-61 b(s)3631 4302 y(\002le)305 b(pointer\).)429
b(This)306 b(v)-28 b(alue)307 b(can)g(be)f(modi\002ed)i(by)e(the)g
(callback;)321 b(an)-17 b(y)307 b(change)h(will)d(be)h(propag)-6
b(ated)309 b(back)e(to)f(the)g(user')-61 b(s)3631 5631
y(\002le)277 b(pointer)h(inside)f(the)g(k)-11 b(ernel.)2524
8730 y(The)278 b(semantics)f(of)g Fo(write)p Fn(')-61
b(s)277 b(return)g(v)-28 b(alue)279 b(are)e(the)h(same)f(as)g(in)g(a)g
(k)-11 b(ernel)278 b(callback:)2524 11608 y Fg(\017)554
b Fn(Positi)-28 b(v)-17 b(e)321 b(return)f(v)-28 b(alues)321
b(indicate)h(success)e(and)h(indicate)h(ho)-28 b(w)321
b(man)-17 b(y)322 b(bytes)e(of)g(the)g(user')-61 b(s)320
b(b)-22 b(uf)-28 b(fer)320 b(were)h(successfully)3631
12936 y(written)284 b(\(i.e.,)i(successfully)f(processed)h(by)g(the)f
(dri)-28 b(v)-17 b(er)286 b(in)e(some)i(w)-11 b(ay\).)367
b(The)286 b(return)f(v)-28 b(alue)286 b(may)g(be)f(less)f(than)i(or)f
(equal)3631 14265 y(to)276 b(the)i Fo(user)p 9120 14265
V 399 w(length)g Fn(ar)-20 b(gument,)278 b(b)-22 b(ut)278
b(should)g(ne)-28 b(v)-17 b(er)279 b(be)e(greater)-61
b(.)2524 16479 y Fg(\017)554 b Fn(0)277 b(should)h(only)g(be)f
(returned)h(in)f(response)h(to)f(a)h Fo(write)f Fn(of)g(length)h(0.)
2524 18693 y Fg(\017)554 b Fn(Ne)-17 b(g)-6 b(ati)-28
b(v)-17 b(e)406 b(v)-28 b(alues)403 b(\(such)g(as)g(-EPERM,)g(-EPIPE,)g
(or)f(-ENOMEM\))h(indicate)h(errors.)719 b(Such)404 b(v)-28
b(alues)404 b(will)e(cause)i(the)3631 20021 y(user')-61
b(s)276 b Fo(write\(\))i Fn(to)f(return)g(-1)g(with)g(errno)g(set)g
(appropriately)-72 b(.)2524 22899 y(Program)408 b(2,)441
b(echo.c,)h(is)407 b(an)h(e)-17 b(xample)410 b(implementation)g(of)e(a)
g(de)-28 b(vice)410 b(\()p Fo(/dev/echo)p Fn(\))e(that)g(uses)g(both)g
Fo(read\(\))h Fn(and)863 24227 y Fo(write\(\))d Fn(callbacks.)730
b(A)405 b(client)g(that)h(tries)e(to)h Fo(read\(\))h
Fn(from)f(this)f(de)-28 b(vice)407 b(will)e(get)g(the)h(contents)g(of)f
(the)h(most)f(recent)863 25556 y Fo(write\(\))p Fn(.)344
b(F)-17 b(or)278 b(e)-17 b(xample:)863 27935 y Fo(\045)665
b(echo)f(Hello)h(there)g(>)g(/dev/echo)863 29264 y(\045)g(cat)f
(/dev/echo)863 30592 y(Hello)h(there)863 31920 y(\045)g(echo)f(Device)i
(drivers)f(are)g(fun)f(>)h(/dev/echo)863 33249 y(\045)g(cat)f
(/dev/echo)863 34577 y(Device)h(drivers)h(are)e(fun)2524
37435 y Fn(The)260 b(implementation)i(of)d Fo(/dev/echo)i
Fn(k)-11 b(eeps)261 b(a)e(global)i(v)-28 b(ariable,)264
b Fo(data)p Fn(,)g(which)c(serv)-17 b(es)260 b(as)g(a)f(cache)j(for)d
(the)h(data)g(most)863 38763 y(recently)255 b(written)e(to)g(the)h(dri)
-28 b(v)-17 b(er)254 b(by)g(a)f(client)h(program.)336
b(The)255 b(dri)-28 b(v)-17 b(er)254 b(does)g(not)f(assume)h(the)g
(data)g(is)f(null-terminated,)258 b(so)c(it)e(also)863
40092 y(k)-11 b(eeps)278 b(track)g(of)f(the)g(number)i(of)d(bytes)i(of)
f(data)h(a)-22 b(v)-28 b(ailable.)345 b(\(These)278 b(tw)-11
b(o)277 b(v)-28 b(ariables)278 b(appear)h(on)e(lines)g(1\2262.\))2524
42084 y(The)313 b(dri)-28 b(v)-17 b(er')-61 b(s)313 b
Fo(write)g Fn(callback)h(\002rst)e(frees)g(an)-17 b(y)314
b(data)f(which)h(might)e(ha)-22 b(v)-17 b(e)315 b(been)f(allocated)g
(by)f(a)g(pre)-28 b(vious)314 b(call)e(to)h(write)863
43413 y(\(lines)348 b(26\22629\).)558 b(Ne)-17 b(xt,)367
b(on)349 b(line)f(33,)367 b(it)347 b(attempts)i(to)f(allocate)h(ne)-28
b(w)350 b(memory)f(for)f(the)h(ne)-28 b(w)349 b(data)g(arri)-28
b(ving.)558 b(If)347 b(the)h(allocation)863 44741 y(f)-11
b(ails,)377 b Fo(-ENOMEM)360 b Fn(is)d(returned)j(to)e(the)h(client.)
588 b(If)357 b(the)i(allocation)h(is)d(successful,)379
b(the)359 b(dri)-28 b(v)-17 b(er)359 b(copies)g(the)g(data)h(into)e
(its)f(local)863 46069 y(b)-22 b(uf)-28 b(fer)302 b(and)g(stores)e(its)
g(length)j(\(lines)d(37\22638\).)418 b(Finally)-72 b(,)308
b(the)301 b(dri)-28 b(v)-17 b(er)303 b(tells)d(the)h(user)h(that)f(the)
h(entire)f(b)-22 b(uf)-28 b(fer)301 b(w)-11 b(as)302
b(consumed)h(by)863 47398 y(returning)278 b(a)f(v)-28
b(alue)279 b(equal)f(to)f(the)h(number)g(of)f(bytes)g(the)h(user)f
(tried)g(to)g(write)f(\()p Fo(user)p 34362 47398 V 399
w(length)p Fn(\).)2524 49390 y(The)324 b Fo(read)f Fn(callback)i(has)e
(some)h(e)-17 b(xtra)324 b(features)f(that)g(we)h(did)f(not)g(see)h(in)
f(Program)h(1')-61 b(s)322 b Fo(read\(\))i Fn(callback.)483
b(The)324 b(most)863 50719 y(important)387 b(is)e(that)h(it)g(allo)-28
b(ws)386 b(the)h(dri)-28 b(v)-17 b(er)387 b(to)f(read)h(the)f(a)-22
b(v)-28 b(ailable)388 b(data)f Fk(incr)-41 b(ementally)p
Fn(,)415 b(instead)387 b(of)f(requiring)h(that)f(the)h(\002rst)863
52047 y Fo(read\(\))288 b Fn(e)-17 b(x)g(ecuted)291 b(by)d(the)g
(client)f(has)h(enough)h(space)g(for)d(all)h(the)h(data)g(the)g(dri)-28
b(v)-17 b(er)288 b(has)f(a)-22 b(v)-28 b(ailable.)376
b(In)287 b(other)h(w)-11 b(ords,)289 b(a)f(client)863
53375 y(can)278 b(do)g(tw)-11 b(o)277 b(50-byte)i(reads,)e(and)h(e)-17
b(xpect)279 b(the)f(same)f(ef)-28 b(fect)278 b(as)e(if)h(it)f(had)i
(done)h(a)e(single)g(100-byte)i(read.)2524 55368 y(This)334
b(is)g(implemented)j(using)f Fo(*offset)p Fn(,)350 b(the)335
b(user')-61 b(s)334 b(\002le)h(pointer)-61 b(.)518 b(If)334
b(the)h(user)g(is)f(trying)h(to)g(read)h(past)e(the)i(amount)g(of)863
56696 y(data)362 b(we)f(ha)-22 b(v)-17 b(e)362 b(a)-22
b(v)-28 b(ailable,)384 b(the)361 b(dri)-28 b(v)-17 b(er)361
b(returns)g(EOF)g(\(lines)f(8\2269\).)595 b(Normally)-72
b(,)382 b(this)360 b(happens)j(after)d(the)i(client)f(has)g(\002nished)
863 58025 y(reading)g(data.)590 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)381 b(in)359 b(this)f(dri)-28 b(v)-17 b(er)-44
b(,)380 b(it)358 b(might)i(happen)h(on)f(a)f(client')-61
b(s)359 b(\002rst)f(read)i(if)e(nothing)i(has)f(been)i(written)e(to)g
(the)863 59353 y(dri)-28 b(v)-17 b(er)278 b(yet)f(or)g(if)f(the)i(most)
f(recent)h(write')-61 b(s)275 b(memory)k(allocation)f(f)-11
b(ailed.)2524 61345 y(If)258 b(there)j(is)e(data)i(to)e(return,)264
b(the)c(dri)-28 b(v)-17 b(er)261 b(computes)g(the)g(number)g(of)f
(bytes)g(that)g(should)h(be)g(copied)g(back)h(to)e(the)g(client\227the)
863 62674 y(minimum)e(of)f(the)h(number)g(of)f(bytes)h(the)g(user)f
(ask)-11 b(ed)258 b(for)-44 b(,)260 b(and)f(the)e(number)i(of)e(bytes)h
(of)f(data)h(that)f(this)g(client)g(hasn')-20 b(t)258
b(seen)g(yet)863 64002 y(\(line)266 b(12\).)339 b(This)266
b(data)g(is)f(copied)j(back)f(to)f(the)g(user')-61 b(s)265
b(b)-22 b(uf)-28 b(fer)265 b(\(line)h(15\),)i(and)f(the)f(user')-61
b(s)265 b(\002le)h(pointer)g(is)f(adv)-28 b(anced)269
b(accordingly)863 65331 y(\(line)277 b(16\).)343 b(Finally)-72
b(,)278 b(on)g(line)f(19,)g(the)h(client)f(is)f(told)h(ho)-28
b(w)279 b(man)-17 b(y)278 b(bytes)g(were)f(copied)i(to)e(its)f(b)-22
b(uf)-28 b(fer)-61 b(.)25405 74071 y(12)p eop
%%Page: 13 16
13 15 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(2)d Fn(echo.c:)345 b(Using)277 b(both)h Fo(read)g Fn(and)g
Fo(write)f Fn(callbacks)p 863 3445 50191 45 v 365 4367
a Fi(1)1661 b Fo(char)664 b(*data)i(=)e(NULL;)2524 5695
y(int)g(data_length)i(=)f(0;)2524 8352 y(int)f(echo_read\(struct)j
(fusd_file_info)g(*file,)e(char)g(*user_buffer,)365 9680
y Fi(5)10959 b Fo(size_t)665 b(user_length,)i(loff_t)e(*offset\))2524
11009 y({)3852 12337 y(/*)f(if)h(the)g(user)g(has)f(read)h(past)g(the)g
(end)f(of)h(the)g(data,)g(return)g(EOF)g(*/)3852 13665
y(if)f(\(*offset)i(>=)f(data_length\))5180 14994 y(return)h(0;)-133
16322 y Fi(10)3852 17650 y Fo(/*)e(only)h(return)h(as)e(much)h(data)g
(as)f(we)h(have)g(*/)3852 18979 y(user_length)h(=)e(MIN\(user_length,)j
(data_length)g(-)d(*offset\);)3852 21636 y(/*)g(copy)h(data)g(to)g
(user)g(starting)g(from)g(the)g(first)g(byte)g(they)g(haven't)g(seen)g
(*/)-133 22964 y Fi(15)2989 b Fo(memcpy\(user_buffer,)667
b(data)e(+)g(*offset,)g(user_length\);)3852 24292 y(*offset)g(+=)g
(user_length;)3852 26949 y(/*)f(tell)h(them)g(how)g(much)g(data)g(they)
g(got)f(*/)3852 28277 y(return)h(user_length;)-133 29606
y Fi(20)1661 b Fo(})2524 32262 y(ssize_t)665 b(echo_write\(struct)i
(fusd_file_info)g(*file,)e(const)g(char)g(*user_buffer,)15143
33591 y(size_t)g(user_length,)h(loff_t)g(*offset\))2524
34919 y({)-133 36247 y Fi(25)2989 b Fo(/*)664 b(free)h(the)g(old)g
(data,)g(if)f(any)h(*/)3852 37576 y(if)f(\(data)i(!=)e(NULL\))h({)5180
38904 y(free\(data\);)5180 40232 y(data)g(=)g(NULL;)5180
41561 y(data_length)h(=)f(0;)-133 42889 y Fi(30)2989
b Fo(})3852 45546 y(/*)664 b(allocate)i(space)f(for)g(new)g(data;)g
(return)g(error)g(if)f(that)h(fails)g(*/)3852 46874 y(if)f(\(\(data)i
(=)e(malloc\(user_length\)\))k(==)c(NULL\))5180 48203
y(return)i(-ENOMEM;)-133 49531 y Fi(35)3852 50859 y Fo(/*)e(make)h(a)g
(copy)g(of)f(user's)h(data;)g(tell)g(the)g(user)g(we)f(copied)i
(everything)g(*/)3852 52188 y(memcpy\(data,)g(user_buffer,)h
(user_length\);)3852 53516 y(data_length)f(=)e(user_length;)3852
54844 y(return)h(user_length;)-133 56173 y Fi(40)1661
b Fo(})p 863 57667 V 863 60988 a Fj(4.5)1329 b(Unr)-24
b(egistering)331 b(a)i(de)-20 b(vice)331 b(with)h Fc(fusd)p
22940 60988 399 45 v 479 w(unregister\(\))863 63728 y
Fn(All)e(de)-28 b(vices)331 b(re)-17 b(gistered)331 b(by)g(a)f(dri)-28
b(v)-17 b(er)331 b(are)f(unre)-17 b(gistered)332 b(automatically)g
(when)f(the)g(program)g(e)-17 b(xits)330 b(\(or)g(crashes\).)502
b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)863 65056 y(the)409
b Fo(fusd)p 5346 65056 333 45 v 399 w(unregister\(\))h
Fn(function)g(can)f(be)g(used)g(to)g(unre)-17 b(gister)409
b(a)f(de)-28 b(vice)411 b(without)e(terminating)g(the)g(entire)f(dri)
-28 b(v)-17 b(er)-61 b(.)863 66384 y Fo(fusd)p 3585 66384
V 399 w(unregister)279 b Fn(tak)-11 b(es)277 b(one)h(ar)-20
b(gument:)345 b(a)278 b(de)-28 b(vice)279 b(handle)g(\(i.e.,)c(the)j
(return)f(v)-28 b(alue)279 b(from)d Fo(fusd)p 41820 66384
V 400 w(register\(\))p Fn(\).)2524 68377 y(A)217 b(de)-28
b(vice)219 b(can)g(be)f(unre)-17 b(gistered)219 b(at)e(an)-17
b(y)219 b(time.)323 b(An)-17 b(y)219 b(client)f(system)f(calls)g(that)h
(are)f(pending)j(when)f(a)e(de)-28 b(vice)220 b(is)c(unre)-17
b(gistered)863 69705 y(will)276 b(return)h(immediately)i(with)e(an)g
(error)-61 b(.)343 b(In)277 b(this)f(case,)i Fo(errno)g
Fn(will)e(be)h(set)g(to)g Fo(-EPIPE)p Fn(.)25405 74071
y(13)p eop
%%Page: 14 17
14 16 bop 863 2974 a Fm(5)1594 b(Using)399 b(Inf)-40
b(ormation)399 b(in)f Fa(fusd)p 21880 2974 479 45 v 576
w(file)p 26280 2974 V 575 w(info)863 6112 y Fn(W)-89
b(e)232 b(mentioned)i(in)d(the)g(pre)-28 b(vious)233
b(sections)f(that)f(the)h(\002rst)e(ar)-20 b(gument)233
b(to)e(e)-28 b(v)-17 b(ery)233 b(callback)h(is)c(a)i(pointer)f(to)h(a)f
Fo(fusd)p 45008 6112 333 45 v 399 w(file)p 48063 6112
V 400 w(info)863 7440 y Fn(structure.)331 b(This)240
b(structure)g(contains)i(information)f(that)f(can)i(be)f(useful)f(to)g
(dri)-28 b(v)-17 b(er)241 b(implementers)g(in)g(deciding)h(ho)-28
b(w)241 b(to)g(respond)863 8769 y(to)277 b(a)g(system)g(call)g
(request.)2524 10761 y(The)h(\002elds)f(of)g Fo(fusd)p
11118 10761 V 399 w(file)p 14173 10761 V 399 w(info)h
Fn(structures)e(f)-11 b(all)277 b(into)g(se)-28 b(v)-17
b(eral)278 b(cate)-17 b(gories:)2524 13639 y Fg(\017)554
b Fk(Read-only)-61 b(.)345 b Fn(The)278 b(dri)-28 b(v)-17
b(er)278 b(can)g(inspect)g(the)f(v)-28 b(alue,)279 b(b)-22
b(ut)277 b(changing)j(it)c(will)g(ha)-22 b(v)-17 b(e)279
b(no)f(ef)-28 b(fect.)4959 15853 y Fl(\226)554 b Fo(pid)p
8124 15853 V 399 w(t)664 b(pid)p Fn(:)344 b(The)278 b(process)f(ID)g
(of)g(the)g(process)g(making)i(the)f(request)4959 17624
y Fl(\226)554 b Fo(uid)p 8124 17624 V 399 w(t)664 b(uid)p
Fn(:)344 b(The)278 b(user)f(ID)f(of)h(the)g(o)-28 b(wner)279
b(of)e(the)g(process)h(making)g(the)g(request)4959 19396
y Fl(\226)554 b Fo(gid)p 8124 19396 V 399 w(t)664 b(gid)p
Fn(:)344 b(The)278 b(group)g(ID)f(of)f(the)i(o)-28 b(wner)278
b(of)f(the)g(process)h(making)g(the)g(request)2524 21610
y Fg(\017)554 b Fk(Read-write)-17 b(.)332 b Fn(An)-17
b(y)243 b(changes)h(to)d(the)h(v)-28 b(alue)243 b(will)e(be)h(propag)-6
b(ated)245 b(back)e(to)e(the)h(k)-11 b(ernel)242 b(and)h(be)f(written)f
(to)g(the)h(appropriate)3631 22938 y(in-k)-11 b(ernel)277
b(structure.)4959 25152 y Fl(\226)554 b Fo(unsigned)665
b(int)g(flags)p Fn(:)482 b(A)345 b(cop)-11 b(y)348 b(of)d(the)i
Fo(f)p 26137 25152 V 398 w(flags)g Fn(\002eld)f(in)g(the)g(k)-11
b(ernel')-61 b(s)347 b Fo(file)f Fn(structure.)549 b(The)347
b(\003ags)6066 26480 y(are)277 b(an)h(or')-55 b(d-together)278
b(set)e(of)h(the)g(k)-11 b(ernel')-61 b(s)278 b Fo(O)p
23913 26480 V 675 w Fn(series)e(of)h(\003ags:)344 b Fo(O)p
31990 26480 V 399 w(NONBLOCK)p Fn(,)278 b Fo(O)p 38920
26480 V 398 w(APPEND)p Fn(,)g Fo(O)p 44521 26480 V 398
w(SYNC)p Fn(,)g(etc.)4959 28251 y Fl(\226)554 b Fo(void)665
b(*device)p 14101 28251 V 399 w(info)p Fn(:)409 b(The)311
b(data)f(passed)g(to)g Fo(fusd)p 29144 28251 V 399 w(register)h
Fn(when)f(the)g(de)-28 b(vice)312 b(w)-11 b(as)309 b(re)-17
b(gistered;)327 b(see)6066 29580 y(Section)278 b(5.1)g(for)e(details)
4959 31351 y Fl(\226)554 b Fo(void)665 b(*private)p 14765
31351 V 400 w(data)p Fn(:)423 b(A)316 b(generic)i(per)-22
b(-\002le-descriptor)318 b(pointer)f(usable)h(by)f(the)g(dri)-28
b(v)-17 b(er)318 b(for)e(its)f(o)-28 b(wn)318 b(pur)-22
b(-)6066 32679 y(poses,)383 b(such)363 b(as)f(to)g(k)-11
b(eep)363 b(state)f(\(or)f(a)h(pointer)h(to)f(state\))f(that)h(should)h
(be)g(maintained)h(between)g(operations)f(on)6066 34007
y(the)395 b(same)g(instance)h(of)e(an)i(open)g(\002le.)696
b(It)394 b(is)g(guaranteed)j(to)e(be)g(NULL)h(when)g(the)f(\002le)g(is)
e(\002rst)h(opened.)699 b(See)6066 35336 y(Section)278
b(5.2)g(for)e(more)i(details.)2524 37550 y Fg(\017)554
b Fk(Hidden)299 b(\002elds.)406 b Fn(The)299 b(dri)-28
b(v)-17 b(er)299 b(should)f(not)h(touch)g(these)f(\002elds)h(\(such)f
(as)f Fo(fd)p Fn(\).)406 b(The)-17 b(y)300 b(contain)f(state)f(used)g
(by)h(the)f(FUSD)3631 38878 y(library)276 b(to)h(generate)i(the)f
(reply)f(sent)g(to)g(the)h(k)-11 b(ernel.)2524 41756
y Fl(Important)273 b(note:)342 b Fn(the)272 b(v)-28 b(alue)275
b(of)d(the)h Fo(fusd)p 20262 41756 V 399 w(file)p 23317
41756 V 399 w(info)g Fn(pointer)g(itself)e(has)i Fk(no)g(meaning)p
Fn(.)344 b(Repeated)275 b(requests)d(on)i(the)863 43085
y(same)287 b(\002le)g(descriptor)f Fk(will)g(not)h Fn(generate)h
(callbacks)g(with)e(identical)h Fo(fusd)p 31000 43085
V 400 w(file)p 34056 43085 V 399 w(info)f Fn(pointer)h(v)-28
b(alues,)290 b(as)c(w)-11 b(ould)288 b(be)f(the)863 44413
y(case)281 b(with)e(an)h(in-k)-11 b(ernel)281 b(dri)-28
b(v)-17 b(er)-61 b(.)352 b(In)279 b(other)h(w)-11 b(ords,)280
b(if)f(a)h(dri)-28 b(v)-17 b(er)280 b(needs)h(to)e(k)-11
b(eep)282 b(state)d(in)g(between)j(successi)-28 b(v)-17
b(e)282 b(system)d(calls)g(on)863 45741 y(a)333 b(user')-61
b(s)331 b(\002le)i(descriptor)-44 b(,)345 b(it)332 b
Fk(must)g Fn(store)g(that)g(state)g(using)g(the)h Fo(private)p
30689 45741 V 400 w(data)f Fn(\002eld.)510 b(The)333
b Fo(fusd)p 41540 45741 V 399 w(file)p 44595 45741 V
400 w(info)f Fn(pointer)863 47070 y(itself)276 b(is)g(ephemeral;)j(the)
e(data)h(to)f(which)h(it)e(points)i(is)e(persistent.)2524
49062 y(Program)282 b(3)f(sho)-28 b(ws)282 b(an)g(e)-17
b(xample)284 b(of)d(ho)-28 b(w)283 b(a)e(dri)-28 b(v)-17
b(er)282 b(might)g(mak)-11 b(e)283 b(use)e(of)g(the)h(data)g(in)f(the)h
Fo(fusd)p 40577 49062 V 399 w(file)p 43632 49062 V 400
w(info)f Fn(structure.)863 50390 y(Much)333 b(of)f(the)g(dri)-28
b(v)-17 b(er)333 b(is)d(identical)j(to)f(hello)-28 b(w)-11
b(orld.c.)509 b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)348
b(instead)332 b(of)g(printing)g(a)g(static)f(greeting,)347
b(this)331 b(ne)-28 b(w)333 b(program)863 51719 y(generates)273
b(a)f(custom)g(message)h(each)g(time)e(the)h(de)-28 b(vice)273
b(\002le)f(is)f(read,)i(as)e(seen)h(on)h(line)e(25.)342
b(The)273 b(message)f(contains)h(the)f(PID)f(of)863 53047
y(the)278 b(user)e(process)i(that)f(requested)i(the)e(read)h(\()p
Fo(file->pid)p Fn(\).)2524 55040 y(In)360 b(addition,)383
b(Program)362 b(3')-61 b(s)360 b Fo(open)i Fn(callback)g(does)g(not)f
(return)g(0)g(\(success\))g(unconditionally)j(as)c(it)g(did)h(in)g
(Program)h(1.)863 56368 y(Instead,)339 b(it)326 b(checks)i(\(on)e(line)
h(7\))f(to)g(mak)-11 b(e)328 b(sure)e(the)h(UID)f(of)g(the)h(process)f
(trying)h(to)f(read)h(from)f(the)h(de)-28 b(vice)328
b(\()p Fo(file->uid)p Fn(\))863 57696 y(matches)271 b(the)f(UID)g
(under)h(which)g(the)f(dri)-28 b(v)-17 b(er)270 b(itself)f(is)f
(running)k(\()p Fo(getuid\(\))p Fn(\).)341 b(If)268 b(the)-17
b(y)271 b(don')-20 b(t)271 b(match,)h(-EPERM)e(is)f(returned.)863
59025 y(In)354 b(other)g(w)-11 b(ords,)373 b(only)355
b(the)f(user)g(who)h(ran)f(the)g(dri)-28 b(v)-17 b(er)355
b(is)e(allo)-28 b(wed)355 b(to)f(read)h(from)e(the)i(de)-28
b(vice)356 b(that)e(it)f(creates.)574 b(If)353 b(an)-17
b(y)355 b(other)863 60353 y(user)-22 b(\227including)279
b(root!\227tries)d(to)h(open)h(it,)e(a)h(\223Permission)h(denied\224)h
(error)e(will)f(be)i(generated.)863 64186 y Fj(5.1)1329
b(Registration)333 b(of)f(Multiple)g(De)-20 b(vices,)332
b(and)g(P)-13 b(assing)331 b(Data)h(to)h(Callbacks)863
66926 y Fn(De)-28 b(vice)264 b(dri)-28 b(v)-17 b(ers)263
b(frequently)g(e)-17 b(xpose)264 b(se)-28 b(v)-17 b(eral)264
b(dif)-28 b(ferent)262 b(\223\003a)-22 b(v)g(ors\224)264
b(of)e(a)g(de)-28 b(vice.)340 b(F)-17 b(or)263 b(e)-17
b(xample,)267 b(a)c(single)f(magnetic)i(tape)f(dri)-28
b(v)-17 b(e)863 68254 y(will)256 b(often)i(ha)-22 b(v)-17
b(e)259 b(man)-17 b(y)259 b(dif)-28 b(ferent)257 b(de)-28
b(vice)259 b(\002les)f(in)f Fo(/dev)p Fn(.)336 b(Each)259
b(de)-28 b(vice)259 b(\002le)f(represents)f(a)g(dif)-28
b(ferent)258 b(combination)h(of)e(options)863 69582 y(such)278
b(as)f(re)-28 b(wind/no-re)g(wind,)279 b(or)e(compressed/uncompressed.)
347 b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)280 b(the)-17
b(y)278 b(access)g(the)f(same)h(ph)-6 b(ysical)278 b(tape)g(dri)-28
b(v)-17 b(e.)25405 74071 y(14)p eop
%%Page: 15 18
15 17 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(3)d Fn(uid-\002lter)-61 b(.c:)344 b(Inspecting)278
b(data)g(in)f Fo(fusd)p 22294 2940 333 45 v 399 w(file)p
25349 2940 V 399 w(info)h Fn(such)f(as)g(UID)g(and)h(PID)f(of)g(the)g
(calling)h(process)p 863 3445 50191 45 v 365 4400 a Fi(1)1661
b Fo(int)664 b(do_open\(struct)j(fusd_file_info)g(*file\))2524
5728 y({)3852 7057 y(/*)d(If)h(the)g(UID)f(of)h(the)g(process)g(trying)
g(to)g(do)f(the)h(read)g(doesn't)g(match)g(the)4516 8385
y(*)f(UID)h(of)g(the)f(owner)h(of)g(the)g(driver,)g(return)g(-EPERM.)
1330 b(If)664 b(you)h(run)g(this)365 9714 y Fi(5)3653
b Fo(*)664 b(driver)i(as)e(a)h(normal)g(user,)g(even)g(root)g(won't)g
(be)f(able)h(to)g(read)g(from)f(the)4516 11042 y(*)g(device)i(file)f
(created!)g(*/)3852 12370 y(if)f(\(file->uid)i(!=)f(getuid\(\)\))5180
13699 y(return)h(-EPERM;)-133 16355 y Fi(10)2989 b Fo(return)665
b(0;)2524 17684 y(})2524 20340 y(int)f(do_read\(struct)j
(fusd_file_info)g(*file,)e(char)g(*user_buffer,)10494
21669 y(size_t)g(user_length,)h(loff_t)f(*offset\))-133
22997 y Fi(15)1661 b Fo({)3852 24325 y(char)665 b(buf[128];)3852
25654 y(int)g(len;)3852 28310 y(/*)f(The)h(first)g(read)g(to)g(the)f
(device)i(returns)f(a)f(greeting.)1330 b(The)665 b(second)g(read)-133
29639 y Fi(20)3653 b Fo(*)664 b(returns)i(EOF.)f(*/)3852
30967 y(if)f(\(*offset)i(!=)f(0\))5180 32296 y(return)h(0;)3852
34952 y(/*)e(len)h(gets)g(set)g(to)f(the)h(number)g(of)g(characters)h
(written)f(to)g(buf)f(*/)-133 36281 y Fi(25)2989 b Fo(len)665
b(=)f(sprintf\(buf,)i("Your)f(PID)g(is)g(\045d.)1328
b(Have)665 b(a)g(nice)g(day.\\n",)g(file->pid\);)3852
38937 y(/*)f(NEVER)i(return)f(more)g(data)g(than)f(the)h(user)g(asked)g
(for)g(*/)3852 40266 y(if)f(\(user_length)j(<)d(len\))5180
41594 y(len)h(=)f(user_length;)-133 42922 y Fi(30)3852
44251 y Fo(memcpy\(user_buffer,)j(buf,)e(len\);)3852
45579 y(*offset)g(+=)g(len;)3852 46907 y(return)g(len;)2524
48236 y(})p 863 49730 V 2524 53051 a Fn(T)-39 b(raditionally)-72
b(,)252 b(the)246 b(de)-28 b(vice)247 b(\002le')-61 b(s)245
b Fk(minor)h(number)g Fn(w)-11 b(as)245 b(used)h(to)f(communicate)j
(the)e(desired)g(options)f(with)g(de)-28 b(vice)248 b(dri)-28
b(v)-17 b(ers.)863 54379 y(But,)367 b(since)350 b(de)-28
b(vfs)350 b(dynamically)i(\(and)e(unpredictably\))i(generates)e(both)g
(major)g(and)g(minor)g(numbers)g(e)-28 b(v)-17 b(ery)351
b(time)e(a)h(de)-28 b(vice)863 55708 y(is)298 b(re)-17
b(gistered,)305 b(a)299 b(dif)-28 b(ferent)300 b(technique)h(w)-11
b(as)299 b(de)-28 b(v)-17 b(eloped.)413 b(When)300 b(using)g(de)-28
b(vfs,)305 b(dri)-28 b(v)-17 b(ers)299 b(are)g(allo)-28
b(wed)301 b(to)e(associate)h(a)f(v)-28 b(alue)301 b(\(of)863
57036 y(type)278 b Fo(void)665 b(*)p Fn(\))276 b(with)h(each)i(de)-28
b(vice)279 b(the)-17 b(y)279 b(re)-17 b(gister)-61 b(.)343
b(This)277 b(f)-11 b(acility)276 b(tak)-11 b(es)278 b(the)f(place)h(of)
f(the)h(minor)f(number)-61 b(.)2524 59029 y(The)302 b(de)-28
b(vfs)302 b(solution)g(is)f(also)g(used)i(by)f(FUSD.)g(The)h
(mysterious)e(third)g(ar)-20 b(gument)304 b(to)d Fo(fusd)p
39277 59029 333 45 v 399 w(register)i Fn(that)f(we)f(men-)863
60357 y(tioned)309 b(in)g(Section)g(4.1)g(is)e(an)i(arbitrary)f(piece)i
(of)e(data)h(that)f(can)i(be)f(passed)g(to)f(FUSD)h(when)h(a)e(de)-28
b(vice)310 b(is)e(re)-17 b(gistered.)437 b(Later)-44
b(,)863 61685 y(when)378 b(a)e(callback)j(is)c(acti)-28
b(v)g(ated,)403 b(the)377 b(contents)g(of)g(that)f(ar)-20
b(gument)378 b(are)f(a)-22 b(v)-28 b(ailable)378 b(in)e(the)h
Fo(device)p 41033 61685 V 399 w(info)g Fn(member)g(of)g(the)863
63014 y Fo(fusd)p 3585 63014 V 399 w(file)p 6640 63014
V 400 w(info)277 b Fn(structure.)2524 65006 y(Program)213
b(4)f(sho)-28 b(ws)212 b(an)h(e)-17 b(xample)215 b(of)c(this)h
(technique,)227 b(inspired)212 b(by)h(Alessandro)g(Rubini')-61
b(s)212 b(similar)f(de)-28 b(vfs)213 b(tutorial)e(published)863
66335 y(in)321 b(Linux)h(Mag)-6 b(azine)9366 65933 y
Ff(10)10199 66335 y Fn(.)475 b(It)320 b(creates)h(a)g(number)i(of)d(de)
-28 b(vices)323 b(in)e(the)g Fo(/dev/drums)h Fn(directory)-72
b(,)333 b(each)322 b(of)f(which)h(is)e(useful)h(for)863
67663 y(generating)345 b(a)e(dif)-28 b(ferent)343 b(kind)g(of)f
(\223sound\224\227)p Fo(/dev/drums/bam)p Fn(,)364 b Fo(/dev/drums/boom)
p Fn(,)d(and)344 b(so)e(on.)541 b(Reading)344 b(from)p
863 68611 20076 45 v 1738 69352 a Fe(10)2457 69664 y
Fd(http://www)-58 b(.linux.it/k)-9 b(erneldocs/de)-22
b(vfs/)25405 74071 y Fn(15)p eop
%%Page: 16 19
16 18 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(4)d Fn(drums.c:)344 b(P)-17 b(assing)277 b(pri)-28
b(v)g(ate)279 b(data)f(to)f Fo(fusd)p 23298 2940 333
45 v 399 w(register)h Fn(and)g(retrie)-28 b(ving)278
b(it)e(from)h Fo(device)p 43020 2940 V 400 w(info)p 863
3445 50191 45 v 365 4400 a Fi(1)1661 b Fo(static)665
b(char)g(*drums_strings[])i(=)d({"bam",)h("bum",)h("beat",)f("boom",)
23777 5728 y("bang",)h("crash",)f(NULL};)2524 8385 y(int)f
(drums_read\(struct)j(fusd_file_info)g(*file,)e(char)g(*user_buffer,)
365 9714 y Fi(5)11623 b Fo(size_t)665 b(user_length,)i(loff_t)e
(*offset\))2524 11042 y({)3852 12370 y(int)g(len;)3852
13699 y(char)g(sound[128];)-133 16355 y Fi(10)2989 b
Fo(/*)664 b(file->device_info)k(is)c(what)h(we)g(passed)g(to)f
(fusd_register)j(when)e(we)4516 17684 y(*)f(registered)i(the)f(device)g
(*/)3852 19012 y(strcpy\(sound,)h(\(char)f(*\))g(file->device_info\);)
3852 20340 y(strcat\(sound,)h("\\n"\);)-133 22997 y Fi(15)2989
b Fo(/*)664 b(1st)h(read)g(returns)g(the)g(sound;)g(2nd)g(returns)h
(EOF)e(*/)3852 24325 y(if)g(\(*offset)i(!=)f(0\))5180
25654 y(return)h(0;)3852 28310 y(/*)e(NEVER)i(return)f(more)g(data)g
(than)f(the)h(user)g(asked)g(for)g(*/)-133 29639 y Fi(20)2989
b Fo(len)665 b(=)f(MIN\(user_length,)j(strlen\(sound\)\);)3852
30967 y(memcpy\(user_buffer,)g(sound,)f(len\);)3852 32296
y(*offset)f(+=)g(len;)3852 33624 y(return)g(len;)2524
34952 y(})-133 36281 y Fi(25)2524 37609 y Fo(int)f(main\(int)i(argc,)f
(char)g(*argv[]\))2524 38937 y({)3852 40266 y(int)g(i;)3852
41594 y(char)g(buf[128];)-133 42922 y Fi(30)3852 44251
y Fo(for)g(\(i)f(=)h(0;)f(drums_strings[i])j(!=)e(NULL;)g(i++\))g({)
5180 45579 y(sprintf\(buf,)i("/dev/drums/\045s",)g(drums_strings[i]\);)
5180 46907 y(if)e(\(fusd_register\(buf,)i(0666,)e(drums_strings[i],)j
(&drums_fops\))e(<)e(0\))6509 48236 y(fprintf\(stderr,)i("\045s)f
(register)h(failed:)f(\045m\\n",)g(drums_strings[i]\);)-133
49564 y Fi(35)2989 b Fo(})3852 52221 y(fprintf\(stderr,)667
b("calling)e(fusd_run...\\n"\);)3852 53549 y(fusd_run\(\);)3852
54878 y(return)g(0;)-133 56206 y Fi(40)1661 b Fo(})p
863 57700 V 863 61021 a Fn(an)-17 b(y)279 b(of)e(these)g(de)-28
b(vices)279 b(will)d(return)h(a)g(string)g(equal)h(to)f(the)g(de)-28
b(vice')-61 b(s)279 b(name.)2524 63014 y(The)313 b(\002rst)f(thing)i
(to)f(notice)g(about)i Fo(drums.c)e Fn(is)f(that)h(it)f(re)-17
b(gisters)312 b(more)i(than)f(one)h(FUSD)g(de)-28 b(vice.)453
b(In)313 b(the)g(loop)g(starting)863 64342 y(in)407 b(line)g(31,)440
b(it)406 b(calls)h Fo(fusd)p 12201 64342 333 45 v 399
w(register\(\))h Fn(once)h(for)d(e)-28 b(v)-17 b(ery)409
b(de)-28 b(vice)409 b(named)g(in)e Fo(drums)p 37877 64342
V 399 w(strings)h Fn(on)g(line)f(1.)733 b(When)863 65670
y Fo(fusd)p 3585 65670 V 399 w(run\(\))371 b Fn(is)e(called,)393
b(it)369 b(automatically)j(w)-11 b(atches)371 b(e)-28
b(v)-17 b(ery)372 b(de)-28 b(vice)372 b(the)e(dri)-28
b(v)-17 b(er)370 b(re)-17 b(gistered,)394 b(and)371 b(acti)-28
b(v)g(ates)371 b(the)f(callbacks)863 66999 y(associated)376
b(with)f(each)i(de)-28 b(vice)377 b(as)e(needed.)639
b(Although)377 b Fo(drums.c)f Fn(uses)f(the)g(same)h(set)e(of)h
(callbacks)h(for)f(e)-28 b(v)-17 b(ery)377 b(de)-28 b(vice)377
b(it)863 68327 y(re)-17 b(gisters)387 b(\(as)f(can)i(be)g(seen)g(on)g
(line)f(33\),)414 b(each)389 b(de)-28 b(vice)389 b(could)g(ha)-22
b(v)-17 b(e)389 b(dif)-28 b(ferent)387 b(callbacks)h(if)f(desired.)673
b(\(Not)387 b(sho)-28 b(wn)389 b(is)d(the)863 69655 y(initialization)
278 b(of)e Fo(drums)p 11321 69655 V 400 w(fops)p Fn(,)h(which)h
(assigns)f Fo(drums)p 24708 69655 V 399 w(read)h Fn(to)f(be)g(the)h
Fo(read)f Fn(callback.\))25405 74071 y(16)p eop
%%Page: 17 20
17 19 bop 2524 2974 a Fn(If)239 b Fo(drums)p 6887 2974
333 45 v 400 w(read)i Fn(is)f(called)i(for)f(all)f(6)h(types)h(of)f
(drums,)248 b(ho)-28 b(w)242 b(does)g(it)e(kno)-28 b(w)242
b(which)g(de)-28 b(vice)243 b(it')-61 b(s)240 b(supposed)j(to)e(be)g
(servicing)863 4302 y(when)220 b(it)e(gets)g(called?)326
b(The)219 b(answer)g(is)f(in)g(the)h(third)f(ar)-20 b(gument)221
b(of)d Fo(fusd)p 29223 4302 V 399 w(register\(\))p Fn(,)231
b(which)220 b(we)f(were)g(pre)-28 b(viously)220 b(ignor)-22
b(-)863 5631 y(ing.)371 b(Whate)-28 b(v)-17 b(er)288
b(v)-28 b(alue)288 b(is)d(passed)i(to)f Fo(fusd)p 18255
5631 V 399 w(register\(\))i Fn(will)d(be)i(passed)g(back)h(to)e(the)g
(callback)i(in)e(the)h Fo(device)p 48063 5631 V 400 w(info)863
6959 y Fn(\002eld)267 b(of)e(the)h Fo(fusd)p 8624 6959
V 399 w(file)p 11679 6959 V 400 w(info)g Fn(structure.)339
b(The)267 b(name)f(of)g(the)g(drum)g(sound)h(is)e(passed)h(to)g
Fo(fusd)p 40460 6959 V 399 w(register)h Fn(on)f(line)g(33,)863
8287 y(and)278 b(later)f(retrie)-28 b(v)-17 b(ed)279
b(by)e(the)h(dri)-28 b(v)-17 b(er)278 b(on)f(line)g(12.)2524
10280 y(Although)406 b(this)e(e)-17 b(xample)407 b(uses)e(a)g(string)f
(as)h(its)e Fo(device)p 26212 10280 V 400 w(info)p Fn(,)437
b(the)405 b(pointer)h(can)g(be)f(used)h(for)e(an)-17
b(ything\227a)408 b(mode)863 11608 y(number)-44 b(,)278
b(a)f(pointer)h(to)f(a)g(con\002guration)j(structure,)d(and)h(so)f(on.)
863 15441 y Fj(5.2)1329 b(The)331 b(differ)-24 b(ence)332
b(between)e Fc(device)p 22228 15441 399 45 v 479 w(info)i
Fj(and)f Fc(private)p 34279 15441 V 479 w(data)863 18181
y Fn(As)310 b(we)g(mentioned)i(in)e(Section)h(5,)318
b(the)310 b Fo(fusd)p 19319 18181 333 45 v 399 w(file)p
22374 18181 V 400 w(info)g Fn(structure)g(has)g(tw)-11
b(o)310 b(seemingly)h(similar)d(\002elds,)319 b(both)310
b(of)g(which)863 19509 y(can)433 b(be)f(used)h(by)f(dri)-28
b(v)-17 b(ers)432 b(to)g(store)f(their)g(o)-28 b(wn)433
b(data:)653 b Fo(device)p 27267 19509 V 400 w(info)432
b Fn(and)h Fo(private)p 37433 19509 V 400 w(data)p Fn(.)807
b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)472 b(there)433 b(is)d(an)863
20837 y(important)278 b(dif)-28 b(ference)278 b(between)h(them:)2524
23937 y Fg(\017)554 b Fo(private)p 8345 23937 V 399 w(data)315
b Fn(is)e(stored)i Fk(per)f(\002le)h(descriptor)p Fn(.)456
b(If)313 b(20)i(processes)g(open)h(a)e(FUSD)h(de)-28
b(vice)317 b(\(or)-44 b(,)323 b(one)315 b(process)g(opens)3631
25265 y(a)350 b(FUSD)i(de)-28 b(vice)353 b(20)e(times\),)368
b(each)353 b(of)d(those)h(20)h(\002le)f(descriptors)f(will)g(ha)-22
b(v)-17 b(e)353 b(their)d(o)-28 b(wn)352 b(cop)-11 b(y)352
b(of)f Fo(private)p 48063 25265 V 400 w(data)3631 26594
y Fn(associated)260 b(with)g(them.)338 b(This)259 b(\002eld)h(is)f
(therefore)h(useful)f(to)h(dri)-28 b(v)-17 b(ers)260
b(that)f(need)i(to)f(dif)-28 b(ferentiate)260 b(multiple)g(requests)f
(to)h(a)3631 27922 y(single)303 b(de)-28 b(vice)306 b(that)e(might)g
(be)g(serviced)h(in)e(parallel.)423 b(\(Note)304 b(that)g(most)f(UNIX)h
(v)-28 b(ariants,)310 b(including)c(Linux,)311 b(do)304
b(allo)-28 b(w)3631 29250 y(multiple)306 b(processes)h(to)f(share)h(a)f
(single)g(\002le)h(descriptor)-22 b(\227speci\002cally)-72
b(,)316 b(if)305 b(a)h(process)h Fo(open)p Fn(s)f(a)h(\002le,)313
b(then)307 b Fo(fork)p Fn(s.)431 b(In)3631 30579 y(this)276
b(case,)h(processes)h(will)e(also)h(share)g(a)h(single)f(cop)-11
b(y)278 b(of)f Fo(private)p 31175 30579 V 400 w(data)p
Fn(.\))3631 32350 y(The)331 b(\002rst)f(time)g(a)g(FUSD)i(dri)-28
b(v)-17 b(er)331 b(sees)f Fo(private)p 23831 32350 V
400 w(data)h Fn(\(in)f(the)h Fo(open)f Fn(callback\),)346
b(it)329 b(is)h(guaranteed)j(to)d(be)h(NULL.)3631 33678
y(An)-17 b(y)278 b(changes)h(to)e(it)f(by)i(a)f(dri)-28
b(v)-17 b(er)278 b(callback)h(will)d(only)i(af)-28 b(fect)278
b(the)f(state)g(associated)h(with)f(that)g(single)g(\002le)h
(descriptor)-61 b(.)2524 35892 y Fg(\017)554 b Fo(device)p
7681 35892 V 399 w(info)339 b Fn(is)f(k)-11 b(ept)339
b Fk(per)g(de)-17 b(vice)p Fn(.)530 b(That)340 b(is,)352
b Fk(all)339 b Fn(clients)f(of)h(a)f(de)-28 b(vice)341
b(share)e(a)g Fk(single)g Fn(cop)-11 b(y)340 b(of)e Fo(device)p
47786 35892 V 400 w(info)p Fn(.)3631 37220 y(Unlik)-11
b(e)440 b Fo(private)p 11786 37220 V 399 w(data)p Fn(,)480
b(which)441 b(is)d(al)-11 b(w)g(ays)440 b(initialized)f(to)g(NULL,)h
Fo(device)p 37228 37220 V 400 w(info)f Fn(is)g(al)-11
b(w)g(ays)439 b(initialized)h(to)3631 38549 y(whate)-28
b(v)-17 b(er)349 b(v)-28 b(alue)350 b(the)d(dri)-28 b(v)-17
b(er)349 b(passed)f(to)f Fo(fusd)p 22582 38549 V 400
w(register)h Fn(as)g(described)h(in)e(the)h(pre)-28 b(vious)349
b(section.)555 b(If)346 b(a)i(callback)3631 39877 y(changes)251
b(the)e(cop)-11 b(y)251 b(of)e Fo(device)p 16657 39877
V 399 w(info)h Fn(in)f(the)g Fo(fusd)p 25329 39877 V
399 w(file)p 28384 39877 V 399 w(info)h Fn(structure,)k(this)248
b(has)i(no)f(ef)-28 b(fect;)259 b Fo(device)p 48063 39877
V 400 w(info)3631 41205 y Fn(can)278 b(only)g(be)f(set)g(at)g(re)-17
b(gistration)277 b(time,)g(with)g Fo(fusd)p 24384 41205
V 399 w(register)p Fn(.)2524 44305 y(In)381 b(short,)408
b Fo(device)p 10776 44305 V 400 w(info)382 b Fn(is)f(used)i(to)f(dif)
-28 b(ferentiate)382 b Fk(de)-17 b(vices)p Fn(.)660 b
Fo(private)p 33575 44305 V 400 w(data)382 b Fn(is)f(used)i(to)f(dif)-28
b(ferentiate)383 b Fk(user)-11 b(s)381 b(of)863 45633
y(those)278 b(de)-17 b(vices)p Fn(.)2524 47626 y(Program)267
b(5,)h(drums2.c,)g(illustrates)d(the)h(dif)-28 b(ference)268
b(between)g Fo(device)p 31251 47626 V 399 w(info)f Fn(and)g
Fo(private)p 41085 47626 V 400 w(data)p Fn(.)340 b(Lik)-11
b(e)266 b(the)h(origi-)863 48954 y(nal)295 b(drums.c,)k(it)294
b(creates)h(a)g(b)-22 b(unch)297 b(of)d(de)-28 b(vices)297
b(in)d Fo(/dev/drums/)p Fn(,)301 b(each)296 b(of)f(which)g
(\223plays\224)i(a)d(dif)-28 b(ferent)295 b(sound.)398
b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)863 50283 y(it)263
b(also)h(does)h(something)g(ne)-28 b(w:)338 b(k)-11 b(eeps)265
b(track)f(of)g(ho)-28 b(w)265 b(man)-17 b(y)266 b(times)d(each)j(de)-28
b(vice)266 b(has)e(been)i(opened.)341 b(Ev)-17 b(ery)266
b(read)e(to)g(an)-17 b(y)266 b(drum)863 51611 y(gi)-28
b(v)-17 b(es)279 b(you)h(the)e(name)h(of)f(its)f(sound)i(as)f(well)g
(as)g(your)h(unique)g(\223user)g(number\224.)348 b(And,)279
b(instead)g(of)e(returning)i(just)e(a)i(single)f(line)863
52939 y(\(as)f(drums.c)g(did\),)g(it)f(will)g(k)-11 b(eep)279
b(generating)g(more)e(\223sound\224)j(e)-28 b(v)-17 b(ery)279
b(time)d(a)i Fo(read\(\))f Fn(system)g(call)g(arri)-28
b(v)-17 b(es.)2524 54932 y(The)278 b(trick)e(is)g(that)i(we)f(w)-11
b(ant)278 b(to)f(k)-11 b(eep)278 b(users)f(separate)h(from)e(each)j
(other)-61 b(.)344 b(F)-17 b(or)278 b(e)-17 b(xample,)279
b(user)e(one)h(might)f(type:)863 57311 y Fo(\045)665
b(more)f(/dev/drums/bam)863 58640 y(You)h(are)g(user)f(1)h(to)f(hear)h
(a)g(drum)f(go)h('bam'!)863 59968 y(You)g(are)g(user)f(1)h(to)f(hear)h
(a)g(drum)f(go)h('bam'!)863 61296 y(You)g(are)g(user)f(1)h(to)f(hear)h
(a)g(drum)f(go)h('bam'!)863 62625 y(...)2524 65483 y
Fn(Meanwhile,)279 b(another)g(user)f(in)f(a)h(dif)-28
b(ferent)278 b(shell)f(might)h(type)h(the)f(same)g(command)i(at)d(the)h
(same)h(time,)e(and)i(get)f(dif)-28 b(ferent)863 66811
y(results:)25405 74071 y(17)p eop
%%Page: 18 21
18 20 bop 863 3187 50191 89 v 863 4164 a Fl(Pr)-20 b(ogram)280
b(5)d Fn(drums2.c:)344 b(Using)277 b(both)h Fo(device)p
20148 4164 333 45 v 400 w(info)f Fn(and)h Fo(private)p
30004 4164 V 400 w(data)p 863 4669 50191 45 v 365 5624
a Fi(1)1661 b Fo(struct)665 b(drum_info)h({)3852 6953
y(char)f(*name;)3852 8281 y(int)g(num_users;)2524 9609
y(})f(drums[])h(=)g({)365 10938 y Fi(5)2989 b Fo({)664
b("bam",)i(0)e(},)3852 12266 y({)g("bum",)i(0)e(},)3852
13594 y(/*)g(...)h(*/)3852 14923 y({)f(NULL,)h(0)g(})2524
16251 y(};)-133 17579 y Fi(10)2524 18908 y Fo(int)f(drums_open\(struct)
j(fusd_file_info)g(*file\))2524 20236 y({)3852 21564
y(/*)d(file->device_info)k(is)c(what)h(we)g(passed)g(to)f
(fusd_register)j(when)e(we)4516 22893 y(*)f(registered)i(the)f(device.)
1330 b(It's)665 b(a)f(pointer)h(into)g(the)g("drums")g(struct.)h(*/)
-133 24221 y Fi(15)2989 b Fo(struct)665 b(drum_info)h(*d)e(=)h
(\(struct)g(drum_info)h(*\))f(file->device_info;)3852
26878 y(/*)f(Store)i(this)e(user's)i(unique)f(user)g(number)g(in)g
(their)g(private_data)h(*/)3852 28206 y(file->private_data)h(=)e
(\(void)g(*\))f(++\(d->num_users\);)-133 30863 y Fi(20)2989
b Fo(return)665 b(0;)g(/*)f(return)h(success)h(*/)2524
32191 y(})2524 34848 y(int)e(drums_read\(struct)j(fusd_file_info)g
(*file,)e(char)g(*user_buffer,)12486 36176 y(size_t)g(user_length,)i
(loff_t)e(*offset\))-133 37505 y Fi(25)1661 b Fo({)3852
38833 y(struct)665 b(drum_info)h(*d)e(=)h(\(struct)g(drum_info)h(*\))f
(file->device_info;)3852 40161 y(int)g(len;)3852 41490
y(char)g(sound[128];)-133 44146 y Fi(30)2989 b Fo(sprintf\(sound,)667
b("You)d(are)h(user)g(\045d)g(to)f(hear)h(a)f(drum)h(go)g
('\045s'!\\n",)9165 45475 y(\(int\))g(file->private_data,)j(d->name\);)
3852 48131 y(len)d(=)f(MIN\(user_length,)j(strlen\(sound\)\);)3852
49460 y(memcpy\(user_buffer,)g(sound,)f(len\);)-133 50788
y Fi(35)2989 b Fo(return)665 b(len;)2524 52116 y(})2524
54773 y(int)f(main\(int)i(argc,)f(char)g(*argv[]\))2524
56102 y({)-133 57430 y Fi(40)2989 b Fo(struct)665 b(drum_info)h(*d;)
3852 58758 y(char)f(buf[128];)3852 61415 y(for)g(\(d)f(=)h(drums;)g
(d->name)g(!=)g(NULL;)g(d++\))g({)5180 62743 y(sprintf\(buf,)i
("/dev/drums/\045s",)g(d->name\);)-133 64072 y Fi(45)4317
b Fo(if)665 b(\(fusd_register\(buf,)i(0666,)e(d,)g(&drums_fops\))h(<)f
(0\))6509 65400 y(fprintf\(stderr,)h("\045s)f(register)h(failed:)f
(\045m\\n",)g(d->name\);)3852 66728 y(})3852 68057 y(/*)f(...)h(*/)p
863 69518 V 25405 74071 a Fn(18)p eop
%%Page: 19 22
19 21 bop 863 3896 a Fo(\045)665 b(more)f(/dev/drums/bam)863
5224 y(You)h(are)g(user)f(2)h(to)f(hear)h(a)g(drum)f(go)h('bam'!)863
6553 y(You)g(are)g(user)f(2)h(to)f(hear)h(a)g(drum)f(go)h('bam'!)863
7881 y(You)g(are)g(user)f(2)h(to)f(hear)h(a)g(drum)f(go)h('bam'!)863
9209 y(...)2524 12068 y Fn(The)287 b(idea)f(is)f(that)i(no)f(matter)g
(ho)-28 b(w)287 b(long)g(those)g(tw)-11 b(o)286 b(users)f(go)i(on)g
(reading)g(their)f(de)-28 b(vices,)289 b(the)e(dri)-28
b(v)-17 b(er)287 b(al)-11 b(w)g(ays)286 b(generates)i(a)863
13396 y(message)278 b(that)f(is)f(speci\002c)j(to)e(that)g(user)-61
b(.)343 b(The)278 b(tw)-11 b(o)277 b(users')f(data)i(are)g(not)f
(intermingled.)2524 15388 y(T)-89 b(o)313 b(implement)g(this,)320
b(Program)313 b(5)g(introduces)g(a)f(ne)-28 b(w)314 b
Fo(drum)p 26788 15388 333 45 v 399 w(info)f Fn(structure)f(\(lines)f
(1-4\),)321 b(which)313 b(k)-11 b(eeps)313 b(track)g(of)f(both)863
16717 y(the)421 b(drum')-61 b(s)420 b(name,)457 b(and)421
b(the)g(number)h(of)e(time)g(each)i(drum)f(de)-28 b(vice)422
b(has)e(been)i(opened.)776 b(An)420 b(instance)i(of)e(this)f
(structure,)863 18045 y Fo(drums)p Fn(,)393 b(is)369
b(initialized)h(on)g(lines)f(4-8.)622 b(Note)370 b(that)g(the)g(call)f
(to)h Fo(fusd)p 29261 18045 V 399 w(register)h Fn(\(line)e(45\))h(no)
-28 b(w)371 b(passes)e(a)h(pointer)g(to)g(a)863 19373
y Fo(drum)p 3585 19373 V 399 w(info)258 b Fn(structure.)336
b(\(This)257 b Fo(drum)p 16634 19373 V 399 w(info)665
b(*)257 b Fn(pointer)h(is)e(shared)i(by)g(e)-28 b(v)-17
b(ery)259 b(instance)g(of)e(a)g(client)g(that)h(opens)g(a)f(particular)
863 20702 y(type)278 b(of)f(drum.\))2524 22694 y(Each)413
b(time)g(a)f(drum)h(de)-28 b(vice)414 b(is)e(opened,)448
b(its)411 b Fo(drum)p 23704 22694 V 400 w(info)h Fn(structure)g(is)g
(retrie)-28 b(v)-17 b(ed)414 b(from)e Fo(device)p 43458
22694 V 399 w(info)h Fn(\(line)f(15\).)863 24023 y(Then,)266
b(on)c(line)f(18,)k(the)c Fo(num)p 12287 24023 V 399
w(users)h Fn(\002eld)g(is)e(incremented)k(and)e(the)f(ne)-28
b(w)263 b(user)e(number)h(is)f(stored)g(in)g Fo(fusd)p
44270 24023 V 399 w(file)p 47325 24023 V 399 w(info)p
Fn(')-61 b(s)863 25351 y Fo(private)p 5577 25351 V 400
w(data)308 b Fn(\002eld.)434 b(T)-89 b(o)308 b(reiterate)g(our)f
(earlier)g(point:)404 b Fo(device)p 28888 25351 V 400
w(info)308 b Fk(contains)g(information)g(global)g(to)g(all)e(user)-11
b(s)307 b(of)863 26679 y(a)277 b(de)-17 b(vice)-11 b(,)279
b(while)f Fo(private)p 12436 26679 V 400 w(data)f Fk(has)g(information)
h(speci\002c)h(to)e(a)g(particular)g(user)g(of)g(the)h(de)-17
b(vice)g(.)2524 28672 y Fn(It')-61 b(s)413 b(also)i(w)-11
b(orthwhile)416 b(to)f(note)h(that)g(when)g(we)g(increment)g
Fo(num)p 29087 28672 V 399 w(users)g Fn(on)g(line)f(18,)450
b(a)416 b(simple)f Fo(num)p 44918 28672 V 399 w(users++)h
Fn(is)863 30000 y(correct.)478 b(If)321 b(this)g(w)-11
b(as)321 b(a)h(dri)-28 b(v)-17 b(er)323 b(inside)f(the)g(k)-11
b(ernel,)334 b(we')-55 b(d)321 b(ha)-22 b(v)-17 b(e)324
b(to)e(use)g(something)h(lik)-11 b(e)322 b Fo(atomic)p
40226 30000 V 399 w(inc\(\))h Fn(because)g(a)f(plain)863
31329 y Fo(i++)301 b Fn(is)f(not)h(atomic.)415 b(Such)303
b(a)e(non-atomic)h(statement)g(will)e(result)g(in)h(a)g(race)g
(condition)i(on)e(SMP)h(platforms,)k(if)300 b(an)h(interrupt)863
32657 y(handler)328 b(also)e(touches)h Fo(num)p 12383
32657 V 399 w(users)p Fn(,)339 b(or)326 b(in)g(some)h(future)f(Linux)h
(k)-11 b(ernel)327 b(that)g(is)e(preempti)-28 b(v)-17
b(e.)493 b(Since)327 b(this)f(FUSD)h(dri)-28 b(v)-17
b(er)327 b(is)863 33985 y(just)276 b(a)i(plain,)f(single-threaded)i
(user)-22 b(-space)278 b(application,)h(good)f(old)g
Fo(++)f Fn(still)e(w)-11 b(orks.)863 38385 y Fm(6)1594
b(Writing)399 b Fa(ioctl)h Fm(Callbacks)863 41524 y Fn(The)302
b(POSIX)f(API)g(pro)-17 b(vides)302 b(for)e(a)h(function)h(called)f
Fo(ioctl)p Fn(,)307 b(which)302 b(allo)-28 b(ws)301 b
(\223out-of-band\224)i(con\002guration)h(information)d(to)863
42852 y(be)e(passed)g(to)f(a)g(de)-28 b(vice)301 b(dri)-28
b(v)-17 b(er)299 b(through)g(a)g(\002le)f(descriptor)-61
b(.)407 b(Using)299 b(FUSD,)g(you)g(can)g(write)f(a)g(de)-28
b(vice)301 b(dri)-28 b(v)-17 b(er)299 b(with)f(a)g(callback)863
44180 y(to)282 b(handle)i Fo(ioctl)f Fn(requests)f(from)g(clients.)358
b(F)-17 b(or)283 b(the)g(most)f(part,)h(it')-61 b(s)280
b(just)i(lik)-11 b(e)282 b(writing)g(a)g(callback)i(for)e
Fo(read)g Fn(or)g Fo(write)p Fn(,)i(as)863 45509 y(we')-55
b(v)-17 b(e)264 b(seen)f(in)f(pre)-28 b(vious)264 b(sections.)339
b(From)263 b(the)g(client')-61 b(s)262 b(point)h(of)f(vie)-28
b(w)-72 b(,)267 b Fo(ioctl)c Fn(traditionally)g(tak)-11
b(es)263 b(three)g(ar)-20 b(guments:)337 b(a)263 b(\002le)863
46837 y(descriptor)-44 b(,)277 b(a)g(command)j(number)-44
b(,)278 b(and)g(a)f(pointer)h(to)f(an)-17 b(y)278 b(additional)h(data)f
(that)f(might)g(be)h(required)g(for)f(the)g(command.)863
50670 y Fj(6.1)1329 b(Using)332 b(macr)-24 b(os)331 b(to)i(generate)e
Fc(ioctl)h Fj(command)f(numbers)863 53410 y Fn(The)300
b(Linux)h(header)g(\002le)e Fo(/usr/include/asm/ioctl.h)k
Fn(de\002nes)e(macros)f(that)f Fk(must)g Fn(be)h(used)g(to)f(create)h
(the)f Fo(ioctl)863 54738 y Fn(command)280 b(number)-61
b(.)344 b(These)279 b(macros)e(tak)-11 b(e)278 b(v)-28
b(arious)278 b(combinations)h(of)e(three)g(ar)-20 b(guments:)2524
57838 y Fg(\017)554 b Fo(type)p Fn(\227an)431 b(8-bit)e(inte)-17
b(ger)431 b(selected)g(to)f(be)g(speci\002c)h(to)f(the)g(de)-28
b(vice)432 b(dri)-28 b(v)-17 b(er)-61 b(.)803 b Fo(type)430
b Fn(should)h(be)f(chosen)h(so)f(as)g(not)3631 59166
y(to)371 b(con\003ict)i(with)e(other)h(dri)-28 b(v)-17
b(ers)372 b(that)f(might)h(be)g(\223listening\224)h(to)e(the)h(same)g
(\002le)f(descriptor)-61 b(.)627 b(\(Inside)371 b(the)h(k)-11
b(ernel,)396 b(for)3631 60494 y(e)-17 b(xample,)292 b(the)c(TCP)h(and)f
(IP)g(stacks)g(use)f(distinct)h(numbers)g(since)h(an)f
Fo(ioctl)g Fn(sent)g(to)f(a)h(sock)-11 b(et)289 b(\002le)f(descriptor)g
(might)3631 61823 y(be)277 b(e)-17 b(xamined)280 b(by)e(both)g
(stacks.\))2524 64036 y Fg(\017)554 b Fo(number)p Fn(\227an)241
b(8-bit)f(inte)-17 b(ger)241 b(\223command)h(number)-61
b(.)-77 b(\224)333 b(W)-44 b(ithin)239 b(a)h(dri)-28
b(v)-17 b(er)-44 b(,)248 b(distinct)239 b(numbers)i(should)g(be)g
(chosen)g(for)e(each)3631 65365 y(dif)-28 b(ferent)277
b(kind)h(of)f Fo(ioctl)g Fn(command)j(that)d(the)g(dri)-28
b(v)-17 b(er)278 b(services.)2524 67579 y Fg(\017)554
b Fo(data)p 6353 67579 V 399 w(type)p Fn(\227The)292
b(name)f(of)f(a)g(type)h(used)g(to)f(compute)i(ho)-28
b(w)291 b(man)-17 b(y)292 b(bytes)f(are)f(e)-17 b(xchanged)295
b(between)d(the)e(client)h(and)3631 68907 y(the)277 b(dri)-28
b(v)-17 b(er)-61 b(.)344 b(This)277 b(ar)-20 b(gument)279
b(is,)d(for)g(e)-17 b(xample,)279 b(the)f(name)g(of)f(a)g(structure.)
25405 74071 y(19)p eop
%%Page: 20 23
20 22 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(6)d Fn(ioctl.h:)343 b(Using)278 b(the)p 14258 2940
333 45 v 675 w Fo(IO)g Fn(macros)f(to)g(generate)i Fo(ioctl)f
Fn(command)h(numbers)p 863 3445 50191 45 v 365 4400 a
Fi(1)1661 b Fo(/*)664 b(definition)i(of)f(the)f(structure)i(exchanged)g
(between)f(client)g(and)g(server)g(*/)2524 5728 y(struct)g
(ioctl_data_t)h({)3852 7057 y(char)f(string1[60];)3852
8385 y(char)g(string2[60];)365 9714 y Fi(5)1661 b Fo(};)2524
12370 y(#define)665 b(IOCTL_APP_TYPE)i(71)d(/*)h(arbitrary)g(number)h
(unique)f(to)f(this)h(app)g(*/)2524 15027 y(#define)g(IOCTL_TEST2)h
(_IO\(IOCTL_APP_TYPE,)i(2\))c(/*)h(int)f(argument)i(*/)-133
16355 y Fi(10)1661 b Fo(#define)665 b(IOCTL_TEST3)h
(_IOR\(IOCTL_APP_TYPE,)i(3,)c(struct)i(ioctl_data_t\))2524
17684 y(#define)f(IOCTL_TEST4)h(_IOW\(IOCTL_APP_TYPE,)i(4,)c(struct)i
(ioctl_data_t\))2524 19012 y(#define)f(IOCTL_TEST5)h
(_IOWR\(IOCTL_APP_TYPE,)i(5,)d(struct)g(ioctl_data_t\))p
863 20524 V 2524 23606 a Fn(The)278 b(macros)f(used)h(to)f(generate)i
(command)g(numbers)g(are:)2524 26407 y Fg(\017)p 3697
26407 333 45 v 952 w Fo(IO\(int)665 b(type,)g(int)g(number\))318
b Fn(\226)f(used)h(for)e(a)h(simple)g(ioctl)f(that)h(sends)h(nothing)g
(b)-22 b(ut)317 b(the)g(type)h(and)g(number)-44 b(,)3631
27736 y(and)278 b(recei)-28 b(v)-17 b(es)279 b(back)f(nothing)h(b)-22
b(ut)277 b(an)h(\(inte)-17 b(ger\))277 b(retv)-28 b(al.)2524
29830 y Fg(\017)p 3697 29830 V 952 w Fo(IOR\(int)665
b(type,)h(int)e(number,)i(data)p 24020 29830 V 399 w(type\))401
b Fn(\226)f(used)h(for)e(an)i(ioctl)f(that)g(reads)g(data)h
Fk(fr)-50 b(om)400 b Fn(the)h(de)-28 b(vice)3631 31159
y(dri)g(v)-17 b(er)-61 b(.)344 b(The)278 b(dri)-28 b(v)-17
b(er)278 b(will)e(be)h(allo)-28 b(wed)279 b(to)e(return)g
Fo(sizeof\(data)p 30165 31159 V 401 w(type\))g Fn(bytes)h(to)f(the)g
(user)-61 b(.)2524 33253 y Fg(\017)p 3697 33253 V 952
w Fo(IOW\(int)665 b(type,)h(int)e(number,)i(data)p 24020
33253 V 399 w(type\))241 b Fn(\226)f(similar)f(to)p 33189
33253 V 638 w(IOR,)h(b)-22 b(ut)240 b(used)h(to)f(write)g(data)h
Fk(to)f Fn(the)g(dri)-28 b(v)-17 b(er)-61 b(.)2524 35348
y Fg(\017)p 3697 35348 V 952 w Fo(IORW\(int)666 b(type,)f(int)f
(number,)i(data)p 24684 35348 V 399 w(type\))267 b Fn(\226)g(a)f
(combination)j(of)p 37237 35348 V 665 w Fo(IOR)e Fn(and)p
41759 35348 V 666 w Fo(IOW)p Fn(.)f(That)h(is,)h(data)f(is)3631
36676 y(both)277 b(written)g(to)g(the)h(dri)-28 b(v)-17
b(er)277 b(and)i(then)e(read)h(back)h(from)e(the)g(dri)-28
b(v)-17 b(er)278 b(by)g(the)f(client.)2524 39478 y(Program)322
b(6)f(is)f(an)h(e)-17 b(xample)324 b(header)f(\002le)e(sho)-28
b(wing)322 b(the)g(use)f(of)g(these)g(macros.)476 b(In)321
b(real)g(programs,)332 b(the)321 b(client)h(e)-17 b(x)g(ecuting)863
40806 y(an)278 b(ioctl)f(and)h(the)f(dri)-28 b(v)-17
b(er)278 b(that)f(services)h(it)e(must)g(share)i(the)f(same)h(header)h
(\002le.)863 44585 y Fj(6.2)1329 b(Example)332 b(client)g(calls)g(and)f
(dri)-13 b(v)g(er)331 b(callbacks)863 47325 y Fn(Program)268
b(7)f(sho)-28 b(ws)268 b(a)f(client)g(program)h(that)f(e)-17
b(x)g(ecutes)270 b Fo(ioctl)p Fn(s)d(using)g(the)h(ioctl)e(command)k
(numbers)e(de\002ned)h(in)e(Program)h(6.)863 48653 y(The)236
b Fo(ioctl)p 6205 48653 V 399 w(data)p 9260 48653 V 400
w(t)e Fn(is)g(application-speci\002c;)252 b(our)236 b(simple)e(test)h
(program)h(de\002nes)g(it)e(as)h(a)g(structure)g(containing)i(tw)-11
b(o)235 b(arrays)863 49981 y(of)266 b(characters.)340
b(The)267 b(\002rst)e Fo(ioctl)h Fn(call)g(\(line)g(10\))g(sends)g(the)
g(command)i Fo(IOCTL)p 32974 49981 V 400 w(TEST3)p Fn(,)g(which)f
(retrie)-28 b(v)-17 b(es)266 b(strings)f Fk(fr)-50 b(om)266
b Fn(the)863 51310 y(dri)-28 b(v)-17 b(er)-61 b(.)344
b(The)278 b(second)h Fo(ioctl)f Fn(uses)f(the)g(command)j
Fo(IOCTL)p 24809 51310 V 399 w(TEST4)e Fn(\(line)e(18\),)h(which)i
(sends)e(strings)f Fk(to)h Fn(the)g(dri)-28 b(v)-17 b(er)-61
b(.)2524 53302 y(The)278 b(portion)f(of)g(the)h(FUSD)g(dri)-28
b(v)-17 b(er)278 b(that)f(services)g(these)g(calls)g(is)f(sho)-28
b(wn)279 b(in)e(Program)h(8.)2524 55295 y(The)337 b(ioctl)g(e)-17
b(xample)339 b(header)g(\002le)e(and)h(test)e(programs)h(sho)-28
b(wn)339 b(in)d(this)g(document)k(\(Programs)d(6,)351
b(7,)h(and)338 b(8\))f(are)g(actually)863 56623 y(contained)f(in)d(a)g
(lar)-20 b(ger)-44 b(,)347 b(single)333 b(e)-17 b(xample)336
b(program)e(included)h(in)e(the)h(FUSD)g(distrib)-22
b(ution)333 b(called)h Fo(ioctl.c)p Fn(.)512 b(That)334
b(source)863 57952 y(code)279 b(sho)-28 b(ws)277 b(other)h(v)-28
b(ariations)278 b(on)f(calling)h(and)g(servicing)g Fo(ioctl)g
Fn(commands.)863 62298 y Fm(7)1594 b(Integrating)399
b(FUSD)f(W)-29 b(ith)399 b(Y)-177 b(our)398 b(A)-40 b(pplication)400
b(Using)f Fa(fusd)p 40051 62298 479 45 v 575 w(dispatch\(\))863
65436 y Fn(The)228 b(e)-17 b(xample)229 b(applications)g(we')-55
b(v)-17 b(e)228 b(seen)f(so)g(f)-11 b(ar)226 b(ha)-22
b(v)-17 b(e)229 b(something)f(in)f(common:)320 b(after)227
b(initialization)g(and)h(de)-28 b(vice)229 b(re)-17 b(gistration,)863
66765 y(the)g(y)300 b(call)f Fo(fusd)p 7670 66765 333
45 v 399 w(run\(\))p Fn(.)408 b(This)298 b(gi)-28 b(v)-17
b(es)300 b(up)f(control)g(of)g(the)g(program')-61 b(s)299
b(\003o)-28 b(w)-72 b(,)304 b(turning)c(it)d(o)-17 b(v)g(er)300
b(to)f(the)g(FUSD)g(library)g(instead.)863 68093 y(This)234
b(w)-11 b(ork)g(ed)236 b(\002ne)f(for)e(our)i(simple)f(e)-17
b(xample)236 b(programs,)243 b(b)-22 b(ut)235 b(doesn')-20
b(t)234 b(w)-11 b(ork)235 b(in)f(a)g(real)g(program)h(that)g(needs)g
(to)f(w)-11 b(ait)234 b(for)f(e)-28 b(v)-17 b(ents)863
69421 y(other)316 b(than)h(FUSD)g(callbacks.)460 b(F)-17
b(or)317 b(this)e(reason,)325 b(our)316 b(frame)-28 b(w)-11
b(ork)317 b(pro)-17 b(vides)317 b(another)g(w)-11 b(ay)317
b(to)f(acti)-28 b(v)g(ate)317 b(callbacks)g(that)f(does)863
70750 y(not)278 b(require)f(the)h(dri)-28 b(v)-17 b(er)277
b(to)g(gi)-28 b(v)-17 b(e)279 b(up)f(control)f(of)g(its)f
Fo(main\(\))p Fn(.)25405 74071 y(20)p eop
%%Page: 21 24
21 23 bop 863 1955 50191 89 v 863 2932 a Fl(Pr)-20 b(ogram)280
b(7)d Fn(ioctl-client.c:)344 b(A)276 b(program)j(that)e(mak)-11
b(es)278 b Fo(ioctl)f Fn(requests)g(on)h(a)f(\002le)h(descriptor)p
863 3437 50191 45 v 365 4392 a Fi(1)4317 b Fo(int)665
b(fd,)g(ret;)5180 5721 y(struct)h(ioctl_data_t)g(d;)5180
8377 y(if)f(\(\(fd)g(=)f(open\("/dev/ioctltest",)k(O_RDWR\)\))e(<)e
(0\))h({)365 9706 y Fi(5)5646 b Fo(perror\("client:)666
b(can't)g(open)e(ioctltest"\);)6509 11034 y(exit\(1\);)5180
12363 y(})5180 15019 y(/*)h(test3:)g(make)g(sure)g(we)f(can)h(get)g
(data)g(FROM)g(a)f(driver)h(using)g(ioctl)g(*/)-133 16348
y Fi(10)4317 b Fo(ret)665 b(=)f(ioctl\(fd,)i(IOCTL_TEST3,)g(&d\);)5180
17676 y(printf\("ioctl)h(test3:)e(got)g(retval=\045d\\n",)h(ret\);)5180
19004 y(printf\("ioctl)h(test3:)e(got)g(string1='\045s'\\n",)i
(d.string1\);)5180 20333 y(printf\("ioctl)g(test3:)e(got)g
(string2='\045s'\\n",)i(d.string2\);)-133 22989 y Fi(15)4317
b Fo(/*)665 b(test4:)g(make)g(sure)g(we)f(can)h(send)g(data)g(TO)f(a)h
(driver)g(using)g(an)g(ioctl)g(*/)5180 24318 y(sprintf\(d.string1,)j
(TEST4_STRING1\);)5180 25646 y(sprintf\(d.string2,)g(TEST4_STRING2\);)
5180 26974 y(ret)d(=)f(ioctl\(fd,)i(IOCTL_TEST4,)g(&d\);)p
863 28486 V 863 31807 a Fj(7.1)1329 b(Using)332 b Fc(fusd)p
10700 31807 399 45 v 478 w(dispatch\(\))863 34547 y Fn(Recall)443
b(from)g(Section)g(4.1)g(that)g Fo(fusd)p 17141 34547
333 45 v 399 w(register)h Fn(returns)e(a)g Fk(\002le)h(descriptor)g
Fn(for)f(e)-28 b(v)-17 b(ery)444 b(de)-28 b(vice)445
b(that)d(is)g(successfully)863 35875 y(re)-17 b(gistered.)357
b(This)281 b(\002le)h(descriptor)f(can)i(be)f(used)g(to)f(acti)-28
b(v)g(ate)283 b(de)-28 b(vice)284 b(callbacks)f(\223manually)-72
b(,)-77 b(\224)284 b(without)e(passing)g(control)g(of)f(the)863
37203 y(application)256 b(to)f Fo(fusd)p 9874 37203 V
399 w(run\(\))p Fn(.)336 b(Whene)-28 b(v)-17 b(er)257
b(the)e(\002le)g(descriptor)f(becomes)j(readable)f(according)g(to)f
Fo(select\(2\))p Fn(,)260 b(it)253 b(should)863 38532
y(be)258 b(passed)g(to)g Fo(fusd)p 9214 38532 V 399 w(dispatch\(\))p
Fn(,)k(which)d(in)e(turn)g(will)g(acti)-28 b(v)g(ate)259
b(callbacks)g(in)e(the)h(same)g(w)-11 b(ay)258 b(that)f
Fo(fusd)p 44836 38532 V 400 w(run\(\))g Fn(does.)863
39860 y(In)277 b(other)h(w)-11 b(ords,)276 b(an)i(application)h(can:)
2247 42738 y(1.)554 b(Sa)-22 b(v)-17 b(e)278 b(the)g(\002le)f
(descriptors)g(returned)h(by)g Fo(fusd)p 22546 42738
V 399 w(register\(\))p Fn(;)2247 44952 y(2.)554 b(Add)263
b(those)f(FUSD)h(\002le)g(descriptors)f(to)g(an)h Fo(fd)p
22108 44952 V 398 w(set)g Fn(that)f(is)f(passed)i(to)f
Fo(select)p Fn(,)k(along)d(with)f(an)-17 b(y)264 b(other)e(\002le)h
(descrip-)3631 46280 y(tors)276 b(that)h(might)g(be)h(interesting)f(to)
g(the)h(application;)g(and)2247 48494 y(3.)554 b(P)-17
b(ass)277 b(e)-28 b(v)-17 b(ery)279 b(FUSD)f(\002le)f(descriptor)h
(that)f Fo(select)h Fn(indicates)g(is)e(readable)j(to)e
Fo(fusd)p 37363 48494 V 399 w(dispatch)p Fn(.)2524 51372
y Fo(fusd)p 5246 51372 V 399 w(dispatch\(\))247 b Fn(returns)f(0)g(if)f
(at)g(least)h(one)h(callback)h(w)-11 b(as)246 b(successfully)g(acti)-28
b(v)g(ated.)335 b(On)247 b(error)-44 b(,)251 b(-1)245
b(is)g(returned)i(with)863 52701 y Fo(errno)261 b Fn(set)e
(appropriately)-72 b(.)340 b Fo(fusd)p 15100 52701 V
399 w(dispatch\(\))262 b Fn(will)d(ne)-28 b(v)-17 b(er)262
b(block\227if)f(no)f(messages)h(are)g(a)-22 b(v)-28 b(ailable)262
b(from)d(the)i(k)-11 b(ernel,)264 b(it)863 54029 y(will)276
b(return)h(-1)g(with)g Fo(errno)h Fn(set)e(to)h Fo(EAGAIN)p
Fn(.)863 57862 y Fj(7.2)1329 b(Helper)332 b(Functions)e(f)-33
b(or)332 b(Constructing)g(an)g Fc(fd)p 27226 57862 399
45 v 478 w(set)863 60602 y Fn(The)305 b(FUSD)f(library)g(pro)-17
b(vides)305 b(tw)-11 b(o)304 b(\(optional\))g(utility)f(functions)h
(that)g(can)g(mak)-11 b(e)305 b(it)e(easier)h(to)f(write)g
(applications)j(that)d(inte-)863 61930 y(grate)278 b(FUSD)g(into)f
(their)g(o)-28 b(wn)278 b Fo(select\(\))g Fn(loops.)344
b(Speci\002cally:)2524 64808 y Fg(\017)554 b Fo(void)664
b(fusd)p 9673 64808 333 45 v 400 w(fdset)p 13393 64808
V 399 w(add\(fd)p 17776 64808 V 400 w(set)g(*set,)h(int)g(*max\))p
Fn(\227is)361 b(meant)h(to)e(help)i(construct)g(an)f
Fo(fd)p 46707 64808 V 399 w(set)g Fn(that)3631 66136
y(will)347 b(be)i(passed)g(as)f(the)g(\223readable)j(fds\224)d(set)f
(to)h(select.)557 b(This)348 b(function)i(adds)e(the)h(\002le)g
(descriptors)f(of)g(all)f(pre)-28 b(viously)3631 67465
y(re)-17 b(gistered)317 b(FUSD)g(de)-28 b(vices)318 b(to)e(the)h(fd)p
18882 67465 V 398 w(set)f Fo(set)p Fn(.)461 b(It)315
b(assumes)i(that)f Fo(set)h Fn(has)f(already)i(been)g(initialized)e(by)
h(the)g(caller)-61 b(.)3631 68793 y(The)282 b(inte)-17
b(ger)282 b Fo(max)f Fn(is)f(updated)k(to)d(re\003ect)h(the)f(lar)-20
b(gest)281 b(\002le)h(descriptor)f(number)i(in)e(the)g(set.)355
b Fo(max)282 b Fn(is)e(not)h(changed)j(if)d(the)3631
70121 y(v)-28 b(alue)278 b(passed)g(to)f Fo(fusd)p 13365
70121 V 399 w(fdset)p 17084 70121 V 400 w(add)g Fn(is)f(already)i(lar)
-20 b(ger)278 b(than)g(the)f(lar)-20 b(gest)277 b(FUSD)h(\002le)f
(descriptor)h(added)h(to)e(the)g(set.)25405 74071 y(21)p
eop
%%Page: 22 25
22 24 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(8)d Fn(ioctl-serv)-17 b(er)-61 b(.c:)344 b(A)277 b(dri)-28
b(v)-17 b(er)278 b(that)f(handles)h Fo(ioctl)g Fn(requests)p
863 3445 50191 45 v 365 4400 a Fi(1)1661 b Fo(/*)664
b(This)h(function)h(is)e(run)h(by)f(the)h(driver)g(*/)2524
5728 y(int)f(do_ioctl\(struct)j(fusd_file_info)g(*file,)e(int)g(cmd,)g
(void)f(*arg\))2524 7057 y({)3852 8385 y(struct)h(ioctl_data_t)h(*d;)
365 9714 y Fi(5)3852 11042 y Fo(if)e(\(_IOC_TYPE\(cmd\))j(!=)e
(IOCTL_APP_TYPE\))5180 12370 y(return)h(0;)3852 15027
y(switch)f(\(cmd\))g({)-133 16355 y Fi(10)2989 b Fo(case)665
b(IOCTL_TEST3:)h(/*)f(returns)g(data)g(to)f(the)h(client)g(*/)5180
17684 y(d)g(=)f(arg;)5180 19012 y(strcpy\(d->string1,)k
(TEST3_STRING1\);)5180 20340 y(strcpy\(d->string2,)g(TEST3_STRING2\);)
5180 21669 y(return)e(0;)-133 22997 y Fi(15)4317 b Fo(break;)3852
25654 y(case)665 b(IOCTL_TEST4:)h(/*)f(gets)g(data)f(from)h(the)g
(client)g(*/)5180 26982 y(d)g(=)f(arg;)5180 28310 y(printf\("ioctl)j
(server:)e(test4,)g(string1:)h(got)f('\045s'\\n",)g(d->string1\);)-133
29639 y Fi(20)4317 b Fo(printf\("ioctl)667 b(server:)e(test4,)g
(string2:)h(got)f('\045s'\\n",)g(d->string2\);)5180 30967
y(return)h(0;)5180 32296 y(break;)3852 33624 y(default:)5180
34952 y(printf\("ioctl)h(server:)e(got)g(unknown)g(cmd,)g(sigh,)g(this)
g(is)g(broken\\n"\);)-133 36281 y Fi(25)4317 b Fo(return)666
b(-EINVAL;)5180 37609 y(break;)3852 38937 y(})3852 41594
y(return)f(0;)-133 42922 y Fi(30)1661 b Fo(})p 863 44417
V 2524 47738 a Fg(\017)554 b Fo(void)664 b(fusd)p 9673
47738 333 45 v 400 w(dispatch)p 15385 47738 V 400 w(fdset\(fd)p
21097 47738 V 399 w(set)h(*set\))p Fn(\227is)220 b(meant)h(to)f(be)g
(called)h(on)g(the)f Fo(fd)p 41899 47738 V 399 w(set)g
Fn(that)g(is)f Fk(r)-41 b(eturned)3631 49066 y Fn(by)357
b(select.)583 b(It)356 b(assumes)h(that)g Fo(set)g Fn(contains)h(a)g
(set)e(\002le)h(descriptors)g(that)g Fo(select\(\))h
Fn(has)f(indicated)i(are)e(readable.)3631 50394 y Fo(fusd)p
6353 50394 V 399 w(dispatch)p 12064 50394 V 400 w(fdset\(\))409
b Fn(calls)g Fo(fusd)p 22615 50394 V 399 w(dispatch)h
Fn(on)f(e)-28 b(v)-17 b(ery)411 b(descriptor)e(in)g Fo(set)g
Fn(that)g(is)e(a)i(v)-28 b(alid)410 b(FUSD)3631 51723
y(descriptor)-61 b(.)343 b(Non-FUSD)279 b(descriptors)e(in)g
Fo(set)g Fn(are)h(ignored.)2524 54601 y(The)g(e)-17 b(xcerpt)279
b(of)d Fo(drums3.c)i Fn(sho)-28 b(wn)279 b(in)e(Program)h(9)f
(demonstrates)h(the)f(use)h(of)f(these)g(helper)h(functions.)344
b(This)277 b(program)863 55929 y(is)271 b(similar)g(to)h(the)g(earlier)
g(drums.c)g(e)-17 b(xample:)343 b(it)271 b(creates)i(a)f(number)h(of)f
(musical)h(instruments)e(such)i(as)f Fo(/dev/drums/bam)863
57257 y Fn(and)469 b Fo(/dev/drums/boom)p Fn(.)919 b(Ho)-28
b(we)g(v)-17 b(er)-44 b(,)518 b(in)468 b(addition)h(to)f(servicing)h
(its)e(musical)h(callbacks,)517 b(the)469 b(dri)-28 b(v)-17
b(er)468 b(also)g(prints)g(a)863 58586 y(prompt)379 b(to)g(standard)g
(input)g(asking)g(ho)-28 b(w)380 b(\223loud\224)g(the)f(drums)f(should)
i(be.)648 b(Instead)379 b(of)f(turning)h(control)g(of)f
Fo(main\(\))h Fn(o)-17 b(v)g(er)863 59914 y(to)326 b
Fo(fusd)p 4772 59914 V 399 w(run\(\))h Fn(as)f(in)g(the)g(pre)-28
b(vious)328 b(e)-17 b(xamples,)340 b Fo(drums3)327 b
Fn(uses)f Fo(select\(\))h Fn(to)f(simultaneously)i(w)-11
b(atch)327 b(its)d(FUSD)k(\002le)863 61243 y(descriptors)277
b(and)h(standard)g(input.)344 b(It)276 b(responds)i(to)f(input)h(from)e
(both)i(sources.)2524 63235 y(On)327 b(lines)f(2\2265,)341
b(an)327 b Fo(fd)p 11662 63235 V 399 w(set)g Fn(and)h(its)e(associated)
i(\223max\224)h(v)-28 b(alue)328 b(are)g(initialized)f(to)g(contain)h
(stdin')-61 b(s)326 b(\002le)h(descriptor)-61 b(.)494
b(On)863 64563 y(line)304 b(9,)310 b(we)304 b(use)g Fo(fusd)p
10062 64563 V 399 w(fdset)p 13781 64563 V 399 w(add)g
Fn(to)g(add)h(the)f(FUSD)g(\002le)g(descriptors)g(for)f(all)g(re)-17
b(gistered)304 b(de)-28 b(vices.)425 b(\(Not)303 b(sho)-28
b(wn)305 b(in)f(this)863 65892 y(e)-17 b(xcerpt)356 b(is)d(the)i(de)-28
b(vice)356 b(re)-17 b(gistration,)373 b(which)355 b(is)e(the)i(same)f
(as)g(the)h(re)-17 b(gistration)354 b(code)i(we)e(sa)-17
b(w)355 b(in)f Fo(drums.c)p Fn(.\))575 b(On)354 b(line)g(13)863
67220 y(we)i(call)f(select,)375 b(which)356 b(blocks)g(until)f(one)i
(of)e(the)g(fd')-61 b(s)355 b(in)g(the)h(set)e(is)h(readable.)579
b(On)356 b(lines)f(17)h(and)g(18,)375 b(we)356 b(check)h(to)e(see)h(if)
863 68548 y(standard)249 b(input)g(is)e(readable;)259
b(if)247 b(so,)253 b(a)248 b(function)i(is)d(called)i(which)g(reads)f
(the)g(user')-61 b(s)248 b(response)g(from)g(standard)h(input)g(and)g
(prints)863 69877 y(a)256 b(ne)-28 b(w)257 b(prompt.)337
b(Finally)-72 b(,)261 b(on)c(line)f(21,)k(we)c(call)g
Fo(fusd)p 22139 69877 V 400 w(dispatch)p 27851 69877
V 400 w(fdset)p Fn(,)k(which)d(in)f(turn)g(will)f(acti)-28
b(v)g(ate)258 b(the)e(callbacks)i(for)25405 74071 y(22)p
eop
%%Page: 23 26
23 25 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(9)d Fn(drums3.c:)344 b(W)-89 b(aiting)278 b(for)e(both)i(FUSD)g(and)g
(non-FUSD)i(e)-28 b(v)-17 b(ents)278 b(in)f(a)g Fo(select)h
Fn(loop)p 863 3445 50191 45 v 365 4400 a Fi(1)2989 b
Fo(/*)664 b(initialize)i(the)f(set)g(*/)3852 5728 y(FD_ZERO\(&fds\);)
3852 8385 y(/*)f(add)h(stdin)g(to)g(the)f(set)h(*/)365
9714 y Fi(5)2989 b Fo(FD_SET\(STDIN_FILENO,)668 b(&fds\);)3852
11042 y(max)d(=)f(STDIN_FILENO;)3852 13699 y(/*)g(add)h(all)g(FUSD)g
(fds)f(to)h(the)g(set)f(*/)3852 15027 y(fusd_fdset_add\(&fds,)k
(&max\);)-133 16355 y Fi(10)3852 17684 y Fo(while)d(\(1\))g({)5180
19012 y(tmp)g(=)f(fds;)5180 20340 y(if)h(\(select\(max+1,)h(&tmp,)g
(NULL,)f(NULL,)g(NULL\))g(<)f(0\))6509 21669 y(perror\("selecting"\);)
-133 22997 y Fi(15)4317 b Fo(else)665 b({)6509 24325
y(/*)f(if)h(stdin)g(is)f(readable,)i(read)f(the)g(user's)g(response)g
(*/)6509 25654 y(if)f(\(FD_ISSET\(STDIN_FILENO,)k(&tmp\)\))7837
26982 y(read_volume\(STDIN_FILENO\);)-133 29639 y Fi(20)5646
b Fo(/*)664 b(call)h(any)g(FUSD)g(callbacks)g(that)g(have)g(messages)h
(waiting)f(*/)6509 30967 y(fusd_dispatch_fdset\(&tmp\);)5180
32296 y(})3852 33624 y(})p 863 35118 V 863 38439 a Fn(de)-28
b(vices)279 b(that)e(ha)-22 b(v)-17 b(e)279 b(pending)g(system)e(calls)
g(w)-11 b(aiting)277 b(to)g(be)h(serviced.)2524 40432
y(It')-61 b(s)337 b(w)-11 b(orth)339 b(reiterating)g(that)g(dri)-28
b(v)-17 b(ers)339 b(are)g(not)h(required)g(to)e(use)i(the)f(FUSD)h
(helper)f(functions)h Fo(fusd)p 43071 40432 333 45 v
399 w(fdset)p 46790 40432 V 400 w(add)f Fn(and)863 41760
y Fo(fusd)p 3585 41760 V 399 w(dispatch)p 9296 41760
V 400 w(fdset)p Fn(.)798 b(If)427 b(it')-61 b(s)427 b(more)i(con)-44
b(v)-17 b(enient,)469 b(a)429 b(dri)-28 b(v)-17 b(er)429
b(can)h(manually)g(sa)-22 b(v)-17 b(e)429 b(all)f(of)h(the)f(\002le)h
(descriptors)g(re-)863 43088 y(turned)282 b(by)h Fo(fusd)p
8083 43088 V 399 w(register)p Fn(,)g(construct)f(its)e(o)-28
b(wn)283 b Fo(fd)p 23508 43088 V 399 w(set)p Fn(,)f(and)h(then)f(call)f
Fo(fusd)p 35060 43088 V 400 w(dispatch)h Fn(on)g(each)h(descriptor)f
(that)863 44417 y(is)415 b(readable.)760 b(This)415 b(method)i(is)d
(sometimes)i(required)g(for)f(inte)-17 b(gration)417
b(with)e(other)h(frame)-28 b(w)-11 b(orks)416 b(that)f(w)-11
b(ant)416 b(to)f(tak)-11 b(e)416 b(o)-17 b(v)g(er)863
45745 y(your)425 b Fo(main\(\))p Fn(.)785 b(F)-17 b(or)424
b(e)-17 b(xample,)463 b(the)425 b(GTK)f(user)g(interf)-11
b(ace)425 b(frame)-28 b(w)-11 b(ork)30621 45343 y Ff(11)31876
45745 y Fn(is)423 b(e)-28 b(v)-17 b(ent-dri)-28 b(v)-17
b(en)428 b(and)d(requires)f(that)g(you)h(pass)863 47073
y(control)371 b(of)g(your)g Fo(main)g Fn(to)f(it.)623
b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)396 b(it)370 b(does)h(allo)-28
b(w)371 b(you)h(to)f(gi)-28 b(v)-17 b(e)372 b(it)d(a)i(\002le)g
(descriptor)g(and)h(a)e(function)i(pointer)-44 b(,)394
b(say-)863 48402 y(ing)385 b(\223Call)g(this)e(callback)j(when)g
Fo(select)f Fn(indicates)g(this)f(\002le)g(descriptor)h(has)g(become)h
(readable.)-77 b(\224)667 b(A)384 b(GTK)h(application)863
49730 y(that)347 b(implements)g(FUSD)h(de)-28 b(vices)348
b(can)g(w)-11 b(ork)347 b(by)g(gi)-28 b(ving)348 b(GTK)f(all)g(the)f
(FUSD)i(\002le)f(descriptors)g(indi)-28 b(vidually)-72
b(,)365 b(and)348 b(calling)863 51059 y Fo(fusd)p 3585
51059 V 399 w(dispatch\(\))279 b Fn(when)f(GTK)g(calls)f(the)g
(associated)h(callbacks.)863 55459 y Fm(8)1594 b(Implementing)399
b(Blocking)g(System)f(Calls)863 58597 y Fn(All)359 b(of)h(the)g(e)-17
b(xample)362 b(dri)-28 b(v)-17 b(ers)361 b(that)f(we')-55
b(v)-17 b(e)361 b(seen)f(until)g(no)-28 b(w)361 b(ha)-22
b(v)-17 b(e)362 b(had)f(an)f(important)g(feature)h(missing:)508
b(the)-17 b(y)361 b(ne)-28 b(v)-17 b(er)362 b(had)f(to)863
59925 y Fk(wait)330 b Fn(for)f(an)-17 b(ything.)504 b(So)331
b(f)-11 b(ar)-44 b(,)342 b(a)330 b(dri)-28 b(v)-17 b(er')-61
b(s)330 b(response)h(to)e(a)h(system)g(call)g(has)g(al)-11
b(w)g(ays)331 b(been)g(immediately)g(a)-22 b(v)-28 b(ailable\227allo)g
(wing)863 61254 y(the)317 b(dri)-28 b(v)-17 b(er)318
b(to)e(response)i(immediately)-72 b(.)464 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)329 b(real)316 b(de)-28 b(vices)319 b(are)e(often)g(not)g
(that)g(luck)-17 b(y:)424 b(the)-17 b(y)318 b(usually)g(ha)-22
b(v)-17 b(e)318 b(to)f(w)-11 b(ait)317 b(for)863 62582
y(something)302 b(to)e(happen)i(before)f(completing)h(a)f(client')-61
b(s)299 b(system)h(call.)413 b(F)-17 b(or)301 b(e)-17
b(xample,)308 b(a)300 b(dri)-28 b(v)-17 b(er)301 b(might)f(be)h(w)-11
b(aiting)301 b(for)e(data)i(to)863 63910 y(arri)-28 b(v)-17
b(e)278 b(from)f(the)g(serial)f(port)h(or)g(o)-17 b(v)g(er)279
b(the)e(netw)-11 b(ork,)278 b(or)f(e)-28 b(v)-17 b(en)279
b(w)-11 b(aiting)278 b(for)e(a)i(user)f(action.)2524
65903 y(In)215 b(situations)h(lik)-11 b(e)216 b(this,)227
b(a)216 b(basic)g(capability)h(most)f(de)-28 b(vice)218
b(dri)-28 b(v)-17 b(ers)216 b(must)f(ha)-22 b(v)-17 b(e)218
b(is)d(the)h(ability)g(to)g Fk(bloc)-22 b(k)217 b Fn(the)f(caller)-61
b(.)323 b(Blocking)863 67231 y(operations)335 b(are)f(important)g
(because)i(the)-17 b(y)335 b(pro)-17 b(vide)336 b(a)e(simple)f(interf)
-11 b(ace)335 b(to)e(user)h(programs)g(that)g(does)h(\003o)-28
b(w)335 b(control,)348 b(rather)863 68560 y(than)290
b(something)h(more)f(e)-17 b(xpensi)-28 b(v)-17 b(e)293
b(lik)-11 b(e)290 b(continuous)h(polling.)382 b(F)-17
b(or)290 b(e)-17 b(xample,)294 b(user)c(programs)g(e)-17
b(xpect)292 b(to)d(be)h(able)g(to)g(e)-17 b(x)g(ecute)p
863 69508 20076 45 v 1738 70248 a Fe(11)2457 70561 y
Fd(http://www)-58 b(.gtk.or)-16 b(g)25405 74071 y Fn(23)p
eop
%%Page: 24 27
24 26 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(10)e Fn(console-read.c:)345 b(A)277 b(simple)g(blocking)i(system)e
(call)p 863 3445 50191 45 v 365 4400 a Fi(1)1661 b Fo(int)664
b(do_read\(struct)j(fusd_file_info)g(*file,)e(char)g(*user_buffer,)
10494 5728 y(size_t)g(user_length,)h(loff_t)f(*offset\))2524
7057 y({)3852 8385 y(char)g(buf[128];)365 9714 y Fi(5)3852
11042 y Fo(if)f(\(*offset)i(>)e(0\))5180 12370 y(return)i(0;)3852
15027 y(/*)e(print)i(a)e(prompt)h(*/)-133 16355 y Fi(10)2989
b Fo(printf\("Got)666 b(a)e(read)h(from)g(pid)g(\045d.)1329
b(What)665 b(do)f(we)h(say?\\n>)g(",)g(file->pid\);)3852
17684 y(fflush\(stdout\);)3852 20340 y(/*)f(get)h(a)g(response)g(from)g
(the)g(console)g(*/)3852 21669 y(if)f(\(fgets\(buf,)j(sizeof\(buf\))f
(-)e(1,)h(stdin\))g(==)f(NULL\))-133 22997 y Fi(15)4317
b Fo(return)666 b(0;)3852 25654 y(/*)e(compute)i(length)f(of)g(the)f
(response,)i(and)f(return)g(*/)3852 26982 y(user_length)h(=)e
(MIN\(user_length,)j(strlen\(buf\)\);)3852 28310 y
(memcpy\(user_buffer,)g(buf,)e(user_length\);)-133 29639
y Fi(20)2989 b Fo(*offset)665 b(+=)g(user_length;)3852
30967 y(return)g(user_length;)2524 32296 y(})p 863 33790
V 863 37111 a Fn(a)388 b(statement)f(lik)-11 b(e)388
b Fo(read\(fd,)665 b(buf,)g(sizeof\(buf\)\))p Fn(,)416
b(and)389 b(e)-17 b(xpect)389 b(the)f(read)g(call)f(to)g(block)i
(\(stop)e(the)g(\003o)-28 b(w)389 b(of)e(the)863 38439
y(calling)278 b(program\))g(until)f(data)g(is)g(a)-22
b(v)-28 b(ailable.)345 b(This)277 b(is)f(much)i(simpler)f(and)h(more)f
(ef)-28 b(\002cient)279 b(than)f(polling)g(repeatedly)-72
b(.)2524 40432 y(In)276 b(the)i(follo)-28 b(wing)278
b(sections,)f(we')-11 b(ll)276 b(describe)i(ho)-28 b(w)279
b(to)e(block)h(and)g(unblock)i(system)c(calls)h(for)g(de)-28
b(vices)278 b(that)f(use)h(FUSD.)863 44265 y Fj(8.1)1329
b(Blocking)332 b(the)g(caller)g(by)g(blocking)f(the)h(dri)-13
b(v)g(er)863 47004 y Fn(The)326 b(easiest)e(\(b)-22 b(ut)324
b(least)g(useful\))g(w)-11 b(ay)326 b(to)e(block)i(a)f(client')-61
b(s)324 b(system)g(call)g(is)g(simply)g(to)h(block)g(the)g(dri)-28
b(v)-17 b(er)-44 b(,)337 b(too.)486 b(F)-17 b(or)325
b(e)-17 b(xample,)863 48333 y(consider)348 b(Program)g(10,)364
b(which)348 b(implements)f(a)g(de)-28 b(vice)349 b(called)e
Fo(/dev/console-read)p Fn(.)555 b(Whene)-28 b(v)-17 b(er)350
b(a)d(process)g(tries)e(to)863 49661 y(read)297 b(from)f(this)g(de)-28
b(vice,)303 b(the)296 b(dri)-28 b(v)-17 b(er)297 b(prints)f(a)g(prompt)
h(to)f(standard)i(input,)j(asking)c(for)f(a)h(reply)-72
b(.)401 b(\(The)297 b(prompt)g(appears)g(in)g(the)863
50989 y(shell)286 b(the)h(dri)-28 b(v)-17 b(er)287 b(w)-11
b(as)286 b(run)h(in,)h(not)f(the)g(shell)f(that')-61
b(s)285 b(trying)i(to)f(read)h(from)f(the)h(de)-28 b(vice.\))373
b(When)287 b(the)g(user)f(enters)h(a)f(line)h(of)f(te)-17
b(xt,)863 52318 y(the)318 b(response)h(is)e(returned)i(to)e(the)i
(client)f(that)g(did)g(the)g(original)g Fo(read\(\))p
Fn(.)466 b(By)318 b(blocking)i(the)e(dri)-28 b(v)-17
b(er)319 b(w)-11 b(aiting)318 b(for)g(the)g(reply)-72
b(,)863 53646 y(the)278 b(client)f(that)g(issued)g(the)h(system)e(call)
i(is)e(block)-11 b(ed)279 b(as)e(well.)2524 55639 y(Blocking)341
b(the)e(dri)-28 b(v)-17 b(er)340 b(this)e(w)-11 b(ay)340
b(is)e(safe\227unlik)-11 b(e)341 b(programming)g(in)e(the)g(k)-11
b(ernel)340 b(proper)-44 b(,)355 b(where)340 b(doing)g(something)h(lik)
-11 b(e)863 56967 y(this)372 b(w)-11 b(ould)374 b(block)f(the)g(entire)
g(system.)630 b(It')-61 b(s)371 b(also)h(easy)i(to)e(implement,)398
b(as)372 b(seen)h(from)f(the)h(e)-17 b(xample)375 b(abo)-17
b(v)g(e.)633 b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)399 b(it)863
58295 y(mak)-11 b(es)284 b(the)f(dri)-28 b(v)-17 b(er)284
b(unresponsi)-28 b(v)-17 b(e)286 b(to)c(system)h(call)g(requests)g
(that)g(might)g(be)h(coming)g(from)f(other)g(clients.)360
b(If)282 b(another)j(process)863 59624 y(tries)310 b(to)g(do)i(an)-17
b(ything)313 b(at)d(all)h(with)f(a)h(block)-11 b(ed)313
b(dri)-28 b(v)-17 b(er')-61 b(s)311 b(de)-28 b(vice\227e)g(v)-17
b(en)315 b(an)c Fo(open\(\))p Fn(\227it)g(will)f(block)i(until)f(the)g
(dri)-28 b(v)-17 b(er)311 b(w)-11 b(ak)g(es)863 60952
y(up)303 b(ag)-6 b(ain.)421 b(This)302 b(limitation)g(mak)-11
b(es)303 b(blocking)i(dri)-28 b(v)-17 b(ers)302 b(inappropriate)j(for)c
(an)-17 b(y)304 b(de)-28 b(vice)305 b(dri)-28 b(v)-17
b(er)303 b(that)f(e)-17 b(xpects)304 b(to)f(service)f(more)863
62280 y(than)278 b(one)g(client)g(at)f(a)g(time.)863
66113 y Fj(8.2)1329 b(Blocking)332 b(the)g(caller)g(using)f
Fc(-FUSD)p 22235 66113 399 45 v 478 w(NOREPLY)p Fj(;)i(unblocking)d(it)
j(using)e Fc(fusd)p 43439 66113 V 479 w(return\(\))863
68853 y Fn(If)314 b(a)i(de)-28 b(vice)317 b(dri)-28 b(v)-17
b(er)316 b(e)-17 b(xpects)318 b(more)d(than)h(one)h(client)f(at)f(a)g
(time\227as)g(is)g(often)g(the)h(case\227a)h(slightly)e(dif)-28
b(ferent)315 b(programming)863 70181 y(model)376 b(is)d(needed)k(for)d
(system)g(calls)g(that)g(can)i(potentially)f(block.)637
b(Instead)374 b(of)h(blocking,)400 b(the)375 b(dri)-28
b(v)-17 b(er)375 b(immediately)h(sends)25405 74071 y(24)p
eop
%%Page: 25 28
25 27 bop 863 2974 a Fn(a)349 b(message)i(to)e(the)g(FUSD)h(frame)-28
b(w)-11 b(ork)351 b(that)e(says,)367 b(in)349 b(essence,)368
b(\223Don')-20 b(t)350 b(unblock)h(the)f(client)f(that)h(issued)f(this)
f(system)h(call,)863 4302 y(b)-22 b(ut)337 b(continue)i(sending)f
(additional)g(system)f(call)f(requests)h(that)g(might)g(be)g(coming)i
(from)d(other)h(clients.)-77 b(\224)522 b(Dri)-28 b(v)-17
b(er)337 b(callbacks)863 5631 y(can)290 b(send)f(this)e(message)i(to)f
(FUSD)i(by)f(returning)g(the)f(special)h(v)-28 b(alue)290
b Fo(-FUSD)p 31984 5631 333 45 v 399 w(NOREPLY)g Fn(instead)e(of)h(a)f
(normal)h(system)f(call)863 6959 y(return)277 b(v)-28
b(alue.)2524 8951 y(Before)463 b(a)g(callback)h(blocks)g(the)f(caller)f
(by)i(returning)f Fo(-FUSD)p 28666 8951 V 399 w(NOREPLY)p
Fn(,)h(it)d(must)i(sa)-22 b(v)-17 b(e)463 b(the)g Fo(fusd)p
45008 8951 V 399 w(file)p 48063 8951 V 400 w(info)863
10280 y Fn(pointer)402 b(that)f(w)-11 b(as)401 b(pro)-17
b(vided)404 b(to)d(the)g(callback)i(as)e(its)f(\002rst)g(ar)-20
b(gument.)718 b(Later)-44 b(,)432 b(when)402 b(an)g(e)-28
b(v)-17 b(ent)403 b(occurs)f(which)g(allo)-28 b(ws)402
b(the)863 11608 y(client')-61 b(s)275 b(block)-11 b(ed)277
b(system)e(call)g(to)g(complete,)i(the)e(dri)-28 b(v)-17
b(er)276 b(should)g(call)f Fo(fusd)p 31396 11608 V 399
w(return\(\))p Fn(,)h(which)g(will)f(unblock)i(the)e(calling)863
12936 y(process)j(and)g(complete)h(its)c(system)i(call.)344
b Fo(fusd)p 20285 12936 V 399 w(return\(\))278 b Fn(tak)-11
b(es)277 b(tw)-11 b(o)277 b(ar)-20 b(guments:)2524 15815
y Fg(\017)554 b Fn(The)278 b Fo(fusd)p 8351 15815 V 399
w(file)p 11406 15815 V 399 w(info)f Fn(pointer)h(that)f(the)h(callback)
h(sa)-22 b(v)-17 b(ed)278 b(earlier;)f(and)2524 18029
y Fg(\017)554 b Fn(The)392 b(system)g(call')-61 b(s)391
b(return)h(v)-28 b(alue)393 b(\(in)f(other)g(w)-11 b(ords,)420
b(the)392 b(v)-28 b(alue)394 b(that)e(w)-11 b(ould)392
b(ha)-22 b(v)-17 b(e)394 b(been)g(returned)e(by)h(the)f(callback)3631
19357 y(function)331 b(had)f(it)f(not)i(returned)f Fo(-FUSD)p
19670 19357 V 400 w(NOREPLY)p Fn(\).)g(FUSD)h(itself)d
Fk(does)j(not)f Fn(e)-17 b(xamine)332 b(the)e(return)g(v)-28
b(alue)332 b(passed)e(as)3631 20685 y(the)384 b(second)i(ar)-20
b(gument)386 b(to)f Fo(fusd)p 17338 20685 V 399 w(return)p
Fn(;)438 b(it)384 b(simply)g(propag)-6 b(ates)387 b(that)e(v)-28
b(alue)386 b(back)g(to)e(the)h(k)-11 b(ernel)385 b(as)f(the)h(return)
3631 22014 y(v)-28 b(alue)278 b(of)f(the)h(block)-11
b(ed)279 b(system)e(call.)2524 24892 y(Dri)-28 b(v)-17
b(ers)335 b(should)g(ne)-28 b(v)-17 b(er)337 b(call)e
Fo(fusd)p 16824 24892 V 399 w(return)h Fn(more)f(than)h(once)g(on)g(a)e
(single)h Fo(fusd)p 36719 24892 V 400 w(file)p 39775
24892 V 399 w(info)g Fn(pointer)-61 b(.)517 b(Doing)336
b(so)863 26220 y(will)276 b(ha)-22 b(v)-17 b(e)279 b(unde\002ned)i
(results,)275 b(similar)h(to)h(calling)h Fo(free\(\))g
Fn(twice)f(on)h(the)f(same)h(pointer)-61 b(.)2524 28213
y(It)240 b(also)h(bears)h(repeating)h(that)f(a)g(callback)h(can)g(call)
e Fk(either)h Fn(call)f(fusd)p 29218 28213 V 399 w(return\(\))g(e)-17
b(xplicitly)242 b Fk(or)g Fn(return)f(a)h(normal)g(return)f(v)-28
b(alue)863 29541 y(\(i.e.,)276 b(not)h Fo(-FUSD)p 8215
29541 V 400 w(NOREPLY)p Fn(\),)g(b)-22 b(ut)277 b(not)h(both.)2524
31533 y Fo(-FUSD)p 5910 31533 V 399 w(NOREPLY)336 b Fn(and)h
Fo(fusd)p 15883 31533 V 399 w(return\(\))g Fn(mak)-11
b(e)337 b(it)e(easy)h(for)f(a)h(dri)-28 b(v)-17 b(er)336
b(to)g(block)h(a)f(process,)350 b(then)337 b(unblock)g(it)e(later)863
32862 y(when)235 b(data)f(becomes)h(a)-22 b(v)-28 b(ailable.)331
b(When)234 b(the)g(callback)h(returns)e Fo(-FUSD)p 29305
32862 V 399 w(NOREPLY)p Fn(,)h(the)g(dri)-28 b(v)-17
b(er)234 b(is)e(freed)i(up)g(to)f(w)-11 b(ait)233 b(for)f(other)863
34190 y(e)-28 b(v)-17 b(ents,)283 b(e)-28 b(v)-17 b(en)283
b(though)f(the)f(process)g(making)h(the)e(system)h(call)f(is)g(still)e
(block)-11 b(ed.)356 b(The)281 b(dri)-28 b(v)-17 b(er)281
b(can)h(then)f(w)-11 b(ait)280 b(for)g(something)i(to)863
35518 y(happen)299 b(that)e(unblocks)i(the)e(original)g(caller)-22
b(\227for)296 b(e)-17 b(xample,)304 b(another)298 b(FUSD)f(e)-28
b(v)-17 b(ent,)304 b(data)297 b(from)f(a)h(serial)f(port,)301
b(or)c(data)g(from)863 36847 y(the)314 b(netw)-11 b(ork.)453
b(\(Recall)314 b(from)f(Section)i(7)e(that)h(a)f(FUSD)i(dri)-28
b(v)-17 b(er)314 b(can)g(simultaneously)h(w)-11 b(ait)313
b(for)g(both)h(FUSD)g(and)h(non-FUSD)863 38175 y(e)-28
b(v)-17 b(ents.\))2524 40168 y(FUSD)435 b(includes)g(an)g(e)-17
b(xample)437 b(program,)474 b Fo(pager.c)p Fn(,)h(which)435
b(demonstrates)g(these)g(techniques.)817 b(The)436 b(pager)f(dri)-28
b(v)-17 b(er)863 41496 y(implements)301 b(a)f(simple)g(noti\002cation)i
(interf)-11 b(ace)301 b(which)g(lets)e(an)-17 b(y)301
b(number)h(of)d(\223w)-11 b(aiters\224)301 b(w)-11 b(ait)300
b(for)f(a)h(signal)g(from)g(a)g(\223noti\002er)-61 b(.)-77
b(\224)863 42824 y(All)257 b(the)h(w)-11 b(aiters)258
b(w)-11 b(ait)257 b(by)i(trying)f(to)f(read)i(from)e
Fo(/dev/pager/notify)p Fn(.)340 b(Those)259 b(reads)f(will)f(block)i
(until)e(a)h(noti\002er)h(writes)863 44153 y(the)377
b(string)f Fo(page)h Fn(to)g Fo(/dev/pager/input)p Fn(.)644
b(It')-61 b(s)375 b(easy)i(to)g(try)f(the)h(application)i(out\227run)e
(the)g(dri)-28 b(v)-17 b(er)-44 b(,)402 b(and)378 b(then)f(open)863
45481 y(three)313 b(other)f(shells.)448 b(In)312 b(tw)-11
b(o)312 b(of)g(them,)322 b(type)313 b Fo(cat)664 b(/dev/pager/notify)p
Fn(.)452 b(The)313 b(reads)f(will)g(block.)449 b(Then,)323
b(in)312 b(the)g(third)863 46809 y(shell,)277 b(type)h
Fo(echo)664 b(page)h(>)g(/dev/pager/input)p Fn(\227the)280
b(other)d(tw)-11 b(o)277 b(shells)g(should)h(become)h(unblock)-11
b(ed.)2524 48802 y(Let')-61 b(s)276 b(tak)-11 b(e)278
b(a)f(look)h(at)f(ho)-28 b(w)278 b(this)f(application)i(is)d
(implemented,)j(step)e(by)g(step.)863 52413 y Fl(8.2.1)1108
b(K)-28 b(eeping)279 b(P)-22 b(er)-41 b(-Client)278 b(State)863
55153 y Fn(The)351 b(\002rst)f(thing)h(to)f(notice)h(about)h
Fo(pager.c)f Fn(is)e(that)h(it)g(k)-11 b(eeps)351 b Fk(per)-22
b(-client)351 b(state)p Fn(.)562 b(That)351 b(is,)367
b(for)350 b(e)-28 b(v)-17 b(ery)352 b(\002le)f(descriptor)f(open)863
56482 y(to)295 b(the)g(dri)-28 b(v)-17 b(er)-44 b(,)299
b(a)c(structure)g(is)f(allocated)i(that)f(has)g(information)h(relating)
f(to)f(that)h(\002le)g(descriptor)-61 b(.)397 b(Pre)-28
b(vious)296 b(dri)-28 b(v)-17 b(er)296 b(e)-17 b(xamples)863
57810 y(were,)315 b(for)306 b(the)h(most)f(part,)314
b Fk(r)-41 b(eactive)p Fn(\227the)-17 b(y)310 b(recei)-28
b(v)-17 b(ed)309 b(requests,)314 b(and)308 b(immediately)h(generated)g
(responses.)433 b(Since)308 b(there)f(w)-11 b(as)863
59138 y(ne)-28 b(v)-17 b(er)335 b(more)f(than)g(one)g(request)g
(outstanding,)348 b(there)334 b(w)-11 b(as)333 b(no)h(need)h(to)e(k)-11
b(eep)334 b(a)f(list)f(of)h(them.)512 b(The)334 b(pager)g(application)h
(is)e(the)863 60467 y(\002rst)304 b(one)i(that)e(must)g(k)-11
b(eep)307 b(track)e(of)f(an)h(arbitrary)g(number)h(of)e(requests)h
(that)f(might)h(be)h(outstanding)g(at)e(the)h(same)g(time.)426
b(The)863 61795 y(\002rst)271 b(e)-17 b(xcerpt)274 b(of)e
Fo(pager.c)p Fn(,)h(which)g(appears)h(in)e(Program)h(11,)g(sho)-28
b(ws)272 b(the)h(code)g(which)g(creates)g(this)e(per)-22
b(-client)272 b(state.)342 b(Lines)863 63123 y(1\2266)240
b(de\002ne)h(a)e(structure,)246 b Fo(pager)p 14218 63123
V 400 w(client)p Fn(,)g(which)240 b(k)-11 b(eeps)240
b(all)f(the)g(information)h(we)f(need)h(about)g(each)h(client)e
(attached)i(to)e(the)863 64452 y(dri)-28 b(v)-17 b(er)-61
b(.)341 b(The)269 b Fo(open)f Fn(callback)i(for)d Fo(/dev/pager/notify)
p Fn(,)272 b(sho)-28 b(wn)269 b(on)f(lines)g(12\22631,)j(allocates)e
(memory)f(for)f(an)i(instance)863 65780 y(of)342 b(this)f(structure)g
(and)i(adds)g(it)e(to)g(a)h(link)-11 b(ed)343 b(list.)536
b(\(If)340 b(the)i(memory)h(allocation)h(f)-11 b(ails,)356
b(an)343 b(error)e(is)g(returned)h(to)g(the)g(client)g(on)863
67108 y(line)300 b(18;)311 b(this)298 b(will)h(pre)-28
b(v)-17 b(ent)301 b(the)f(\002le)g(from)f(opening.\))412
b(Note)300 b(on)g(line)g(25)g(that)f(we)h(use)g(the)g
Fo(private)p 41394 67108 V 399 w(data)g Fn(\002eld)g(to)g(store)f(a)863
68437 y(pointer)249 b(to)f(the)g(client)g(state;)257
b(this)247 b(allo)-28 b(ws)249 b(the)f(structure)g(to)g(be)g(retrie)-28
b(v)-17 b(ed)250 b(when)f(later)f(callbacks)h(on)g(this)e(\002le)h
(descriptor)g(arri)-28 b(v)-17 b(e.)863 69765 y(The)278
b(memory)g(is)e(deallocated)k(when)f(the)e(\002le)g(is)g(closed;)g(we')
-11 b(ll)277 b(see)g(that)g(in)g(a)g(later)g(section.)25405
74071 y(25)p eop
%%Page: 26 29
26 28 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(11)e Fn(pager)-61 b(.c)278 b(\(P)-17 b(art)277 b(1\):)343
b(Creating)278 b(state)f(for)f(e)-28 b(v)-17 b(ery)279
b(client)f(using)f(the)h(dri)-28 b(v)-17 b(er)p 863 3445
50191 45 v 365 4400 a Fi(1)1661 b Fo(/*)664 b(per-client)i(structure)g
(to)e(keep)h(track)g(of)g(who)g(has)f(an)h(open)g(FD)f(to)h(us)f(*/)
2524 5728 y(struct)h(pager_client)h({)3852 7057 y(int)f
(last_page_seen;)1995 b(/*)664 b(seq.)h(no.)g(of)f(last)h(page)g(this)g
(client)g(has)g(seen)g(*/)3852 8385 y(struct)g(fusd_file_info)i(*read;)
e(/*)g(outstanding)h(read)f(request,)g(if)g(any)f(*/)365
9714 y Fi(5)2989 b Fo(struct)665 b(fusd_file_info)i(*polldiff;)f(/*)e
(outstanding)i(polldiff)g(request)f(*/)3852 11042 y(struct)g
(pager_client)h(*next;)1994 b(/*)665 b(to)f(construct)i(the)f(linked)g
(list)g(*/)2524 12370 y(};)2524 15027 y(struct)g(pager_client)h
(*client_list)g(=)f(NULL;)g(/*)f(list)h(of)g(clients)g(\(open)g(FDs\))g
(*/)-133 16355 y Fi(10)1661 b Fo(int)664 b(last_page)i(=)e(0;)h(/*)f
(seq.)h(no.)g(of)g(the)f(most)h(recent)g(page)g(to)g(arrive)g(*/)2524
19012 y(/*)f(open)h(on)g(/dev/pager/notify:)i(create)e(state)g(for)g
(this)g(client)g(*/)2524 20340 y(static)g(int)g
(pager_notify_open\(struct)j(fusd_file_info)f(*file\))2524
21669 y({)-133 22997 y Fi(15)2989 b Fo(/*)664 b(create)i(state)f(for)f
(this)h(client)h(*/)3852 24325 y(struct)f(pager_client)h(*c)f(=)f
(malloc\(sizeof\(struct)k(pager_client\)\);)3852 26982
y(if)c(\(c)h(==)g(NULL\))5180 28310 y(return)h(-ENOBUFS;)-133
29639 y Fi(20)3852 30967 y Fo(/*)e(initialize)i(fields)g(of)e(this)h
(client)g(state)g(*/)3852 32296 y(memset\(c,)h(0,)e(sizeof\(struct)j
(pager_client\)\);)3852 33624 y(c->last_page_seen)g(=)d(last_page;)-133
36281 y Fi(25)2989 b Fo(/*)664 b(save)h(the)g(pointer)g(to)g(this)g
(state)g(so)f(it)h(gets)g(returned)g(to)g(us)g(later)g(*/)3852
37609 y(file->private_data)i(=)e(c;)3852 40266 y(/*)f(add)h(this)g
(client)g(to)g(the)g(client)g(list)g(*/)3852 41594 y(c->next)g(=)g
(client_list;)-133 42922 y Fi(30)2989 b Fo(client_list)666
b(=)e(c;)3852 45579 y(return)h(0;)2524 46907 y(})p 863
48402 V 2524 51723 a Fn(Another)253 b(thing)g(to)g(notice)h(about)f
(the)g(open)i(callback)f(is)e(the)h(use)g(of)f(the)h
Fo(last)p 33489 51723 333 45 v 399 w(page)p 36544 51723
V 399 w(seen)g Fn(v)-28 b(ariable.)337 b(The)253 b(dri)-28
b(v)-17 b(er)254 b(gi)-28 b(v)-17 b(es)863 53051 y(a)301
b(sequence)i(number)f(to)f(e)-28 b(v)-17 b(ery)302 b(page)g(it)e(recei)
-28 b(v)-17 b(es;)314 b Fo(last)p 23800 53051 V 399 w(page)p
26855 53051 V 399 w(seen)301 b Fn(stores)f(the)h(number)h(of)e(the)h
(most)g(recent)g(page)h(seen)863 54379 y(by)366 b(a)g(client.)608
b(When)367 b(a)e(ne)-28 b(w)367 b(client)f(arri)-28 b(v)-17
b(es)366 b(\(i.e.,)386 b(it)364 b(opens)j Fo(/dev/pager/notify)p
Fn(\),)390 b(its)364 b Fo(last)p 41511 54379 V 399 w(page)p
44566 54379 V 399 w(seen)i Fn(state)f(is)863 55708 y(set)311
b(equal)h(to)f(the)g(page)h(that)f(has)h(most)e(recently)i(arri)-28
b(v)-17 b(ed;)329 b(this)310 b(forces)h(a)g(ne)-28 b(w)312
b(client)g(to)e(w)-11 b(ait)311 b(for)f(the)i Fk(ne)-22
b(xt)311 b Fn(page,)321 b(rather)311 b(than)863 57036
y(immediately)279 b(being)f(noti\002ed)h(of)d(a)i(page)g(that)f(has)h
(arri)-28 b(v)-17 b(ed)278 b(in)f(the)g(past.)863 60648
y Fl(8.2.2)1108 b(Blocking)279 b(and)f(completing)h(r)-20
b(eads)863 63387 y Fn(The)418 b(ne)-17 b(xt)419 b(part)e(of)g
Fo(pager.c)h Fn(is)e(sho)-28 b(wn)418 b(in)f(Program)h(12.)764
b(The)418 b Fo(pager)p 31463 63387 V 400 w(notify)p 35847
63387 V 399 w(read)g Fn(function)g(seen)g(on)f(line)h(1)f(is)863
64716 y(re)-17 b(gistered)405 b(as)f(the)g Fo(read)h
Fn(callback)h(for)d(the)i Fo(/dev/pager/notify)i Fn(de)-28
b(vice.)726 b(It)403 b(blocks)i(the)g(read)f(request)h(using)g(the)863
66044 y(technique)278 b(we)e(described)h(earlier:)342
b(it)275 b(stores)f(the)i Fo(fusd)p 23100 66044 V 399
w(file)p 26155 66044 V 399 w(info)g Fn(pointer)g(in)g(that)f(client')
-61 b(s)275 b(state)g(structure,)h(and)g(returns)863
67372 y Fo(-FUSD)p 4249 67372 V 400 w(NOREPLY)p Fn(.)309
b(\(Note)h(that)f(the)h(pointer)g(to)f(the)g(client')-61
b(s)309 b(state)g(structure)g(comes)h(from)f(the)h Fo(private)p
44555 67372 V 400 w(data)f Fn(\002eld)h(of)863 68701
y Fo(fusd)p 3585 68701 V 399 w(file)p 6640 68701 V 400
w(info)p Fn(,)277 b(where)h(the)f(open)i(callback)g(stored)e(it.\))
25405 74071 y(26)p eop
%%Page: 27 30
27 29 bop 863 3167 50191 89 v 863 4151 a Fl(Pr)-20 b(ogram)280
b(12)e Fn(pager)-61 b(.c)278 b(\(P)-17 b(art)277 b(2\):)343
b(Block)278 b(clients')f Fo(read)g Fn(requests,)g(and)i(later)d
(completing)j(the)f(block)-11 b(ed)279 b(reads)p 863
4656 50191 45 v 365 5611 a Fi(1)1661 b Fo(ssize_t)665
b(pager_notify_read\(struct)j(fusd_file_info)f(*file,)e(char)g
(*buffer,)19792 6940 y(size_t)g(len,)g(loff_t)h(*offset\))2524
8268 y({)3852 9597 y(struct)f(pager_client)h(*c)f(=)f(\(struct)i
(pager_client)g(*\))f(file->private_data;)365 10925 y
Fi(5)3852 12253 y Fo(if)f(\(c)h(==)g(NULL)f(||)h(c->read)g(!=)g(NULL\))
g({)5180 13582 y(fprintf\(stderr,)i("pager_read's)g(arguments)e(are)g
(confusd,)h(alas"\);)5180 14910 y(return)g(-EINVAL;)3852
16238 y(})-133 17567 y Fi(10)3852 18895 y Fo(c->read)f(=)g(file;)3852
20223 y(pager_notify_complete_read\(c\);)3852 21552 y(return)g
(-FUSD_NOREPLY;)2524 22880 y(})-133 24208 y Fi(15)2524
25537 y Fo(void)f(pager_notify_complete_read\(struct)670
b(pager_client)d(*c\))2524 26865 y({)3852 28193 y(/*)d(if)h(there)g(is)
g(no)f(outstanding)i(read,)f(do)g(nothing)g(*/)3852 29522
y(if)f(\(c)h(==)g(NULL)f(||)h(c->read)g(==)g(NULL\))-133
30850 y Fi(20)4317 b Fo(return;)3852 33507 y(/*)664 b(if)h(there)g(are)
g(no)f(outstanding)i(pages,)g(do)e(nothing)i(*/)3852
34835 y(if)e(\(c->last_page_seen)k(>=)c(last_page\))5180
36164 y(return;)-133 37492 y Fi(25)3852 38820 y Fo(/*)g(bring)i(this)e
(client)i(up)e(to)h(date)g(with)f(the)h(most)g(recent)g(page)g(*/)3852
40149 y(c->last_page_seen)i(=)d(last_page;)3852 42805
y(/*)g(and)h(notify)g(the)g(client)g(by)g(unblocking)h(the)f(read)f
(\(read)h(returns)h(0\))e(*/)-133 44134 y Fi(30)2989
b Fo(fusd_return\(c->read,)668 b(0\);)3852 45462 y(c->read)d(=)g(NULL;)
2524 46790 y(})2524 49447 y(ssize_t)g(pager_input_write\(struct)j
(fusd_file_info)f(*file,)-133 50775 y Fi(35)18929 b Fo(const)665
b(char)g(*buffer,)h(size_t)f(len,)g(loff_t)g(*offset\))2524
52104 y({)3852 53432 y(struct)g(pager_client)h(*c;)3852
56089 y(/*)e(...)h(*/)-133 57417 y Fi(40)3852 58746 y
Fo(CASE\("page"\))h({)5180 60074 y(last_page++;)5180
62731 y(for)f(\(c)g(=)f(client_list;)i(c)f(!=)f(NULL;)h(c)f(=)h
(c->next\))g({)-133 64059 y Fi(45)5646 b Fo
(pager_notify_complete_polldiff\(c\);)6509 65387 y
(pager_notify_complete_read\(c\);)5180 66716 y(})3852
68044 y(})p 863 69538 V 25405 74071 a Fn(27)p eop
%%Page: 28 31
28 30 bop 2524 2974 a Fo(pager)p 5910 2974 333 45 v 399
w(notify)p 10293 2974 V 400 w(complete)p 16005 2974 V
399 w(read)274 b Fk(unbloc)-22 b(ks)274 b Fn(pre)-28
b(viously)274 b(block)-11 b(ed)275 b(reads.)342 b(This)273
b(function)h(\002rst)e(checks)i(to)f(see)g(that)863 4302
y(there)301 b(is,)306 b(in)300 b(f)-11 b(act,)306 b(a)301
b(block)-11 b(ed)303 b(read)e(\(line)g(19\).)414 b(It)300
b(then)h(checks)i(to)d(see)h(if)f(a)h(page)h(has)f(arri)-28
b(v)-17 b(ed)302 b(that)e(the)h(client)g(hasn')-20 b(t)301
b(seen)h(yet)863 5631 y(\(line)329 b(23\).)499 b(Finally)-72
b(,)342 b(it)328 b(updates)j(the)e(client)g(state)g(and)h(unblocks)h
(the)e(block)-11 b(ed)331 b(read)f(by)g(calling)f Fo(fusd)p
42126 5631 V 399 w(return)p Fn(.)500 b(Note)330 b(the)863
6959 y(second)258 b(ar)-20 b(gument)257 b(to)f Fo(fusd)p
12448 6959 V 399 w(return)h Fn(is)e(a)h(0;)263 b(as)255
b(we)h(sa)-17 b(w)257 b(in)e(Section)j(4.3,)i(a)c(0)g(return)g(v)-28
b(alue)257 b(to)f(a)g Fo(read)g Fn(system)g(call)g(means)863
8287 y(EOF)-89 b(.)278 b(\(The)g(system)f(call)g(will)f(be)i(unblock)
-11 b(ed)280 b(re)-17 b(g)-6 b(ardless)278 b(of)f(the)g(return)g(v)-28
b(alue.\))2524 10280 y Fo(pager)p 5910 10280 V 399 w(notify)p
10293 10280 V 400 w(complete)p 16005 10280 V 399 w(read)383
b Fn(is)f(called)h(e)-28 b(v)-17 b(ery)385 b(time)d(a)h(ne)-28
b(w)384 b(page)g(arri)-28 b(v)-17 b(es.)660 b(Ne)-28
b(w)383 b(pages)h(are)e(processed)i(by)863 11608 y Fo(pager)p
4249 11608 V 400 w(input)p 7969 11608 V 399 w(write)301
b Fn(\(line)f(34\),)306 b(which)301 b(is)f(the)g Fo(write)h
Fn(callback)i(for)c Fo(/dev/pager/input)p Fn(.)416 b(After)300
b(recording)i(the)863 12936 y(f)-11 b(act)294 b(that)g(a)h(ne)-28
b(w)295 b(page)h(has)e(arri)-28 b(v)-17 b(ed,)299 b(it)294
b(calls)g Fo(pager)p 22092 12936 V 399 w(notify)p 26475
12936 V 399 w(complete)p 32186 12936 V 400 w(read)h Fn(for)e(each)j
(client)f(that)f(has)g(an)h(open)h(\002le)863 14265 y(descriptor)-61
b(.)377 b(This)288 b(will)f(complete)i(the)g(reads)f(of)g(an)-17
b(y)289 b(clients)f(who)h(ha)-22 b(v)-17 b(e)290 b(not)e(yet)h(seen)g
(this)e(ne)-28 b(w)289 b(data,)i(and)e(ha)-22 b(v)-17
b(e)290 b(no)f(ef)-28 b(fect)288 b(on)863 15593 y(clients)277
b(that)g(don')-20 b(t)278 b(ha)-22 b(v)-17 b(e)279 b(outstanding)g
(reads.)2524 17586 y(There)433 b(is)f(another)i(interesting)f(point)h
(to)e(notice)i(about)g Fo(pager)p 28984 17586 V 399 w(notify)p
33367 17586 V 400 w(read)p Fn(.)811 b(On)433 b(line)f(12,)472
b(after)433 b(it)f(stores)g(the)863 18914 y(block)-11
b(ed)309 b(system)e(call')-61 b(s)306 b(pointer)-44 b(,)314
b(b)-22 b(ut)307 b(before)g(we)g(return)g Fo(-FUSD)p
27135 18914 V 400 w(NOREPLY)p Fn(,)g(it)f(calls)g(the)h(completion)i
(function.)433 b(This)307 b(has)863 20242 y(the)357 b(ef)-28
b(fect)358 b(of)e(returning)i(an)-17 b(y)358 b(data)g(that)f(might)g
(already)h(be)f(a)-22 b(v)-28 b(ailable)359 b(back)g(to)d(the)h(caller)
g(immediately)-72 b(.)584 b(If)356 b(that)h(happens,)863
21571 y(we)282 b(will)f(end)i(up)f(calling)h Fo(fusd)p
13724 21571 V 399 w(return)g Fk(befor)-41 b(e)282 b Fn(we)h(return)e
Fo(-FUSD)p 29275 21571 V 400 w(NOREPLY)p Fn(.)h(This)g(probably)h
(seems)f(strange,)i(b)-22 b(ut)281 b(it')-61 b(s)863
22899 y(le)-17 b(g)-6 b(al.)608 b(Recall)366 b(that)f(a)g(callback)i
(can)f(call)f(fusd)p 19839 22899 V 399 w(return\(\))f(e)-17
b(xplicitly)366 b Fk(or)f Fn(return)g(a)g(normal)g(\(not)g
Fo(-FUSD)p 42694 22899 V 400 w(NOREPLY)p Fn(\))g(return)863
24227 y(v)-28 b(alue,)279 b(b)-22 b(ut)277 b(not)g(both;)h(the)f(order)
h(doesn')-20 b(t)277 b(matter)-61 b(.)863 27839 y Fl(8.2.3)1108
b(Using)277 b Fo(fusd)p 9889 27839 V 399 w(destroy\(\))i
Fl(to)e(clean)h(up)g(client)f(state)863 30579 y Fn(Finally)-72
b(,)268 b(let')-61 b(s)264 b(tak)-11 b(e)266 b(a)f(look)h(at)f(one)i
(last)d(aspect)i(of)f(the)g(pager)i(program:)338 b(ho)-28
b(w)266 b(it)e(cleans)i(up)g(the)g(per)-22 b(-client)265
b(state)g(when)h(a)g(client)863 31907 y(lea)-22 b(v)-17
b(es.)331 b(This)234 b(is)g(mostly)h(straightforw)-11
b(ard,)243 b(with)235 b(one)h(e)-17 b(xception:)325 b(a)236
b(client)f(may)h(ha)-22 b(v)-17 b(e)237 b(an)e(outstanding)i(read)f
(request)f(out)h(when)863 33235 y(a)309 b(close)g(request)g(comes)g
(in.)437 b(Normally)-72 b(,)317 b(a)309 b(client)f(can')-20
b(t)309 b(mak)-11 b(e)310 b(another)g(system)e(call)h(request)g(while)f
(a)h(pre)-28 b(vious)310 b(system)e(call)863 34564 y(is)314
b(still)f(block)-11 b(ed.)459 b(Ho)-28 b(we)g(v)-17 b(er)-44
b(,)327 b(the)315 b Fo(close)h Fn(system)e(call)h(is)f(an)i(e)-17
b(xception:)422 b(it)314 b(gets)g(called)i(when)h(a)e(client)g(dies)g
(\(for)f(e)-17 b(xample,)863 35892 y(if)367 b(it)g(recei)-28
b(v)-17 b(es)369 b(an)g(interrupt)f(signal\).)615 b(If)367
b(a)h Fo(close)g Fn(comes)h(in)e(while)i(another)g(system)e(call)h(is)f
(still)f(outstanding,)392 b(the)368 b(state)863 37220
y(associated)263 b(with)e(the)h(outstanding)h(request)f(should)g(be)g
(freed)g(to)f(a)-22 b(v)g(oid)263 b(a)e(memory)i(leak.)339
b(The)262 b Fo(fusd)p 41121 37220 V 399 w(destroy)g Fn(function)h(is)
863 38549 y(used)278 b(to)f(do)h(this,)e(seen)h(on)h(linen)g(12-14)g
(of)f(Program)h(13.)863 42382 y Fj(8.3)1329 b(Retrie)-20
b(ving)332 b(a)h(block)-13 b(ed)330 b(system)h(call')-49
b(s)333 b(ar)-13 b(guments)330 b(fr)-24 b(om)332 b(a)g
Fc(fusd)p 37031 42382 399 45 v 479 w(file)p 40698 42382
V 478 w(info)g Fj(pointer)863 45121 y Fn(In)341 b(the)h(pre)-28
b(vious)343 b(section,)358 b(we)342 b(sho)-28 b(wed)343
b(ho)-28 b(w)342 b(the)g Fo(fusd)p 23678 45121 333 45
v 399 w(return)g Fn(function)h(can)f(be)h(used)f(to)f(specify)h(the)g
(return)f(v)-28 b(alue)343 b(of)863 46450 y(a)305 b(system)g(call)g
(that)g(w)-11 b(as)305 b(pre)-28 b(viously)306 b(block)-11
b(ed.)430 b(Ho)-28 b(we)g(v)-17 b(er)-44 b(,)314 b(man)-17
b(y)306 b(system)f(calls)g(ha)-22 b(v)-17 b(e)306 b(side)f(ef)-28
b(fects)305 b(in)g(addition)h(to)f(returning)863 47778
y(a)316 b(v)-28 b(alue\227for)316 b(e)-17 b(xample,)327
b(in)316 b(a)f Fo(read\(\))h Fn(request,)326 b(the)315
b(data)h(being)h(returned)g(has)e(to)g(be)h(copied)i(into)d(the)h
(caller')-61 b(s)315 b(b)-22 b(uf)-28 b(fer)-61 b(.)458
b(T)-89 b(o)863 49106 y(f)-11 b(acilitate)356 b(this,)376
b(FUSD)357 b(pro)-17 b(vides)358 b(accessor)f(functions)h(that)e(let)g
(dri)-28 b(v)-17 b(ers)357 b(retrie)-28 b(v)-17 b(e)358
b(the)f(ar)-20 b(guments)357 b(that)g(had)h(been)g(passed)f(to)863
50435 y(its)311 b(callbacks)i(at)f(the)g(time)g(the)g(call)g(w)-11
b(as)312 b(originally)g(issued.)448 b(F)-17 b(or)312
b(e)-17 b(xample,)323 b(the)312 b Fo(fusd)p 35959 50435
V 400 w(get)p 38351 50435 V 399 w(read)p 41406 50435
V 399 w(buffer\(\))h Fn(function)863 51763 y(will)349
b(return)h(a)g(pointer)h(to)f(the)g(data)h(b)-22 b(uf)-28
b(fer)350 b(that)h(is)e(pro)-17 b(vided)352 b(with)e
Fo(read\(\))g Fn(callbacks.)564 b(Dri)-28 b(v)-17 b(ers)350
b(can)h(use)g(these)f(accessor)863 53091 y(functions)278
b(to)f(af)-28 b(fect)277 b(change)j(to)d(a)g(client)h
Fk(befor)-41 b(e)278 b Fn(calling)f Fo(fusd)p 26296 53091
V 400 w(return\(\))p Fn(.)2524 55084 y(The)h(follo)-28
b(wing)278 b(accessor)g(functions)f(are)h(a)-22 b(v)-28
b(ailable,)278 b(all)f(of)g(which)h(tak)-11 b(e)278 b(a)f(single)g
Fo(fusd)p 37712 55084 V 400 w(file)p 40768 55084 V 399
w(info)665 b(*)277 b Fn(ar)-20 b(gument:)2524 57962 y
Fg(\017)554 b Fo(int)664 b(char)h(*fusd)p 12994 57962
V 400 w(get)p 15386 57962 V 399 w(read)p 18441 57962
V 399 w(buffer)p Fn(\227The)358 b(destination)g(b)-22
b(uf)-28 b(fer)357 b(for)f(data)h(that)g(a)f(dri)-28
b(v)-17 b(er)358 b(is)d(returning)i(to)g(a)3631 59290
y(process)277 b(doing)h(a)g Fo(read\(\))p Fn(.)2524 61504
y Fg(\017)554 b Fo(const)665 b(char)f(*fusd)p 14322 61504
V 400 w(get)p 16714 61504 V 399 w(write)p 20433 61504
V 399 w(buffer)p Fn(\227The)324 b(source)f(b)-22 b(uf)-28
b(fer)323 b(containing)h(data)f(sent)f(to)g(the)g(dri)-28
b(v)-17 b(er)323 b(by)g(a)3631 62833 y(process)277 b(doing)h(a)g
Fo(write\(\))p Fn(.)2524 65047 y Fg(\017)554 b Fo(fusd)p
6353 65047 V 399 w(get)p 8744 65047 V 399 w(length)p
Fn(\227The)279 b(length)f(\(in)f(bytes\))g(of)f(the)i(b)-22
b(uf)-28 b(fer)277 b(for)g(either)g(a)g Fo(read\(\))h
Fn(or)f(a)g Fo(write\(\))p Fn(.)2524 67261 y Fg(\017)554
b Fo(loff)p 6353 67261 V 399 w(t)664 b(fusd)p 10736 67261
V 399 w(get)p 13127 67261 V 399 w(offset)p Fn(\227The)255
b(\002le)e(descriptor')-61 b(s)252 b(byte)h(of)-28 b(fset,)257
b(typically)d(used)f(in)f Fo(read\(\))h Fn(and)h Fo(write\(\))3631
68589 y Fn(callbacks.)25405 74071 y(28)p eop
%%Page: 29 32
29 31 bop 863 1955 50191 89 v 863 2940 a Fl(Pr)-20 b(ogram)280
b(13)e Fn(pager)-61 b(.c)278 b(\(P)-17 b(art)277 b(3\):)343
b(Cleaning)279 b(up)f(when)g(a)f(client)h(lea)-22 b(v)-17
b(es)p 863 3445 50191 45 v 365 4400 a Fi(1)1661 b Fo(/*)664
b(close)h(on)g(/dev/pager/notify:)i(destroy)e(state)h(for)e(this)h
(client)g(*/)2524 5728 y(static)g(int)g(pager_notify_close\(struct)j
(fusd_file_info)f(*file\))2524 7057 y({)3852 8385 y(struct)e
(pager_client)h(*c;)365 9714 y Fi(5)3852 11042 y Fo(if)e(\(\(c)h(=)g
(\(struct)g(pager_client)h(*\))f(file->private_data\))i(!=)e(NULL\))g
({)5180 13699 y(/*)g(take)g(this)g(client)g(off)g(our)f(client)h(list)g
(*/)5180 15027 y(client_list_remove\(c\);)-133 16355
y Fi(10)5180 17684 y Fo(/*)g(if)f(there)h(is)g(a)f(read)h(outstanding,)
h(free)f(the)g(state)g(*/)5180 19012 y(if)g(\(c->read)g(!=)g(NULL\))g
({)6509 20340 y(fusd_destroy\(c->read\);)6509 21669 y(c->read)g(=)f
(NULL;)-133 22997 y Fi(15)4317 b Fo(})5180 24325 y(/*)665
b(destroy)g(any)g(outstanding)h(polldiffs)g(*/)5180 25654
y(if)f(\(c->polldiff)h(!=)f(NULL\))g({)6509 26982 y
(fusd_destroy\(c->polldiff\);)6509 28310 y(c->polldiff)h(=)e(NULL;)-133
29639 y Fi(20)4317 b Fo(})5180 32296 y(/*)665 b(get)g(rid)f(of)h(the)f
(struct)i(*/)5180 33624 y(free\(c\);)5180 34952 y(file->private_data)i
(=)c(NULL;)-133 36281 y Fi(25)2989 b Fo(})3852 37609
y(return)665 b(0;)2524 38937 y(})p 863 40432 V 2524 43753
a Fg(\017)554 b Fo(int)664 b(fusd)p 9009 43753 333 45
v 399 w(get)p 11400 43753 V 400 w(ioctl)p 15120 43753
V 399 w(request)p Fn(\227An)267 b(ioctl')-61 b(s)265
b(request)h(\223command)j(number\224)f(\(i.e.,)e(the)h(\002rst)d(ar)-20
b(gument)268 b(of)d(an)3631 45081 y(ioctl\).)2524 47295
y Fg(\017)554 b Fo(int)664 b(fusd)p 9009 47295 V 399
w(get)p 11400 47295 V 400 w(ioctl)p 15120 47295 V 399
w(arg)p Fn(\227The)425 b(second)g(ar)-20 b(gument)425
b(of)f(an)g(ioctl)f(for)g(non-data-bearing)k Fo(ioctl)d
Fn(requests)3631 48623 y(\(i.e.,)p 5972 48623 V 674 w
Fo(IO)277 b Fn(commands\).)2524 50837 y Fg(\017)554 b
Fo(void)664 b(*fusd)p 10337 50837 V 400 w(get)p 12729
50837 V 399 w(ioctl)p 16448 50837 V 399 w(buffer)p Fn(\227The)438
b(data)f(b)-22 b(uf)-28 b(fer)436 b(for)f(data-bearing)j
Fo(ioctl)f Fn(requests)f(\()p 45349 50837 V 398 w Fo(IOR)p
Fn(,)p 48452 50837 V 834 w Fo(IOW)p Fn(,)3631 52165 y(and)p
5572 52165 V 676 w Fo(IORW)278 b Fn(commands\).)2524
54379 y Fg(\017)554 b Fo(int)664 b(fusd)p 9009 54379
V 399 w(get)p 11400 54379 V 400 w(poll)p 14456 54379
V 399 w(diff)p 17511 54379 V 399 w(cached)p 21894 54379
V 399 w(state)p Fn(\227See)279 b(Section)g(9.)2524 57257
y(W)-89 b(e)411 b(got)h(a)-17 b(w)-11 b(ay)412 b(without)g(using)f
(these)h(accessor)f(functions)h(in)f(our)g Fo(pager.c)h
Fn(e)-17 b(xample)414 b(because)f(the)e(pager)h(doesn')-20
b(t)863 58586 y(actually)340 b(return)e(data\227it)h(just)e(blocks)i
(and)h(unblocks)g Fo(read)f Fn(calls.)526 b(Ho)-28 b(we)g(v)-17
b(er)-44 b(,)356 b(the)339 b(FUSD)g(distrib)-22 b(ution)338
b(contains)i(another)863 59914 y(e)-17 b(xample)280 b(program,)d
Fo(logring)p Fn(,)h(that)f(demonstrates)h(their)f(use.)2524
61907 y Fo(logring)441 b Fn(mak)-11 b(es)442 b(it)e(easy)i(to)e(access)
i(the)f(most)g(recent)g(\(and)h(only)g(the)f(most)f(recent\))i(output)g
(from)e(a)h(process.)835 b(It)863 63235 y(w)-11 b(orks)433
b(just)f(lik)-11 b(e)433 b Fo(tail)665 b(-f)433 b Fn(on)h(a)f(log)g
(\002le,)472 b(e)-17 b(xcept)435 b(that)e(the)h(storage)f(required)h
(ne)-28 b(v)-17 b(er)435 b(gro)-28 b(ws.)812 b(This)432
b(can)i(be)g(useful)f(in)863 64563 y(embedded)345 b(systems)c(where)i
(there)f(isn')-20 b(t)340 b(enough)k(memory)f(or)e(disk)h(space)h(for)e
(k)-11 b(eeping)344 b(complete)f(log)f(\002les,)357 b(b)-22
b(ut)342 b(the)g(most)863 65892 y(recent)278 b(deb)-22
b(ugging)280 b(messages)e(are)f(sometimes)h(needed)h(\(e.g.,)e(after)f
(an)i(error)f(is)f(observ)-17 b(ed\).)2524 67884 y Fo(logring)257
b Fn(uses)e(FUSD)j(to)d(implement)j(a)e(character)h(de)-28
b(vice,)263 b Fo(/dev/logring)p Fn(,)e(that)c(acts)f(lik)-11
b(e)256 b(a)g(named)i(pipe)f(that)f(has)863 69213 y(a)298
b(\002nite,)304 b(circular)298 b(b)-22 b(uf)-28 b(fer)-61
b(.)407 b(The)299 b(size)f(of)g(the)h(b)-22 b(uf)-28
b(fer)298 b(is)f(gi)-28 b(v)-17 b(en)300 b(as)e(a)g(command-line)j(ar)
-20 b(gument.)408 b(As)298 b(more)g(data)h(is)e(written)h(into)25405
74071 y(29)p eop
%%Page: 30 33
30 32 bop 863 2974 a Fn(the)356 b(b)-22 b(uf)-28 b(fer)-44
b(,)374 b(the)355 b(oldest)g(data)h(is)e(discarded.)579
b(A)355 b(process)g(that)g(reads)h(from)e(the)i(logring)g(de)-28
b(vice)357 b(will)d(\002rst)g(read)i(the)f(e)-17 b(xisting)863
4302 y(b)-22 b(uf)-28 b(fer)-44 b(,)277 b(then)h(block)g(and)g(see)g
(ne)-28 b(w)278 b(data)g(as)f(it')-61 b(s)275 b(written,)i(similar)e
(to)i(monitoring)h(a)g(log)f(\002le)g(using)h Fo(tail)665
b(-f)p Fn(.)2524 6295 y(Y)-122 b(ou)380 b(can)g(run)f(this)f(e)-17
b(xample)381 b(program)f(by)g(typing)g Fo(logring)665
b(<logsize>)p Fn(,)406 b(where)380 b Fo(logsize)g Fn(is)e(the)h(size)g
(of)g(the)863 7623 y(circular)337 b(b)-22 b(uf)-28 b(fer)337
b(in)f(bytes.)523 b(Then,)353 b(type)337 b Fo(cat)665
b(/dev/logring)338 b Fn(in)f(a)g(shell.)521 b(The)338
b Fo(cat)f Fn(process)g(will)f(block,)352 b(w)-11 b(aiting)338
b(for)863 8951 y(data.)403 b(From)297 b(another)h(shell,)j(write)296
b(to)h(the)g(logring)g(\(e.g.,)k Fo(echo)665 b(Hi)f(there)h(>)g
(/dev/logring)p Fn(\).)403 b(The)298 b Fo(cat)f Fn(process)863
10280 y(will)276 b(see)i(the)f(message)h(appear)-61 b(.)2524
12272 y(\(This)343 b(e)-17 b(xample)347 b(program)f(is)d(based)j(on)f
Fk(emlo)-11 b(g)p Fn(,)362 b(a)344 b(\(real\))g(Linux)h(k)-11
b(ernel)346 b(module)f(with)g(identical)g(functionality)-72
b(.)547 b(If)343 b(you)863 13601 y(\002nd)278 b(logring)g(useful,)f(b)
-22 b(ut)277 b(w)-11 b(ant)278 b(to)f(use)g(it)f(on)i(a)f(system)g
(that)g(does)h(not)f(ha)-22 b(v)-17 b(e)279 b(FUSD,)f(check)h(out)f
(the)f(original)h(emlog)47280 13199 y Ff(12)48111 13601
y Fn(.\))863 18001 y Fm(9)1594 b(Implementing)399 b Fa(select)p
Fm(able)i(De)-24 b(vices)863 21139 y Fn(One)376 b(important)g(feature)f
(that)g(almost)g(e)-28 b(v)-17 b(ery)377 b(de)-28 b(vice)377
b(dri)-28 b(v)-17 b(er)376 b(in)f(a)g(system)g(should)h(ha)-22
b(v)-17 b(e)376 b(is)e(support)i(for)e(the)i Fo(select\(2\))863
22467 y Fn(system)423 b(call.)780 b Fo(select)424 b Fn(allo)-28
b(ws)423 b(clients)g(to)g(assemble)g(a)g(set)g(of)f(\002le)h
(descriptors)g(and)h(ask)f(to)g(be)h(noti\002ed)g(when)g(one)g(of)863
23796 y(them)287 b(becomes)i(readable)f(or)e(writable.)372
b(This)287 b(simple)f(feature)h(is)f(decepti)-28 b(v)-17
b(ely)290 b(po)-28 b(werful\227it)287 b(allo)-28 b(ws)286
b(clients)h(to)f(w)-11 b(ait)287 b(for)e(an)-17 b(y)863
25124 y(number)336 b(of)e(a)h(set)f(of)g(possible)g(e)-28
b(v)-17 b(ents)336 b(to)f(occur)-61 b(.)516 b(This)335
b(is)e(fundamentally)k(dif)-28 b(ferent)334 b(than)i(\(for)d(e)-17
b(xample\))336 b(a)f(blocking)h(read,)863 26452 y(which)246
b(only)g(unblocks)h(on)f(one)g(kind)g(of)e(e)-28 b(v)-17
b(ent.)335 b(In)245 b(this)f(section,)252 b(we')-11 b(ll)244
b(describe)i(ho)-28 b(w)246 b(FUSD)g(can)g(be)g(used)g(to)f(create)h(a)
f(de)-28 b(vice)863 27781 y(whose)278 b(state)f(can)h(be)g(queried)g
(by)g(a)f(client')-61 b(s)277 b(call)g(to)g Fo(select\(2\))p
Fn(.)2524 29773 y(This)367 b(section)g(is)g(limited)f(to)h(a)h
(discussion)f(what)h(a)f(FUSD)h(dri)-28 b(v)-17 b(er)368
b(writer)f(needs)h(to)f(kno)-28 b(w)369 b(to)e(implement)h(a)g
(selectable)863 31102 y(de)-28 b(vice.)346 b(Details)276
b(of)h(the)g(FUSD)i(implementation)g(required)f(to)f(support)g(this)g
(feature)g(are)h(described)g(in)f(Section)i(11.1)863
34935 y Fj(9.1)1329 b(P)-27 b(oll)333 b(state)f(and)g(the)f
Fc(poll)p 17203 34935 399 45 v 479 w(diff)h Fj(callback)863
37674 y Fn(FUSD')-61 b(s)329 b(implementation)i(of)d(selectable)i(de)
-28 b(vices)330 b(depends)h(on)e(the)g(concept)i(of)e
Fk(poll)f(state)p Fn(.)498 b(A)328 b(\002le)h(descriptor')-61
b(s)329 b(poll)f(state)863 39003 y(is)436 b(a)i(bitmask)g(that)f
(describes)h(its)e(current)i(properties\227readable,)480
b(writable,)d(or)437 b(e)-17 b(xception)440 b(raised.)824
b(These)439 b(three)f(states)863 40331 y(correspond)279
b(to)e Fo(select\(2\))p Fn(')-61 b(s)278 b(three)f Fo(fd)p
18072 40331 333 45 v 399 w(set)p Fn(s.)343 b(FUSD)278
b(has)f(constants)h(used)g(to)f(describe)h(these)g(states:)2524
43209 y Fg(\017)554 b Fo(FUSD)p 6353 43209 V 399 w(NOTIFY)p
10736 43209 V 399 w(INPUT)p Fn(\227Input)279 b(is)d(a)-22
b(v)-28 b(ailable;)278 b(a)g(read)f(will)g(not)g(block.)2524
45423 y Fg(\017)554 b Fo(FUSD)p 6353 45423 V 399 w(NOTIFY)p
10736 45423 V 399 w(OUTPUT)p Fn(\227Output)279 b(space)f(is)f(a)-22
b(v)-28 b(ailable;)278 b(a)f(write)g(will)f(not)i(block.)2524
47637 y Fg(\017)554 b Fo(FUSD)p 6353 47637 V 399 w(NOTIFY)p
10736 47637 V 399 w(EXCEPT)p Fn(\227An)279 b(e)-17 b(xception)280
b(has)d(occurred.)2524 50515 y(These)c(constants)f(can)h(be)g(combined)
h(with)e(C')-61 b(s)271 b(bitwise-or)g(operator)-61 b(.)343
b(F)-17 b(or)272 b(e)-17 b(xample,)275 b(a)d(descriptor)h(that)e(is)g
(both)i(readable)863 51843 y(and)370 b(writable)e(is)g(e)-17
b(xpressed)370 b(as)e Fo(FUSD)p 16660 51843 V 400 w(NOTIFY)p
21044 51843 V 399 w(INPUT)665 b(|)g(FUSD)p 29413 51843
V 399 w(NOTIFY)p 33796 51843 V 399 w(OUTPUT)p Fn(.)369
b(0)g(means)h(a)e(\002le)h(descriptor)g(is)863 53172
y(not)278 b(readable,)g(not)g(writable,)f(and)h(not)f(in)g(the)h(e)-17
b(xception)280 b(set.)2524 55164 y(F)-17 b(or)263 b(a)g(FUSD)g(de)-28
b(vice)265 b(to)e(be)g(selectable,)k(its)261 b(dri)-28
b(v)-17 b(er)263 b(must)g(implement)h(a)e(callback)j(called)f
Fo(poll)p 40529 55164 V 399 w(diff)p Fn(.)339 b(This)262
b(callback)j(is)863 56493 y(v)-17 b(ery)239 b(dif)-28
b(ferent)237 b(than)i(the)f(others;)250 b(it)237 b(is)f(not)i(a)f
(\223direct)h(line\224)h(between)g(the)f(client)g(and)g(the)g(dri)-28
b(v)-17 b(er)238 b(as)f(is)g(the)h(case)g(with)f(a)h(call)f(such)863
57821 y(as)323 b Fo(ioctl)p Fn(.)480 b(A)323 b(dri)-28
b(v)-17 b(er')-61 b(s)323 b(response)g(to)g Fo(poll)p
19068 57821 V 399 w(diff)g Fn(is)f Fk(not)h Fn(the)g(return)g(v)-28
b(alue)324 b(seen)f(by)h(a)e(client')-61 b(s)323 b(call)g(to)f
Fo(select)p Fn(.)481 b(When)863 59149 y(a)388 b(client)g(tries)f(to)g
Fo(select)i Fn(on)f(a)g(set)f(of)h(\002le)g(descriptors,)415
b(the)388 b(k)-11 b(ernel)389 b(collects)f(the)g(responses)g(from)g
(all)f(the)h(appropriate)863 60478 y(callbacks\227)p
Fo(poll)364 b Fn(for)c(\002le)h(descriptors)g(managed)j(by)e(k)-11
b(ernel)362 b(dri)-28 b(v)-17 b(ers,)382 b(and)363 b
Fo(poll)p 35062 60478 V 399 w(diff)e Fn(callbacks)i(those)e(managed)j
(by)863 61806 y(FUSD)278 b(dri)-28 b(v)-17 b(ers\227and)279
b(synthesizes)f(all)f(of)f(that)i(information)f(into)h(the)f(return)g
(v)-28 b(alue)279 b(seen)f(by)f(the)h(client.)2524 63799
y(FUSD)360 b(k)-11 b(eeps)361 b(a)f(cache)i(of)e(the)g(poll)g(state)g
(it)f(has)h(most)f(recently)i(recei)-28 b(v)-17 b(ed)363
b(from)c(each)j(FUSD)f(de)-28 b(vice)362 b(dri)-28 b(v)-17
b(er)-44 b(,)380 b(initially)863 65127 y(assumed)241
b(to)f(be)h(0.)331 b(This)239 b(state)h(is)f(returned)i(to)f(clients)g
(trying)g(to)g Fo(select\(\))h Fn(on)f(de)-28 b(vices)242
b(managed)h(by)d(those)h(dri)-28 b(v)-17 b(ers.)331 b(Under)863
66455 y(certain)322 b(conditions,)333 b(FUSD)322 b(sends)f(a)g(query)h
(to)f(the)g(dri)-28 b(v)-17 b(er)322 b(in)f(order)g(to)g(ensure)h(that)
f(the)g(k)-11 b(ernel')-61 b(s)321 b(poll)g(state)g(cache)i(is)d(up)h
(to)863 67784 y(date.)451 b(This)313 b(query)h(tak)-11
b(es)313 b(the)g(form)f(of)h(a)g Fo(poll)p 20014 67784
V 399 w(diff)g Fn(callback)i(acti)-28 b(v)g(ation,)323
b(which)314 b(is)e(gi)-28 b(v)-17 b(en)315 b(a)e(single)f(ar)-20
b(gument:)417 b(the)313 b(poll)p 863 68732 20076 45 v
1738 69472 a Fe(12)2457 69785 y Fd(http://www)-58 b(.circlemud.or)-16
b(g/jelson/softw)-9 b(are/emlog)25405 74071 y Fn(30)p
eop
%%Page: 31 34
31 33 bop 863 2974 a Fn(state)245 b(that)f(FUSD)i(currently)g(has)f
(cached.)335 b(The)245 b(dri)-28 b(v)-17 b(er)246 b(should)g(consult)f
(its)e(internal)j(data)f(structures)f(to)h(determine)h(the)f(actual,)
863 4302 y(current)278 b(poll)f(state)g(\(i.e.,)e(whether)k(or)e(not)g
(b)-22 b(uf)-28 b(fers)277 b(ha)-22 b(v)-17 b(e)279 b(readable)g
(data\).)343 b(Then:)2524 7180 y Fg(\017)554 b Fn(If)273
b(the)i(FUSD)h(cache)g(is)e(incorrect)h(\(that)f(is,)g(the)h(current)g
(true)g(poll)f(state)h(is)e(dif)-28 b(ferent)275 b(than)g(FUSD')-61
b(s)275 b(cached)i(state\),)e(the)3631 8509 y(current)i(poll)g(state)g
(should)h(be)g(returned)g(immediately)-72 b(.)2524 10723
y Fg(\017)554 b Fn(If)398 b(the)i(FUSD)h(cache)h(is)d(up)h(to)g(date)h
(\(that)e(is,)429 b(it)399 b(matches)i(the)f(real)g(current)h(state\),)
429 b(the)400 b(callback)i(should)f(sa)-22 b(v)-17 b(e)401
b(the)3631 12051 y Fo(fusd)p 6353 12051 333 45 v 399
w(file)p 9408 12051 V 399 w(info)248 b Fn(pointer)h(and)g(return)f
Fo(-FUSD)p 24152 12051 V 400 w(NOREPLY)p Fn(.)g(Later)-44
b(,)254 b(when)c(the)e(poll)g(state)g(changes,)256 b(the)248
b(dri)-28 b(v)-17 b(er)249 b(can)3631 13379 y(call)277
b Fo(fusd)p 8228 13379 V 399 w(return\(\))h Fn(to)f(update)i(FUSD')-61
b(s)277 b(cache.)2524 16257 y(In)442 b(other)i(w)-11
b(ords,)484 b(when)445 b(a)e(dri)-28 b(v)-17 b(er')-61
b(s)443 b Fo(poll)p 20338 16257 V 400 w(diff)g Fn(callback)i(is)d(acti)
-28 b(v)g(ated,)487 b(the)443 b(k)-11 b(ernel)444 b(is)e(ef)-28
b(fecti)g(v)-17 b(ely)446 b(saying)e(to)f(the)863 17586
y(dri)-28 b(v)-17 b(er)-44 b(,)304 b(\223Here)298 b(is)f(what)i(I)e
(think)h(the)h(current)f(poll)g(state)f(of)h(this)f(\002le)h
(descriptor)h(is;)307 b(let)297 b(me)h(kno)-28 b(w)300
b(when)f(that)f(state)g Fk(c)-17 b(hang)-11 b(es)p Fn(.)-77
b(\224)863 18914 y(The)373 b(dri)-28 b(v)-17 b(er)373
b(can)g(either)f(respond)h(immediately)g(\(if)e(the)h(k)-11
b(ernel')-61 b(s)372 b(cache)i(is)d(already)i(kno)-28
b(wn)374 b(to)e(be)h(out)f(of)f(date\),)396 b(or)372
b(return)863 20242 y Fo(-FUSD)p 4249 20242 V 400 w(NOREPLY)278
b Fn(if)f(no)i(update)g(is)e(immediately)i(necessary)-72
b(.)347 b(Later)-44 b(,)278 b(when)h(the)f(poll)g(state)g(changes)i
(\(for)d(e)-17 b(xample,)280 b(if)d(ne)-28 b(w)863 21571
y(data)285 b(arri)-28 b(v)-17 b(es)284 b(that)f(mak)-11
b(es)285 b(a)f(de)-28 b(vice)285 b(readable\),)i(the)d(dri)-28
b(v)-17 b(er)284 b(can)h(used)f(its)f(sa)-22 b(v)-17
b(ed)285 b Fo(fusd)p 35352 21571 V 399 w(file)p 38407
21571 V 399 w(info)f Fn(pointer)g(to)g(send)g(a)g(poll)863
22899 y(state)277 b(update)i(to)e(the)g(k)-11 b(ernel.)2524
24892 y(When)336 b(a)g(FUSD)h(dri)-28 b(v)-17 b(er)336
b(sends)g(a)g(poll)f(state)h(update,)352 b(it)334 b(might)i(\(or)f
(might)h(not\))g(ha)-22 b(v)-17 b(e)337 b(the)f(ef)-28
b(fect)336 b(of)g(w)-11 b(aking)337 b(up)f(a)g(client)863
26220 y(that)322 b(w)-11 b(as)323 b(block)-11 b(ed)324
b(in)e Fo(select\(2\))p Fn(.)480 b(On)322 b(the)h(same)g(note,)334
b(it')-61 b(s)320 b(w)-11 b(orth)323 b(reiterating)f(that)g(a)h
Fo(-FUSD)p 40693 26220 V 399 w(NOREPLY)g Fn(response)g(to)863
27548 y(a)282 b Fo(poll)p 4358 27548 V 399 w(diff)g Fn(callback)h
Fk(does)f(not)g Fn(necessarily)g(block)h(the)e(client\227other)i
(descriptors)e(in)g(the)h(client')-61 b(s)281 b Fo(select)h
Fn(set)f(might)863 28877 y(be)d(readable,)h(for)d(e)-17
b(xample.)863 32710 y Fj(9.2)1329 b(Recei)-13 b(ving)332
b(a)g Fc(poll)p 13969 32710 399 45 v 478 w(diff)g Fj(r)-24
b(equest)331 b(when)g(the)h(pr)-24 b(e)k(vious)331 b(one)h(has)f(not)h
(been)f(r)-24 b(etur)k(ned)330 b(y)-13 b(et)863 35449
y Fn(Calls)307 b(such)i(as)e Fo(read)h Fn(and)h Fo(write)g
Fn(are)f(synchronous)i(from)d(the)h(standpoint)h(of)f(an)g(indi)-28
b(vidual)309 b(client\227a)g(request)f(is)f(made,)863
36778 y(and)343 b(the)g(requester)g(blocks)g(until)f(a)g(reply)h(is)e
(recei)-28 b(v)-17 b(ed.)541 b(This)342 b(means)h(that)f(there)h(can')
-20 b(t)343 b(e)-28 b(v)-17 b(er)343 b(be)g(more)g(than)g(a)f(single)h
Fo(read)863 38106 y Fn(request)268 b(outstanding)h(for)d(a)h(single)h
(client)f(at)g(a)g(time.)340 b(\(The)268 b(dri)-28 b(v)-17
b(er)268 b(as)e(a)i(whole)g(may)g(be)g(k)-11 b(eeping)269
b(track)e(of)g(man)-17 b(y)269 b(outstanding)863 39434
y Fo(read)278 b Fn(requests)f(in)g(parallel,)g(b)-22
b(ut)277 b(no)h(tw)-11 b(o)277 b(of)g(them)g(will)g(be)g(from)g(the)g
(same)h(client)f(\002le)h(descriptor)-61 b(.\))2524 41427
y(As)288 b(we)h(mentioned)i(in)e(the)g(pre)-28 b(vious)290
b(section,)j(the)c Fo(poll)p 25515 41427 333 45 v 399
w(diff)g Fn(callback)i(is)d(dif)-28 b(ferent)289 b(from)f(other)i
(callbacks.)380 b(It)288 b(is)g(not)863 42755 y(part)324
b(of)g(a)h(synchronous)h(request/reply)f(sequence)i(that)d(causes)h
(the)g(client)f(to)h(block.)485 b(It)324 b(is)f(also)h(an)h(interf)-11
b(ace)325 b(to)f(the)g Fk(k)-11 b(ernel)p Fn(,)863 44084
y(not)254 b(directly)f(to)h(the)f(client.)336 b(So,)258
b(it)252 b Fk(is)h Fn(possible)g(to)g(recei)-28 b(v)-17
b(e)256 b(a)d Fo(poll)p 27386 44084 V 399 w(diff)h Fn(request)g(while)f
(there)h(is)e(already)j(one)f(outstanding.)863 45412
y(This)273 b(happens)i(if)d(the)h(k)-11 b(ernel')-61
b(s)273 b(poll)g(state)g(cache)i(changes,)h(causing)e(it)e(to)h(notify)
g(the)g(dri)-28 b(v)-17 b(er)274 b(that)f(it)f(has)h(a)g(ne)-28
b(w)274 b(cached)i(v)-28 b(alue.)2524 47404 y(This)276
b(is)h(easy)g(to)g(handle;)i(the)e(client)h(should)g(simply)2247
50283 y(1.)554 b(Destro)-11 b(y)440 b(the)g(old)h(\(no)-28
b(w)441 b(out-of-date\))f Fo(poll)p 22346 50283 V 399
w(diff)h Fn(request)g(using)f(the)h Fo(fusd)p 36766 50283
V 399 w(destroy)g Fn(function)g(we)g(sa)-17 b(w)440 b(in)3631
51611 y(Section)278 b(8.2.3.)2247 53825 y(2.)554 b(Either)277
b(respond)h(to)f(or)g(sa)-22 b(v)-17 b(e)278 b(the)f(ne)-28
b(w)279 b Fo(poll)p 21381 53825 V 399 w(diff)e Fn(request,)h(e)-17
b(xactly)279 b(as)d(described)j(in)e(the)g(pre)-28 b(vious)279
b(section.)2524 56703 y(The)f(ne)-17 b(xt)278 b(section)g(will)e(sho)
-28 b(w)278 b(an)f(e)-17 b(xample)280 b(of)d(this)f(technique.)863
60536 y Fj(9.3)1329 b(Adding)331 b Fc(select)h Fj(support)f(to)i
Fc(pager.c)863 63275 y Fn(Gi)-28 b(v)-17 b(en)223 b(the)f(e)-17
b(xplanation)225 b(of)c Fo(poll)p 14554 63275 V 399 w(diff)h
Fn(in)g(the)g(pre)-28 b(vious)222 b(sections,)233 b(it)221
b(might)g(seem)h(that)g(implementing)h(a)f(selectable)h(de)-28
b(vice)863 64604 y(is)239 b(a)g(daunting)j(task.)330
b(It')-61 b(s)238 b(actually)j(not)f(as)f(bad)i(as)e(it)g
(sounds\227the)i(e)-17 b(xample)242 b(code)f(may)f(well)f(be)i(shorter)
e(than)h(its)e(e)-17 b(xplanation!)2524 66596 y(Program)359
b(14)g(sho)-28 b(ws)359 b(the)f(implementation)j(of)d
Fo(poll)p 24277 66596 V 399 w(diff)h Fn(in)f Fo(pager.c)p
Fn(,)379 b(which)360 b(mak)-11 b(es)359 b(its)e(noti\002cation)j
(interf)-11 b(ace)863 67925 y(\()p Fo(/dev/pager/notify)p
Fn(\))320 b(selectable.)468 b(It)317 b(is)h(decomposed)j(into)d(a)h
(\223top)g(half)61 b(\224)318 b(and)i(\223bottom)f(half)61
b(\224)319 b(function,)329 b(e)-17 b(xactly)320 b(as)863
69253 y(we)352 b(did)f(for)g(the)h(blocking)h Fo(read)f
Fn(implementation)h(in)e(Program)h(12.)567 b(First,)368
b(on)352 b(lines)f(1\22620,)371 b(we)352 b(see)f(the)h(the)f(callback)j
(for)863 70581 y Fo(poll)p 3585 70581 V 399 w(diff)313
b Fn(callback)h(itself.)447 b(It)311 b(is)g(virtually)h(identical)h(to)
f(the)g Fo(read)h Fn(callback)h(in)e(Program)h(12.)449
b(The)313 b(main)f(dif)-28 b(ference)314 b(is)25405 74071
y(31)p eop
%%Page: 32 35
32 34 bop 863 4495 50191 89 v 863 5479 a Fl(Pr)-20 b(ogram)280
b(14)e Fn(pager)-61 b(.c)278 b(\(P)-17 b(art)277 b(4\):)343
b(Supporting)279 b Fo(select\(2\))g Fn(by)e(implementing)i(a)e
Fo(poll)p 36925 5479 333 45 v 400 w(diff)g Fn(callback)p
863 5985 50191 45 v 365 6940 a Fi(1)1661 b Fo(ssize_t)665
b(pager_notify_polldiff\(struct)k(fusd_file_info)e(*file,)22449
8268 y(unsigned)e(int)g(cached_state\))2524 9597 y({)3852
10925 y(struct)g(pager_client)h(*c)f(=)f(\(struct)i(pager_client)g(*\))
f(file->private_data;)365 12253 y Fi(5)3852 13582 y Fo(if)f(\(c)h(==)g
(NULL\))5180 14910 y(return)h(-EINVAL;)3852 17567 y(/*)e(if)h(we're)g
(already)g(holding)h(a)e(polldiff)i(request)f(that)g(we)g(haven't)-133
18895 y Fi(10)3653 b Fo(*)664 b(replied)i(to)e(yet,)h(destroy)h(the)e
(old)h(one)g(and)g(hold)f(onto)h(only)g(the)g(new)4516
20223 y(*)f(one)h(*/)3852 21552 y(if)f(\(c->polldiff)j(!=)d(NULL\))h({)
5180 22880 y(fusd_destroy\(c->polldiff\);)5180 24208
y(c->polldiff)h(=)f(NULL;)-133 25537 y Fi(15)2989 b Fo(})3852
28193 y(c->polldiff)666 b(=)e(file;)3852 29522 y
(pager_notify_complete_polldiff\(c\);)3852 30850 y(return)h
(-FUSD_NOREPLY;)-133 32178 y Fi(20)1661 b Fo(})2524 34835
y(void)664 b(pager_notify_complete_polldiff\(struct)671
b(pager_client)666 b(*c\))2524 36164 y({)3852 37492 y(int)f
(curr_state,)h(cached_state;)-133 38820 y Fi(25)3852
40149 y Fo(/*)e(if)h(there)g(is)g(no)f(outstanding)i(polldiff,)g(do)f
(nothing)g(*/)3852 41477 y(if)f(\(c)h(==)g(NULL)f(||)h(c->polldiff)h
(==)f(NULL\))5180 42805 y(return;)-133 45462 y Fi(30)2989
b Fo(/*)664 b(figure)i(out)e(the)h("current")h(state:)f(i.e.)g(whether)
g(or)g(not)g(the)f(pager)4516 46790 y(*)g(is)h(readable)h(for)e(this)h
(client)g(based)g(on)g(the)g(last)g(page)f(it)h(saw)g(*/)3852
48119 y(if)f(\(c->last_page_seen)k(<)c(last_page\))5180
49447 y(curr_state)i(=)f(FUSD_NOTIFY_INPUT;)i(/*)d(readable)i(*/)3852
50775 y(else)-133 52104 y Fi(35)4317 b Fo(curr_state)666
b(=)f(0;)f(/*)h(not)f(readable)i(or)e(writable)i(*/)3852
54760 y(/*)e(cached_state)j(is)d(what)h(the)g(kernel)g(*thinks*)h(the)e
(state)h(is)g(*/)3852 56089 y(cached_state)h(=)f
(fusd_get_poll_diff_cached_state\(c->polldiff\);)-133
58746 y Fi(40)2989 b Fo(/*)664 b(if)h(the)g(state)g(is)f(not)h(what)g
(the)g(kernel)g(thinks)g(it)g(is,)f(notify)i(the)5844
60074 y(kernel)g(of)e(the)h(change)g(*/)3852 61402 y(if)f(\(curr_state)
j(!=)d(cached_state\))j({)5180 62731 y(fusd_return\(c->polldiff,)i
(curr_state\);)5180 64059 y(c->polldiff)d(=)f(NULL;)-133
65387 y Fi(45)2989 b Fo(})2524 66716 y(})p 863 68210
V 25405 74071 a Fn(32)p eop
%%Page: 33 36
33 35 bop 863 2974 a Fn(that)317 b(it)e(\002rst)h(checks)i(\(on)f(line)
g(12\))f(to)h(see)g(if)e(a)i Fo(poll)p 22128 2974 333
45 v 399 w(diff)g Fn(request)g(is)e(already)j(outstanding)h(when)f(a)e
(ne)-28 b(w)318 b(request)f(comes)863 4302 y(in.)343
b(If)276 b(so,)h(the)g(out-of-date)h(request)g(is)e(destro)-11
b(yed)278 b(using)g Fo(fusd)p 26176 4302 V 399 w(destroy)p
Fn(,)g(as)e(we)i(described)h(in)d(Section)j(9.2.)2524
6295 y(The)322 b(bottom)g(half)g(is)e(sho)-28 b(wn)323
b(on)f(lines)g(22-46.)478 b(First,)331 b(on)322 b(lines)f(32\22635,)335
b(it)320 b(computes)j(the)f(current)g(poll)g(state\227if)f(a)g(page)863
7623 y(has)349 b(arri)-28 b(v)-17 b(ed)351 b(that)e(the)h(client)f
(hasn')-20 b(t)349 b(seen)h(yet,)367 b(the)350 b(\002le)f(is)f
(readable;)387 b(otherwise,)367 b(it)349 b(isn')-20 b(t.)558
b(Ne)-17 b(xt,)368 b(the)349 b(dri)-28 b(v)-17 b(er)350
b(compares)h(the)863 8951 y(current)262 b(poll)f(state)h(with)f(the)g
(poll)h(state)f(that)g(the)h(k)-11 b(ernel)262 b(has)g(cached.)340
b(If)261 b(the)g(k)-11 b(ernel')-61 b(s)262 b(cache)h(is)e(out)g(of)h
(date,)j(the)c(current)h(state)863 10280 y(is)276 b(returned)i(to)f
(the)h(k)-11 b(ernel.)344 b(Otherwise,)277 b(it)f(does)i(nothing.)2524
12272 y(As)242 b(with)g(the)h Fo(read)f Fn(callback)j(we)e(sa)-17
b(w)242 b(pre)-28 b(viously)-72 b(,)251 b(notice)244
b(that)e Fo(pager)p 31445 12272 V 399 w(notify)p 35828
12272 V 400 w(complete)p 41540 12272 V 400 w(polldiff)h
Fn(is)f(called)863 13601 y(in)277 b(tw)-11 b(o)277 b(dif)-28
b(ferent)277 b(cases:)2247 16338 y(1.)554 b(It)418 b(is)h(called)i
(immediately)g(from)e(the)i Fo(pager)p 22631 16338 V
399 w(notify)p 27014 16338 V 400 w(polldiff)f Fn(callback)i(itself.)770
b(This)420 b(causes)g(the)g(current)3631 17666 y(poll)309
b(state)f(to)h(be)h(returned)g(to)f(the)g(k)-11 b(ernel)310
b(immediately)h(when)f(the)g(request)f(arri)-28 b(v)-17
b(es)310 b(if)e(the)h(dri)-28 b(v)-17 b(er)310 b(already)g(kno)-28
b(ws)311 b(the)3631 18995 y(k)-11 b(ernel')-61 b(s)277
b(state)g(needs)h(to)f(be)g(updated.)2247 21138 y(2.)554
b(It)256 b(is)g(called)i(when)g(ne)-28 b(w)259 b(data)e(arri)-28
b(v)-17 b(es)258 b(that)f(causes)h(the)f(poll)h(state)e(to)h(change.)
339 b(Refer)258 b(back)g(to)f(Program)h(12)g(on)g(page)h(27;)3631
22467 y(in)253 b(the)h(callback)h(that)f(recei)-28 b(v)-17
b(es)255 b(ne)-28 b(w)254 b(pages,)259 b(notice)c(on)f(line)f(45)h
(that)g(the)g Fo(poll)p 34999 22467 V 399 w(diff)g Fn(completion)h
(function)f(is)f(called)3631 23795 y(alongside)278 b(the)g
Fo(read)f Fn(completion)i(function.)2524 26533 y(W)-44
b(ith)282 b(this)g Fo(poll)p 9580 26533 V 399 w(diff)h
Fn(implementation,)k(it)282 b(is)g(possible)h(for)f(a)h(client)g(to)g
(open)i Fo(/dev/pager/notify)p Fn(,)i(and)d(block)863
27861 y(in)262 b(a)h Fo(select\(2\))g Fn(system)f(call.)339
b(If)261 b(another)i(client)g(writes)e Fo(page)i Fn(to)f
Fo(/dev/pager/input)p Fn(,)267 b(the)c(\002rst)e(client')-61
b(s)262 b Fo(select)863 29189 y Fn(will)276 b(unblock,)j(indicating)g
(the)e(\002le)h(has)f(become)i(readable.)2524 31182 y(F)-17
b(or)258 b(additional)g(e)-17 b(xample)260 b(code,)j(tak)-11
b(e)258 b(a)f(look)i(at)e(the)h Fo(logring)g Fn(e)-17
b(xample)260 b(program)e(we)g(\002rst)e(mentioned)k(in)d(Section)i
(8.3.)863 32510 y(It)276 b(also)h(supports)g Fo(select)h
Fn(by)g(implementing)h(a)e(similar)f Fo(poll)p 26819
32510 V 399 w(diff)i Fn(callback.)863 36879 y Fm(10)1594
b(P)-32 b(erf)-40 b(ormance)398 b(of)g(User)-59 b(-Space)398
b(De)-24 b(vices)863 40017 y Fn(This)278 b(section)h(hasn')-20
b(t)279 b(been)h(written)e(yet.)348 b(I)277 b(ha)-22
b(v)-17 b(e)281 b(some)d(pretty)h(graphs)g(and)h(whatnot,)f(b)-22
b(ut)279 b(no)g(time)f(to)h(write)f(about)h(them)g(here)863
41345 y(before)f(the)f(release.)863 45714 y Fm(11)1594
b(FUSD)399 b(Implementation)f(Notes)863 48852 y Fn(In)349
b(this)f(section,)367 b(we)349 b(describe)g(some)h(of)e(the)h(details)g
(of)f(ho)-28 b(w)350 b(FUSD)g(is)e(implemented.)560 b(It')-61
b(s)347 b(not)i(necessary)h(to)f(understand)863 50180
y(these)253 b(details)g(in)g(order)g(to)g(use)g(FUSD.)g(Ho)-28
b(we)g(v)-17 b(er)-44 b(,)260 b(these)253 b(notes)g(can)h(be)g(useful)f
(for)f(people)i(who)g(are)f(trying)g(to)g(understand)i(the)863
51509 y(FUSD)278 b(frame)-28 b(w)-11 b(ork)278 b(itself\227hack)-11
b(ers,)277 b(deb)-22 b(uggers,)279 b(or)e(the)g(generally)i(curious.)
863 55310 y Fj(11.1)1329 b(The)332 b(situation)g(with)g
Fc(poll)p 18449 55310 399 45 v 479 w(diff)863 58050 y
Fn(In-k)-11 b(ernel)368 b(de)-28 b(vice)370 b(dri)-28
b(v)-17 b(ers)369 b(support)f(select)g(by)g(implementing)i(a)e
(callback)i(called)e Fo(poll)p Fn(.)616 b(This)368 b(dri)-28
b(v)-17 b(er')-61 b(s)368 b(callback)h(is)e(sup-)863
59378 y(posed)435 b(to)f(do)h(tw)-11 b(o)434 b(things.)814
b(First,)471 b(it)433 b(should)i(return)f(the)h(current)f(state)g(of)g
(a)g(\002le)g(descriptor)-22 b(\227a)435 b(combination)h(of)e(being)863
60706 y(readable,)351 b(writable,)e(or)334 b(ha)-22 b(ving)336
b(e)-17 b(xceptions.)519 b(Second,)351 b(it)334 b(should)h(pro)-17
b(vide)337 b(a)e(pointer)g(to)f(one)i(of)e(the)h(dri)-28
b(v)-17 b(er')-61 b(s)335 b(internal)g(w)-11 b(ait)863
62035 y(queues)264 b(that)e(will)g(be)g(a)-17 b(w)-11
b(ak)g(ened)266 b(whene)-28 b(v)-17 b(er)266 b(the)c(state)g(changes.)
341 b(The)263 b Fo(poll)f Fn(call)h(itself)d(should)k(ne)-28
b(v)-17 b(er)264 b(block\227it)f(should)g(just)863 63363
y(instantaneously)279 b(report)e(what)h(the)g Fk(curr)-41
b(ent)277 b Fn(state)g(is.)2524 65356 y(FUSD')-61 b(s)368
b(implementation)h(of)f(selectable)h(de)-28 b(vices)369
b(is)e(dif)-28 b(ferent,)390 b(b)-22 b(ut)368 b(attempts)g(to)f
(maintain)i(three)f(properties)g(that)g(we)863 66684
y(thought)279 b(to)e(be)g(most)g(important)h(from)e(the)i(point)f(of)g
(vie)-28 b(w)278 b(of)f(a)g(client)h(using)f Fo(select)p
Fn(.)344 b(Speci\002cally:)2247 69421 y(1.)554 b(The)267
b Fo(select\(2\))h Fn(call)e(itself)f(should)i(ne)-28
b(v)-17 b(er)269 b(become)g(block)-11 b(ed.)341 b(F)-17
b(or)267 b(e)-17 b(xample,)271 b(if)266 b(one)h(\002le)g(descriptor)g
(in)f(its)f(set)h(isn')-20 b(t)3631 70750 y(readable,)278
b(that)f(shouldn')-20 b(t)278 b(pre)-28 b(v)-17 b(ent)280
b(it)c(from)g(reporting)i(other)g(\002le)f(descriptors)g(that)g(are.)
25405 74071 y(33)p eop
%%Page: 34 37
34 36 bop 2247 2974 a Fn(2.)554 b(If)319 b Fo(select\(2\))i
Fn(indicates)g(a)g(\002le)f(descriptor)h(is)e(readable)j(\(or)e
(writable\),)330 b(a)321 b(read)g(\(or)e(write\))h(on)h(that)f(\002le)h
(descriptor)3631 4302 y(shouldn')-20 b(t)277 b(block.)2247
6516 y(3.)554 b(Clients)331 b(should)i(be)g(allo)-28
b(wed)334 b(to)e(seamlessly)g Fo(select)h Fn(on)g(an)-17
b(y)333 b(set)f(of)g(\002le)g(descriptors,)346 b(e)-28
b(v)-17 b(en)335 b(if)c(that)h(set)g(contains)h(a)3631
7844 y(mix)277 b(of)g(both)g(FUSD)i(and)f(non-FUSD)h(de)-28
b(vices.)2524 10723 y(The)349 b(FUSD)h(k)-11 b(ernel)350
b(module)g(k)-11 b(eeps)350 b(a)f(cache)i(of)d(the)h(dri)-28
b(v)-17 b(er')-61 b(s)349 b(most)f(recent)i(answer)f(for)g(each)h
(\002le)f(descriptor)-44 b(,)366 b(initially)863 12051
y(assumed)278 b(to)f(be)h(0.)343 b(When)278 b(the)g(k)-11
b(ernel)278 b(module')-61 b(s)278 b(internal)f Fo(poll)h
Fn(callback)h(is)d(acti)-28 b(v)g(ated,)279 b(it:)2247
14929 y(1.)554 b(Dispatches)330 b(a)f Fk(non-)p Fn(blocking)j
Fo(poll)p 18591 14929 333 45 v 399 w(diff)e Fn(to)f(the)h(associated)g
(user)-22 b(-space)330 b(dri)-28 b(v)-17 b(er)-44 b(,)343
b(asking)330 b(for)e(a)i(cache)h(update\227if)3631 16257
y(and)278 b(only)g(if)e(there)h(isn')-20 b(t)276 b(already)j(an)e
(outstanding)i(poll)e(dif)-28 b(f)277 b(request)g(out)h(that)f(has)g
(the)h(same)f(v)-28 b(alue.)2247 18471 y(2.)554 b(Immediately)278
b(returns)f(the)g(cached)j(v)-28 b(alue)278 b(to)f(the)h(k)-11
b(ernel)2524 21349 y(In)285 b(addition,)k(the)d(cached)i(v)-28
b(alue')-61 b(s)286 b(readable)i(bit)d(is)g(cleared)i(on)f(e)-28
b(v)-17 b(ery)287 b(read;)k(the)286 b(writable)f(bit)g(is)g(cleared)i
(on)f(e)-28 b(v)-17 b(ery)288 b(write.)863 22678 y(This)248
b(is)f(necessary)j(to)e(pre)-28 b(v)-17 b(ent)250 b(old)e(poll)g
(state\227which)i(says)d(\223de)-28 b(vice)251 b(is)c
(readable\224\227from)k(being)e(returned)g(out)g(of)e(the)i(cache)863
24006 y(when)410 b(it)e(might)h(be)h(in)-44 b(v)-28 b(alid.)739
b(FUSD)410 b(assumes)f(that)g(an)-17 b(y)410 b(read)g(to)f(a)g(de)-28
b(vice)411 b(can)f(mak)-11 b(e)410 b(it)e(potentially)i(unreadable.)741
b(This)863 25334 y(mechanism)279 b(is)d(what)i(causes)g(an)f(updated)j
(poll)d(dif)-28 b(f)276 b(to)h(be)h(sent)f(to)g(a)g(client)g(before)h
(the)g(pre)-28 b(vious)278 b(one)g(has)g(been)g(returned.)2524
27327 y(\(this)d(section)j(isn')-20 b(t)276 b(\002nished)j(yet;)e(f)-11
b(anc)-17 b(y)278 b(time)f(diagrams)h(coming)h(someday\))863
31160 y Fj(11.2)1329 b(Restartable)332 b(System)f(Calls)863
33900 y Fn(No)278 b(time)e(to)h(write)g(this)f(section)i(yet...)863
38300 y Fm(A)1594 b(Using)399 b Fa(strace)863 41438 y
Fn(This)277 b(section)h(hasn')-20 b(t)277 b(been)i(written)d(yet.)344
b(Contrib)-22 b(utions)278 b(are)f(welcome.)25405 74071
y(34)p eop
%%Trailer
end
userdict /end-hook known{end-hook}if
%%EOF
